<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
    <style>
        :root {
            --body-bg: #f4f6f8;
            --chat-bg: #ffffff;
            --user-msg-bg: #e0f0ff;
            --ai-msg-bg: #f1f3f4;
            --input-bg: #ffffff;
            --text-color: #202124;
            --border-color: #e0e0e0;
            --header-bg: #ffffff;
            --button-bg: #1a73e8;
            --button-hover-bg: #185abc;
            --record-btn-color: #5f6368;
            --record-btn-recording-color: #d93025;
            --modal-overlay-bg: rgba(0, 0, 0, 0.5);
            --suggestion-bg: #e8f0fe;
            --suggestion-text: #1967d2;
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--body-bg);
            color: var(--text-color);
        }

        .hidden { display: none !important; }

        /* Auth Container Styles */
        #auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .auth-form {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
        }
        .auth-form h2 { text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500;}
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
        }
        .auth-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--button-bg);
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        .auth-btn:hover { background-color: var(--button-hover-bg); }
        .google-btn { background-color: #4285F4; margin-top: 15px; }
        .google-btn:hover { background-color: #357ae8; }
        #auth-error { color: #d93025; text-align: center; margin-top: 10px; min-height: 1.2em; }
        .toggle-form {
            text-align: center;
            margin-top: 20px;
            cursor: pointer;
            color: var(--button-bg);
        }

        /* App Container Styles */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .header {
            background-color: var(--header-bg);
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        #user-info { font-size: 0.8rem; text-align: right; }
        .header-actions { display: flex; align-items: center; gap: 5px; }
        #logout-btn { background: none; border: 1px solid #d93025; color: #d93025; padding: 5px 10px; border-radius: 8px; cursor: pointer; margin-left: 10px; }

        #chat-container { flex-grow: 1; overflow-y: auto; padding: 20px 10px; display: flex; flex-direction: column; gap: 15px; }
        .message { display: flex; align-items: flex-start; gap: 10px; max-width: 90%; line-height: 1.6; }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background-color: var(--border-color); display: flex; justify-content: center; align-items: center; flex-shrink: 0; font-size: 14px; }
        .message-content { background-color: var(--chat-bg); padding: 10px 15px; border-radius: 18px; }
        .message.user .message-content { background-color: var(--user-msg-bg); }
        .message.ai .message-content { background-color: var(--ai-msg-bg); }
        .message-content > *:first-child { margin-top: 0; } .message-content > *:last-child { margin-bottom: 0; }
        .message-content pre { background-color: #202124; color: #e8eaed; padding: 12px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; }
        
        .typing-indicator { align-self: flex-start; margin-left: 42px; }
        .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: #999; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        #suggestions-container {
            padding: 0 10px 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex-shrink: 0;
        }
        .suggestion-chip {
            background-color: var(--suggestion-bg);
            color: var(--suggestion-text);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .suggestion-chip:hover {
            background-color: #d2e3fc;
        }

        #input-area { display: flex; align-items: center; padding: 10px; background-color: var(--input-bg); border-top: 1px solid var(--border-color); flex-shrink: 0; gap: 10px; }
        #prompt-input { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 18px; padding: 10px 15px; font-size: 16px; resize: none; max-height: 150px; overflow-y: auto; }
        .icon-btn { background-color: transparent; color: var(--record-btn-color); border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; flex-shrink: 0; }
        #record-btn.recording { color: white; background-color: var(--record-btn-recording-color); }
        #send-btn { background-color: var(--button-bg); color: white; }
        #send-btn:disabled { background-color: #a0c3e6; cursor: not-allowed; }

        /* Modal for Saved Chats */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        #close-modal-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        #saved-chats-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        #saved-chats-list li { padding: 12px 5px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .delete-chat-btn { color: #d93025; background: none; border: none; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>
    <!-- Authentication UI -->
    <div id="auth-container">
        <!-- Auth HTML remains the same -->
        <div class="auth-form">
            <div id="login-view">
                <h2>ƒêƒÉng nh·∫≠p</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">M·∫≠t kh·∫©u</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="auth-btn">ƒêƒÉng nh·∫≠p</button>
                </form>
                <button id="google-login-btn" class="auth-btn google-btn">ƒêƒÉng nh·∫≠p v·ªõi Google</button>
                <p class="toggle-form" id="show-register">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</p>
            </div>
            <div id="register-view" class="hidden">
                <h2>ƒêƒÉng k√Ω</h2>
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">M·∫≠t kh·∫©u</label>
                        <input type="password" id="register-password" required>
                    </div>
                    <button type="submit" class="auth-btn">ƒêƒÉng k√Ω</button>
                </form>
                <p class="toggle-form" id="show-login">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</p>
            </div>
            <p id="auth-error"></p>
        </div>
    </div>

    <!-- Main App UI (hidden by default) -->
    <div id="app-container" class="hidden">
        <header class="header">
            <div id="user-info"></div>
            <div class="header-actions">
                <button id="save-chat-btn" class="icon-btn" title="L∆∞u cu·ªôc tr√≤ chuy·ªán">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                </button>
                <button id="view-chats-btn" class="icon-btn" title="Xem cu·ªôc tr√≤ chuy·ªán ƒë√£ l∆∞u">
                    <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><g><rect fill="none" height="24" width="24"/></g><g><path d="M3,5v14h18V5H3z M7,7v2H5V7H7z M5,13v-2h2v2H5z M5,15h2v2H5V15z M19,17H9v-2h10V17z M19,13H9v-2h10V13z M19,9H9V7h10V9z"/></g></svg>
                </button>
                <button id="new-chat-btn">Tr√≤ chuy·ªán m·ªõi</button>
                <button id="logout-btn">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>
        <div id="chat-container"></div>
        <div id="suggestions-container"></div>
        <div id="saved-chats-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Cu·ªôc tr√≤ chuy·ªán ƒë√£ l∆∞u</h2>
                    <button id="close-modal-btn">&times;</button>
                </div>
                <ul id="saved-chats-list"></ul>
            </div>
        </div>
        <div id="input-area">
            <textarea id="prompt-input" rows="1" placeholder="Nh·∫≠p c√¢u h·ªèi..."></textarea>
            <button id="record-btn" class="icon-btn" title="Ghi √¢m">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
            </button>
            <button id="send-btn" class="icon-btn" title="G·ª≠i">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg>
            </button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";
        import { 
            getFirestore,
            collection,
            doc,
            addDoc,
            setDoc,
            getDocs,
            deleteDoc,
            serverTimestamp,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
             apiKey: "AIzaSyBDUBufnsk1PQZTLYCJDqASMX8hEVHqkDc",
             authDomain: "aimind-2362a.firebaseapp.com",
             projectId: "aimind-2362a",
             storageBucket: "aimind-2362a.firebasestorage.app",
             messagingSenderId: "377635504319",
             appId: "1:377635504319:web:7c6dd3cf0c52dd302d860a"
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ai = getAI(app);
        const model = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });

        // --- GLOBAL STATE ---
        let currentUserId = null;
        let currentChatId = null;
        let chat;
        let isRecording = false;

        // --- DOM ELEMENTS ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');
        const userInfo = document.getElementById('user-info');
        const logoutBtn = document.getElementById('logout-btn');
        const chatContainer = document.getElementById('chat-container');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const promptInput = document.getElementById('prompt-input');
        const sendBtn = document.getElementById('send-btn');
        const recordBtn = document.getElementById('record-btn');
        const saveChatBtn = document.getElementById('save-chat-btn');
        const viewChatsBtn = document.getElementById('view-chats-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const savedChatsModal = document.getElementById('saved-chats-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const savedChatsList = document.getElementById('saved-chats-list');

        // --- AUTH STATE OBSERVER ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                userInfo.textContent = `Ch√†o, ${user.email}`;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                startNewChat(); 
            } else {
                currentUserId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        // --- AUTHENTICATION LOGIC ---
        loginForm.addEventListener('submit', async e => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value); authError.textContent = ''; } catch (error) { authError.textContent = "Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng."; } });
        registerForm.addEventListener('submit', async e => { e.preventDefault(); try { await createUserWithEmailAndPassword(auth, registerForm['register-email'].value, registerForm['register-password'].value); authError.textContent = ''; } catch (error) { authError.textContent = "Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n. Vui l√≤ng th·ª≠ l·∫°i."; } });
        googleLoginBtn.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); authError.textContent = ''; } catch (error) { authError.textContent = "ƒêƒÉng nh·∫≠p Google th·∫•t b·∫°i."; } });
        logoutBtn.addEventListener('click', () => signOut(auth));
        showRegisterBtn.addEventListener('click', () => { loginView.classList.add('hidden'); registerView.classList.remove('hidden'); authError.textContent = ''; });
        showLoginBtn.addEventListener('click', () => { registerView.classList.add('hidden'); loginView.classList.remove('hidden'); authError.textContent = ''; });

        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if(SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.lang = 'vi-VN'; recognition.interimResults = false;
            recognition.onstart = () => { isRecording = true; recordBtn.classList.add('recording'); promptInput.placeholder = 'ƒêang l·∫Øng nghe...'; };
            recognition.onend = () => { isRecording = false; recordBtn.classList.remove('recording'); promptInput.placeholder = 'Nh·∫≠p c√¢u h·ªèi...'; };
            recognition.onresult = (event) => { promptInput.value = event.results[event.results.length - 1][0].transcript.trim(); adjustInputHeight(); };
            recognition.onerror = (event) => { addMessage('ai', `**L·ªói ghi √¢m:** ${event.error}. Vui l√≤ng th·ª≠ l·∫°i.`); };
        } else { recordBtn.classList.add('hidden'); }
        
        // --- CHAT LOGIC ---
        function clearSuggestions() {
            suggestionsContainer.innerHTML = '';
        }

        function startNewChat() {
            currentChatId = null;
            chat = model.startChat({ history: [] });
            chatContainer.innerHTML = '';
            clearSuggestions();
            addMessage('ai', 'Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?');
        }
        
        async function loadChat(chatId) {
            if (!currentUserId) return;
            try {
                const chatsCollection = collection(db, 'chats', currentUserId, 'conversations');
                const querySnapshot = await getDocs(chatsCollection);
                const chatDoc = querySnapshot.docs.find(doc => doc.id === chatId);

                if (chatDoc) {
                    const chatToLoad = chatDoc.data();
                    currentChatId = chatDoc.id;
                    chat = model.startChat({ history: chatToLoad.history });
                    
                    chatContainer.innerHTML = '';
                    clearSuggestions();
                    chatToLoad.history.forEach(msg => {
                        const role = msg.role === 'model' ? 'ai' : 'user';
                        addMessage(role, msg.parts[0].text);
                    });
                    savedChatsModal.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error loading chat:", error);
                addMessage('ai', '**L·ªói:** Kh√¥ng th·ªÉ t·∫£i cu·ªôc tr√≤ chuy·ªán.');
            }
        }

        function addMessage(role, text) {
            const messageElem = document.createElement('div');
            messageElem.className = `message ${role}`;
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = role === 'user' ? 'üôÇ' : 'ü§ñ';
            const contentElem = document.createElement('div');
            contentElem.className = 'message-content';
            contentElem.innerHTML = DOMPurify.sanitize(marked.parse(text));
            messageElem.appendChild(avatar);
            messageElem.appendChild(contentElem);
            chatContainer.appendChild(messageElem);
            scrollToBottom();
            return contentElem;
        }

        async function sendMessage() {
            const promptText = promptInput.value.trim();
            if (!promptText) return;

            sendBtn.disabled = true; recordBtn.disabled = true;
            promptInput.value = ''; adjustInputHeight();
            clearSuggestions();
            addMessage('user', promptText);
            
            const typingIndicator = showTypingIndicator();

            try {
                const result = await chat.sendMessageStream(promptText);
                
                if (typingIndicator && typingIndicator.parentNode) {
                    chatContainer.removeChild(typingIndicator);
                }

                const aiMessageContent = addMessage('ai', '...');
                aiMessageContent.innerHTML = '';
                
                let fullResponseText = "";
                for await (const chunk of result.stream) {
                    fullResponseText += chunk.text();
                    aiMessageContent.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));
                    scrollToBottom();
                }

                // After response is complete, get suggestions
                getFollowUpSuggestions(fullResponseText);

            } catch (error) {
                if (typingIndicator && typingIndicator.parentNode) {
                    chatContainer.removeChild(typingIndicator);
                }
                addMessage('ai', `**ƒê√£ x·∫£y ra l·ªói:** ${error.message}`);
            } finally {
                sendBtn.disabled = false; recordBtn.disabled = false;
                promptInput.focus();
            }
        }

        async function getFollowUpSuggestions(lastResponse) {
            try {
                const suggestionPrompt = `D·ª±a v√†o c√¢u tr·∫£ l·ªùi sau: "${lastResponse.substring(0, 500)}". H√£y ƒë·ªÅ xu·∫•t 3 c√¢u h·ªèi ti·∫øp theo ng·∫Øn g·ªçn v√† th√∫ v·ªã m√† ng∆∞·ªùi d√πng c√≥ th·ªÉ h·ªèi. QUAN TR·ªåNG: Ch·ªâ tr·∫£ v·ªÅ 3 c√¢u h·ªèi, m·ªói c√¢u tr√™n m·ªôt d√≤ng. Kh√¥ng ƒë√°nh s·ªë, kh√¥ng d√πng g·∫°ch ƒë·∫ßu d√≤ng, kh√¥ng th√™m b·∫•t k·ª≥ vƒÉn b·∫£n n√†o kh√°c.`;
                const suggestionModel = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" }); // Use a fresh instance for this
                const result = await suggestionModel.generateContent(suggestionPrompt);
                const responseText = result.response.text();
                const suggestions = responseText.split('\n').filter(s => s.trim() !== '');
                displaySuggestions(suggestions);
            } catch (error) {
                console.error("Error getting suggestions:", error);
            }
        }
        
        function displaySuggestions(suggestions) {
            clearSuggestions();
            suggestions.forEach(suggestionText => {
                const chip = document.createElement('button');
                chip.className = 'suggestion-chip';
                chip.textContent = suggestionText;
                chip.onclick = () => {
                    promptInput.value = suggestionText;
                    sendMessage();
                };
                suggestionsContainer.appendChild(chip);
            });
            scrollToBottom();
        }

        // --- FIRESTORE & HELPER FUNCTIONS ---
        async function saveCurrentChat() {
            if (!currentUserId || !chat) return;
            const history = await chat.getHistory();
            if (history.length < 2) {
                alert("Cu·ªôc tr√≤ chuy·ªán qu√° ng·∫Øn ƒë·ªÉ l∆∞u.");
                return;
            }

            const title = prompt("Nh·∫≠p ti√™u ƒë·ªÅ cho cu·ªôc tr√≤ chuy·ªán:", history[0].parts[0].text.substring(0, 40)) || 'Cu·ªôc tr√≤ chuy·ªán m·ªõi';
            const chatData = { title, history, createdAt: serverTimestamp() };

            try {
                const chatsCollection = collection(db, 'chats', currentUserId, 'conversations');
                if (currentChatId) {
                    const docRef = doc(db, 'chats', currentUserId, 'conversations', currentChatId);
                    await setDoc(docRef, chatData, { merge: true });
                } else {
                    const docRef = await addDoc(chatsCollection, chatData);
                    currentChatId = docRef.id;
                }
                alert("ƒê√£ l∆∞u cu·ªôc tr√≤ chuy·ªán!");
            } catch (error) {
                console.error("Error saving chat: ", error);
                alert("L∆∞u th·∫•t b·∫°i!");
            }
        }

        async function renderSavedChats() {
            if (!currentUserId) return;
            const chatsCollection = collection(db, 'chats', currentUserId, 'conversations');
            const q = query(chatsCollection, orderBy('createdAt', 'desc'));
            const querySnapshot = await getDocs(q);
            
            savedChatsList.innerHTML = '';
            if (querySnapshot.empty) {
                savedChatsList.innerHTML = '<li>Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o ƒë∆∞·ª£c l∆∞u.</li>';
                return;
            }
            querySnapshot.forEach(doc => {
                const chatItem = doc.data();
                const li = document.createElement('li');
                li.textContent = chatItem.title;
                li.onclick = () => loadChat(doc.id);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-chat-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = async (e) => { e.stopPropagation(); await deleteChat(doc.id); };
                
                li.appendChild(deleteBtn);
                savedChatsList.appendChild(li);
            });
        }
        
        async function deleteChat(chatId) {
            if (!currentUserId || !confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) return;
            try {
                await deleteDoc(doc(db, 'chats', currentUserId, 'conversations', chatId));
                renderSavedChats();
                if(chatId === currentChatId) startNewChat();
            } catch (error) {
                console.error("Error deleting chat:", error);
            }
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'message ai typing-indicator';
            indicator.innerHTML = `<div class="avatar">ü§ñ</div><div class="message-content"><span></span><span></span><span></span></div>`;
            chatContainer.appendChild(indicator);
            scrollToBottom();
            return indicator;
        }

        function scrollToBottom() {
             const scrollHeight = chatContainer.scrollHeight;
             const clientHeight = chatContainer.clientHeight;
             // Only scroll if near the bottom, to avoid interrupting user scrolling up
             if (scrollHeight - chatContainer.scrollTop - clientHeight < 200) {
                 chatContainer.scrollTop = scrollHeight;
             }
        }
        function adjustInputHeight() { promptInput.style.height = 'auto'; promptInput.style.height = (promptInput.scrollHeight) + 'px'; }
        function toggleRecording() { if (!recognition) return; isRecording ? recognition.stop() : recognition.start(); }

        // --- EVENT LISTENERS ---
        newChatBtn.addEventListener('click', startNewChat);
        sendBtn.addEventListener('click', sendMessage);
        recordBtn.addEventListener('click', toggleRecording);
        promptInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        promptInput.addEventListener('input', adjustInputHeight);
        saveChatBtn.addEventListener('click', saveCurrentChat);
        viewChatsBtn.addEventListener('click', () => { renderSavedChats(); savedChatsModal.classList.remove('hidden'); });
        closeModalBtn.addEventListener('click', () => savedChatsModal.classList.add('hidden'));
        savedChatsModal.addEventListener('click', e => { if (e.target === savedChatsModal) savedChatsModal.classList.add('hidden'); });
    </script>
</body>
</html>
