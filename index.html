<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
    <style>
        /* Custom scrollbar */
        #chat-container::-webkit-scrollbar, #reference-content::-webkit-scrollbar, #sidebar-content::-webkit-scrollbar {
            width: 6px;
        }
        #chat-container::-webkit-scrollbar-track, #reference-content::-webkit-scrollbar-track, #sidebar-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chat-container::-webkit-scrollbar-thumb, #reference-content::-webkit-scrollbar-thumb, #sidebar-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover, #reference-content::-webkit-scrollbar-thumb:hover, #sidebar-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Markdown Styles */
        .message-content pre {
            background-color: #1e293b; color: #e2e8f0;
            padding: 1rem; border-radius: 0.5rem;
            overflow-x: auto; font-family: 'Courier New', Courier, monospace;
        }
        .message-content code:not(pre > code) {
            background-color: #e2e8f0; padding: 0.2em 0.4em;
            margin: 0; font-size: 85%; border-radius: 3px;
        }
        .message-content h1, .message-content h2, .message-content h3, .message-content h4 {
            font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem;
        }
        .message-content h1 { font-size: 1.5em; }
        .message-content h2 { font-size: 1.25em; }
        .message-content h3 { font-size: 1.1em; }
        .message-content p { margin-bottom: 0.75rem; }
        .message-content ul, .message-content ol {
            margin-left: 1.25rem; margin-top: 0.5rem;
            margin-bottom: 1rem; display: block;
        }
        .message-content ul { list-style-type: disc; }
        .message-content ol { list-style-type: decimal; }
        .message-content li { margin-bottom: 0.5rem; padding-left: 0.5rem; }
        .message-content ul ul, .message-content ol ul { list-style-type: circle; margin-top: 0.5rem; }
        .message-content ul ul ul, .message-content ol ul ul { list-style-type: square; }
        .message-content blockquote {
            border-left: 4px solid #d1d5db; padding-left: 1rem;
            margin: 1rem 0; color: #4b5563; font-style: italic;
        }

        /* Skeleton Loader CSS */
        .skeleton-box {
            @apply bg-gray-200 rounded animate-pulse;
        }

        /* Cập nhật: CSS cho con trỏ nhấp nháy */
        .blinking-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em; /* Tương ứng với chiều cao dòng */
            background-color: #333;
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #333; }
        }

        /* Sidebar transitions */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            /* Đảm bảo nội dung không tràn ra ngoài góc bo tròn */
            overflow: hidden;
        }
        #sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
        }

        /* Recording button effect */
        #record-btn.recording {
            animation: pulse-red 1s infinite;
            background-color: #ef4444; /* red-500 */
            color: white;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
                transform: scale(1);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
                transform: scale(1);
            }
        }

        /* Subtle shadow for input-area */
        .p-4 > #input-area-wrapper { /* More specific selector to ensure override */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04); /* Adjusted to be more subtle */
            border-radius: 9999px; /* apply full rounded corners to the wrapper */
            padding: 4px; /* compensate for the p-2 on the inner div */
            background-color: white; /* ensure background for shadow */
            transition: box-shadow 0.2s ease-in-out; /* smooth transition for focus/hover */
        }
        .p-4 > #input-area-wrapper:focus-within {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); /* slightly stronger shadow on focus */
        }

        /* Đảm bảo sidebar-content có thể cuộn */
        #sidebar-content {
            overflow-y: scroll; /* Đã thay đổi từ auto thành scroll */
            overflow-x: hidden; /* Ngăn chặn cuộn ngang */
        }
    </style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="icon" href="icon-192.png">

</head>
<body class="bg-gray-100 font-sans">

    <!-- Authentication UI -->
    <div id="auth-container" class="flex items-center justify-center h-screen">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md m-4">
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Đăng nhập</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="login-email" required class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">Mật khẩu</label>
                        <input type="password" id="login-password" required class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">Đăng nhập</button>
                </form>
                <div class="my-4 flex items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-400">hoặc</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                <button id="google-login-btn" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.1 6.28C12.09 13.42 17.63 9.5 24 9.5z"/><path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 3.02-2.31 5.47-4.91 7.28l7.81 6.04C44.29 36.29 46.98 30.95 46.98 24.55z"/><path fill="#FBBC05" d="M10.66 28.14c-.58-1.74-.91-3.58-.91-5.48s.33-3.74.91-5.48l-8.1-6.28C.92 14.16 0 18.91 0 24s.92 9.84 2.56 13.22l8.1-6.08z"/><path fill="#EA4335" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.81-6.04c-2.18 1.47-4.96 2.34-8.08 2.34-6.37 0-11.91-3.92-13.84-9.3l-8.1 6.28C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                    Đăng nhập với Google
                </button>
                <p class="text-center mt-6 text-sm">
                    <a href="#" class="font-medium text-blue-600 hover:text-blue-500" id="show-register">Chưa có tài khoản? Đăng ký ngay</a>
                </p>
            </div>
            <div id="register-view" class="hidden">
                 <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Tạo tài khoản</h2>
                <form id="register-form">
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="register-email" required class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-700 text-sm font-bold mb-2">Mật khẩu</label>
                        <input type="password" id="register-password" required class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">Đăng ký</button>
                </form>
                <p class="text-center mt-6 text-sm">
                    <a href="#" class="font-medium text-blue-600 hover:text-blue-500" id="show-login">Đã có tài khoản? Đăng nhập</a>
                </p>
            </div>
            <p id="auth-error" class="text-red-500 text-center mt-4 min-h-[1.2em]"></p>
        </div>
    </div>

    <!-- Main App UI (hidden by default) -->
    <div id="app-container" class="hidden flex flex-col h-screen bg-gray-50">
        <header id="main-header" class="flex-shrink-0 flex justify-between items-center p-3 sm:p-4 bg-white border-b border-gray-200">
            <!-- Nút Menu để mở Sidebar -->
            <button id="menu-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors" title="Menu">
                <svg class="w-6 h-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>

            <div id="user-info" class="flex items-center gap-3">
                 <span id="user-avatar" class="w-9 h-9 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold uppercase"></span>
                 <span id="user-name" class="text-sm font-medium text-gray-700 hidden sm:block"></span>
            </div>
            <div class="flex items-center gap-1 sm:gap-2">
                <button id="logout-btn" class="p-2 rounded-full hover:bg-red-50 transition-colors" title="Đăng xuất">
                    <svg class="w-6 h-6 text-red-500" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none" opacity=".87"/><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                </button>
            </div>
        </header>

        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden opacity-0 transition-opacity duration-300 ease-in-out"></div>

        <!-- Sidebar -->
        <div id="sidebar" class="fixed top-0 left-0 h-screen w-[calc(100vw-56px)] sm:w-64 md:w-72 bg-white shadow-xl z-50 transform -translate-x-full lg:translate-x-0 lg:static lg:flex lg:flex-col lg:border-r border-gray-200 rounded-r-2xl">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between lg:hidden">
                <h2 class="text-lg font-semibold">Menu</h2>
                <button id="close-sidebar-btn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg class="w-6 h-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
                </button>
            </div>
            <div id="sidebar-content" class="flex-1 overflow-y-scroll overflow-x-hidden p-4">
                <button id="new-chat-btn" class="w-full flex items-center gap-3 p-3 rounded-lg border border-blue-200 hover:bg-blue-50 transition-colors text-blue-700 font-semibold mb-4">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M14.06 9.02l.92.92L5.92 19H5v-.92l9.06-9.06M17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29zm-3.6 3.19L3 17.25V21h3.75L17.81 9.94l-3.75-3.75z"/></svg>
                    Trò chuyện mới
                </button>
                <h3 class="text-sm font-semibold text-gray-500 mb-2 uppercase">Lịch sử</h3>
                <ul id="saved-chats-list" class="space-y-1"></ul>
                <!-- Skeleton loader for saved chats -->
                <div id="saved-chats-skeleton" class="space-y-2 mt-4 hidden">
                    <div class="h-8 bg-gray-200 rounded animate-pulse w-11/12"></div>
                    <div class="h-8 bg-gray-200 rounded animate-pulse w-10/12"></div>
                    <div class="h-8 bg-gray-200 rounded animate-pulse w-9/12"></div>
                </div>
            </div>
        </div>

        <div id="chat-container" class="flex-1 px-4 pt-4 space-y-4 overflow-y-auto"></div>

        <div id="suggestion-area" class="px-4 pb-2">
            <button id="toggle-suggestions-btn" class="hidden w-full text-left text-sm text-blue-600 font-semibold p-2 rounded-lg hover:bg-blue-50 flex items-center gap-2">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><g><rect fill="none" height="24" width="24"/></g><g><g><path d="M4,18h11c0.55,0,1-0.45,1-1v-2c0-0.55-0.45-1-1-1H4c-0.55,0-1,0.45-1,1v2C3,17.55,3.45,18,4,18z M3,7c0,0.55,0.45,1,1,1 h11c0.55,0,1-0.45,1-1V5c0-0.55-0.45-1-1-1H4C3.45,4,3,4.45,3,5V7z M4,13h11c0.55,0,1-0.45,1-1v-2c0-0.55-0.45-1-1-1H4 c-0.55,0-1,0.45-1,1v2C3,12.55,3.45,13,4,13z M19.5,4.5L19.5,4.5c0.47,0.47,0.47,1.23,0,1.7l-4.08,4.08 c-0.47,0.47-1.23,0.47-1.7,0l0,0c-0.47-0.47-0.47-1.23,0-1.7l4.08-4.08C18.27,4.03,19.03,4.03,19.5,4.5z M19.5,17.82 c0.47-0.47,1.23-0.47,1.7,0l0,0c0.47,0.47,0.47,1.23,0,1.7l-4.08,4.08c-0.47,0.47-1.23,0.47-1.7,0l0,0c-0.47-0.47-0.47-1.23,0-1.7 L19.5,17.82z"/></g></g></svg>
                Xem gợi ý
            </button>
            <div id="suggestions-container" class="hidden mt-2 flex flex-wrap gap-2"></div>
        </div>

        <div class="p-4 bg-white border-t border-gray-200">
            <!-- New wrapper for input area to apply shadow -->
            <div id="input-area-wrapper" class="rounded-full">
                <div id="input-area" class="flex items-center gap-3 bg-gray-100 rounded-full p-2">
                    <button id="reference-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Trợ lý Phụ">
                        <svg class="w-6 h-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><g><path d="M0,0h24v24H0V0z" fill="none"/></g><g><g><path d="M11,7h2v2h-2V7z M11,11h2v6h-2V11z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20 c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/></g></g></svg>
                    </button>
                    <textarea id="prompt-input" rows="1" placeholder="Nhập câu hỏi..." class="flex-1 bg-transparent px-3 py-2 resize-none focus:outline-none"></textarea>
                    <button id="record-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Ghi âm">
                        <svg class="w-6 h-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                    </button>
                    <button id="send-btn" class="w-10 h-10 flex items-center justify-center bg-blue-600 rounded-full text-white hover:bg-blue-700 transition-colors disabled:bg-blue-300 disabled:cursor-not-allowed" title="Gửi">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reference Modal (Bottom Sheet) -->
    <div id="reference-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300 ease-in-out"></div>
    <div id="reference-modal" class="hidden fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl z-50 flex flex-col transform transition-transform duration-300 ease-in-out" style="max-height: 85vh;">
        <div id="reference-header" class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
            <h2 id="reference-title" class="text-lg font-semibold text-gray-800">Trợ lý Phụ</h2>
            <button id="close-reference-modal-btn" class="p-2 rounded-full hover:bg-gray-200">
                <svg class="w-6 h-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
            </button>
        </div>
        <div id="reference-content" class="p-4 overflow-y-auto flex-1 space-y-4"></div>
        <div id="reference-input-area" class="p-4 bg-white border-t border-gray-200 flex-shrink-0">
            <div class="flex items-center gap-3 bg-gray-100 rounded-full p-2">
                <textarea id="reference-prompt-input" rows="1" placeholder="Hỏi trợ lý phụ..." class="flex-1 bg-transparent px-3 py-2 resize-none focus:outline-none"></textarea>
                <button id="reference-send-btn" class="w-10 h-10 flex items-center justify-center bg-blue-600 rounded-full text-white hover:bg-blue-700 transition-colors" title="Gửi">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg>
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";
        import {
            getFirestore,
            collection,
            doc,
            addDoc,
            updateDoc,
            getDoc,
            getDocs,
            deleteDoc,
            serverTimestamp,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
             apiKey: "AIzaSyBDUBufnsk1PQZTLYCJDqASMX8hEVHqkDc",
             authDomain: "aimind-2362a.firebaseapp.com",
             projectId: "aimind-2362a",
             storageBucket: "aimind-2362a.firebasestorage.app",
             messagingSenderId: "377635504319",
             appId: "1:377635504319:web:7c6dd3cf0c52dd302d860a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ai = getAI(app);
        const model = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });

        let currentUserId = null;
        let currentChatId = null;
        let chat;
        let localHistory = [];
        let isRecording = false;
        let referenceChat;
        let referenceHistory = [];
        const formattingInstruction = "**Chỉ thị hệ thống:** Mục tiêu chính của bạn là đưa ra câu trả lời rõ ràng, chi tiết và có cấu trúc tốt. Luôn sử dụng Markdown để định dạng (tiêu đề, danh sách, in đậm). Hãy giải thích các khái niệm từng bước, bắt đầu bằng tóm tắt rồi đi vào chi tiết và ví dụ.";

        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');
        const userInfo = document.getElementById('user-info');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const logoutBtn = document.getElementById('logout-btn');
        const mainHeader = document.getElementById('main-header');
        const chatContainer = document.getElementById('chat-container');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const toggleSuggestionsBtn = document.getElementById('toggle-suggestions-btn');
        const promptInput = document.getElementById('prompt-input');
        const sendBtn = document.getElementById('send-btn');
        const recordBtn = document.getElementById('record-btn');

        // Sidebar elements
        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const newChatBtn = document.getElementById('new-chat-btn'); // Nút này đã được di chuyển vào sidebar
        const savedChatsList = document.getElementById('saved-chats-list'); // List này cũng được di chuyển vào sidebar
        const savedChatsSkeleton = document.getElementById('saved-chats-skeleton');


        const referenceBtn = document.getElementById('reference-btn');
        const referenceModalOverlay = document.getElementById('reference-modal-overlay');
        const referenceModal = document.getElementById('reference-modal');
        const referenceHeader = document.getElementById('reference-header');
        const referenceTitle = document.getElementById('reference-title');
        const closeReferenceModalBtn = document.getElementById('close-reference-modal-btn');
        const referenceContent = document.getElementById('reference-content');
        const referenceInputArea = document.getElementById('reference-input-area');
        const referencePromptInput = document.getElementById('reference-prompt-input');
        const referenceSendBtn = document.getElementById('reference-send-btn');

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                const email = user.email || '';
                const displayName = user.displayName || email.split('@')[0];
                userName.textContent = `Chào, ${displayName}`;
                userAvatar.textContent = displayName.charAt(0);
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                startNewChat();
                renderSavedChats(); // Load saved chats when user logs in
            } else {
                currentUserId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', async e => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value); authError.textContent = ''; } catch (error) { authError.textContent = "Email hoặc mật khẩu không đúng."; } });
        registerForm.addEventListener('submit', async e => { e.preventDefault(); try { await createUserWithEmailAndPassword(auth, registerForm['register-email'].value, registerForm['register-password'].value); authError.textContent = ''; } catch (error) { authError.textContent = "Không thể tạo tài khoản. Vui lòng thử lại."; } });
        googleLoginBtn.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); authError.textContent = ''; } catch (error) { authError.textContent = "Đăng nhập Google thất bại."; } });
        logoutBtn.addEventListener('click', () => signOut(auth));
        showRegisterBtn.addEventListener('click', () => { loginView.classList.add('hidden'); registerView.classList.remove('hidden'); authError.textContent = ''; });
        showLoginBtn.addEventListener('click', () => { registerView.classList.add('hidden'); loginView.classList.remove('hidden'); authError.textContent = ''; });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if(SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.lang = 'vi-VN'; recognition.interimResults = false;
            recognition.onstart = () => { isRecording = true; recordBtn.classList.add('recording'); promptInput.placeholder = 'Đang lắng nghe...'; };
            recognition.onend = () => { isRecording = false; recordBtn.classList.remove('recording'); promptInput.placeholder = 'Nhập câu hỏi...'; };
            recognition.onresult = (event) => { promptInput.value = event.results[event.results.length - 1][0].transcript.trim(); adjustInputHeight(); };
            recognition.onerror = (event) => { addMessage('ai', `**Lỗi ghi âm:** ${event.error}. Vui lòng thử lại.`); };
        } else { recordBtn.classList.add('hidden'); }

        // Sidebar functions
        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
            setTimeout(() => sidebarOverlay.classList.add('opacity-100'), 10); // Trigger opacity transition
            renderSavedChats(); // Render chats every time sidebar is opened
        }

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.remove('opacity-100');
            setTimeout(() => sidebarOverlay.classList.add('hidden'), 300); // Hide after transition
        }


        function showReferenceModal(title, showInput) {
            referenceTitle.textContent = title;
            referenceInputArea.style.display = showInput ? 'block' : 'none';
            referenceModalOverlay.classList.remove('hidden');
            referenceModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                referenceModalOverlay.classList.add('opacity-100'); // Use opacity for overlay
                referenceModal.classList.add('modal-enter-active'); // Existing class
            });
            if (showInput) {
                referenceHistory = [];
                referenceChat = model.startChat({ history: [] });
                referenceContent.innerHTML = '';
                addMessageToReference('ai', 'Đây là trợ lý phụ. Bạn cần tra cứu nhanh gì không?');
            }
        }

        function closeReferenceModal() {
            referenceModalOverlay.classList.remove('opacity-100');
            referenceModal.classList.remove('modal-enter-active');
            setTimeout(() => {
                referenceModalOverlay.classList.add('hidden');
                referenceModal.classList.add('hidden');
            }, 300);
        }

        function handleSmartScroll(messageWrapper, container) {
            if (container.scrollHeight - container.scrollTop - container.clientHeight < 200) {
                 messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
            }
        }

        function addMessageToReference(role, text, shouldScroll = true) {
             const messageWrapper = document.createElement('div');
            if (role === 'ai') {
                messageWrapper.className = 'w-full space-y-2';
                messageWrapper.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-full flex-shrink-0 bg-gradient-to-tr from-green-400 to-cyan-500 flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><g><rect fill="none" height="24" width="24"/></g><g><g><path d="M11,7h2v2h-2V7z M11,11h2v6h-2V11z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20 c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/></g></g></svg>
                        </div>
                        <span class="font-semibold text-gray-800">Trợ lý Phụ</span>
                    </div>
                    <div class="message-content text-gray-800"></div>`;
                const contentElem = messageWrapper.querySelector('.message-content');
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(text));
                referenceContent.appendChild(messageWrapper);
                 if (shouldScroll) {
                    messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
                }
                return { messageWrapper, contentElem };
            } else {
                messageWrapper.className = 'flex justify-end';
                messageWrapper.innerHTML = `<div class="message-content px-4 py-2 rounded-2xl bg-blue-600 text-white max-w-xs sm:max-w-md lg:max-w-2xl"></div>`;
                const contentElem = messageWrapper.querySelector('.message-content');
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(text));
                referenceContent.appendChild(messageWrapper);
                if(shouldScroll) {
                    messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
                }
                return { messageWrapper, contentElem };
            }
        }

        async function sendReferenceMessage() {
            let promptText = referencePromptInput.value.trim();
            if (!promptText) return;
            referenceSendBtn.disabled = true;
            referencePromptInput.value = '';
            addMessageToReference('user', promptText);
            if (referenceHistory.length === 0) {
                 promptText = formattingInstruction + '\n\n' + promptText;
            }
            referenceHistory.push({ role: 'user', parts: [{ text: promptText }] });

            const { messageWrapper, contentElem } = addMessageToReference('ai', '<span class="blinking-cursor"></span>');

            try {
                const result = await referenceChat.sendMessageStream(promptText);
                contentElem.innerHTML = '';
                let fullResponseText = "";
                for await (const chunk of result.stream) {
                    fullResponseText += chunk.text();
                    contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText)) + '<span class="blinking-cursor"></span>';
                    handleSmartScroll(messageWrapper, referenceContent);
                }

                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));
                const headerHeight = referenceHeader.offsetHeight;
                const scrollTop = messageWrapper.offsetTop - headerHeight - 16;
                referenceContent.scrollTo({ top: scrollTop, behavior: 'smooth' });

                referenceHistory.push({ role: 'model', parts: [{ text: fullResponseText }] });
            } catch (error) {
                 if (messageWrapper.parentNode) referenceContent.removeChild(messageWrapper);
                addMessageToReference('ai', `**Đã xảy ra lỗi:** ${error.message}`);
                referenceHistory.pop();
            } finally {
                referenceSendBtn.disabled = false;
                referencePromptInput.focus();
            }
        }

        async function getSuggestedAnswer(promptText) {
            showReferenceModal('Gợi ý', false);
            referenceContent.innerHTML = '';
            const tempChat = model.startChat({ history: localHistory });

            const { messageWrapper, contentElem } = addMessageToReference('ai', '<span class="blinking-cursor"></span>');

            try {
                addMessageToReference('user', promptText);
                const result = await tempChat.sendMessageStream(promptText);

                contentElem.innerHTML = '';
                let fullResponseText = "";
                for await (const chunk of result.stream) {
                    fullResponseText += chunk.text();
                    contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText)) + '<span class="blinking-cursor"></span>';
                    handleSmartScroll(messageWrapper, referenceContent);
                }
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));
                const headerHeight = referenceHeader.offsetHeight;
                const scrollTop = messageWrapper.offsetTop - headerHeight - 16;
                referenceContent.scrollTo({ top: scrollTop, behavior: 'smooth' });

            } catch (error) {
                 if (messageWrapper.parentNode) referenceContent.removeChild(messageWrapper);
                addMessageToReference('ai', `**Đã xảy ra lỗi:** ${error.message}`);
            }
        }

        function clearSuggestions() {
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            toggleSuggestionsBtn.classList.add('hidden');
        }

        function startNewChat() {
            currentChatId = null;
            localHistory = [];
            referenceHistory = [];
            referenceChat = null;
            const initialHistory = [{
                role: "user",
                parts: [{ text: formattingInstruction }],
            }, {
                role: "model",
                parts: [{ text: "Đã hiểu! Tôi sẽ cung cấp các câu trả lời chi tiết, rõ ràng và được định dạng cẩn thận." }],
            }];
            chat = model.startChat({ history: initialHistory });
            chatContainer.innerHTML = '';
            clearSuggestions();
            addMessage('ai', 'Xin chào! Tôi có thể giúp gì cho bạn?');
            closeSidebar(); // Close sidebar after starting new chat
        }

        async function loadChat(chatId) {
            if (!currentUserId) return;

            showHistorySkeleton(); // Show skeleton while loading
            closeSidebar(); // Close sidebar when a chat is selected

            try {
                const docRef = doc(db, 'chats', currentUserId, 'conversations', chatId);
                const chatDoc = await getDoc(docRef);

                if (chatDoc.exists()) {
                    localHistory = chatDoc.data().history || [];
                    currentChatId = chatDoc.id;
                    chat = model.startChat({ history: localHistory });

                    chatContainer.innerHTML = '';
                    clearSuggestions();

                    localHistory.forEach(msg => {
                        if (msg.role === 'user' && msg.parts[0].text.includes("**Chỉ thị hệ thống:**")) return;
                        if (msg.role === 'model' && msg.parts[0].text.startsWith("Đã hiểu!")) return;
                        const role = msg.role === 'model' ? 'ai' : 'user';
                        addMessage(role, msg.parts[0].text, false);
                    });
                    setTimeout(() => chatContainer.scrollTop = chatContainer.scrollHeight, 0);
                } else {
                     addMessage('ai', '**Lỗi:** Không tìm thấy cuộc trò chuyện.');
                }
            } catch (error) {
                console.error("Lỗi khi tải cuộc trò chuyện:", error);
                chatContainer.innerHTML = '';
                addMessage('ai', '**Lỗi:** Không thể tải cuộc trò chuyện.');
            }
        }

        function addMessage(role, text, shouldScroll = true) {
            const messageWrapper = document.createElement('div');
            if (role === 'ai') {
                messageWrapper.className = 'w-full space-y-2';
                messageWrapper.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-full flex-shrink-0 bg-gradient-to-tr from-purple-400 to-indigo-500 flex items-center justify-center">
                           <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M12 6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6 2.69-6 6-6m0-2c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8z"/><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                        </div>
                        <span class="font-semibold text-gray-800">Gemini</span>
                    </div>
                    <div class="message-content text-gray-800"></div>`;
                const contentElem = messageWrapper.querySelector('.message-content');
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(text));
                chatContainer.appendChild(messageWrapper);
                if (shouldScroll) {
                    messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
                }
                return { messageWrapper, contentElem };
            } else {
                messageWrapper.className = 'flex justify-end';
                messageWrapper.innerHTML = `<div class="message-content px-4 py-2 rounded-2xl bg-blue-600 text-white max-w-xs sm:max-w-md lg:max-w-2xl"></div>`;
                const contentElem = messageWrapper.querySelector('.message-content');
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(text));
                chatContainer.appendChild(messageWrapper);
                if(shouldScroll) {
                    messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
                }
                return { messageWrapper, contentElem };
            }
        }

        async function sendMessage() {
            const promptText = promptInput.value.trim();
            if (!promptText) return;
            sendBtn.disabled = true; recordBtn.disabled = true;
            promptInput.value = ''; adjustInputHeight();
            clearSuggestions();
            addMessage('user', promptText);
            localHistory.push({ role: 'user', parts: [{ text: promptText }] });

            const { messageWrapper, contentElem } = addMessage('ai', '<span class="blinking-cursor"></span>');

            try {
                const result = await chat.sendMessageStream(promptText);

                contentElem.innerHTML = '';
                let fullResponseText = "";

                for await (const chunk of result.stream) {
                    fullResponseText += chunk.text();
                    contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText)) + '<span class="blinking-cursor"></span>';
                    handleSmartScroll(messageWrapper, chatContainer);
                }

                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));
                const headerHeight = mainHeader.offsetHeight;
                const scrollTop = messageWrapper.offsetTop - headerHeight - 16;
                chatContainer.scrollTo({ top: scrollTop, behavior: 'smooth' });

                localHistory.push({ role: 'model', parts: [{ text: fullResponseText }] });
                await updateConversationInDb();
                getFollowUpSuggestions(fullResponseText);
            } catch (error) {
                if (messageWrapper.parentNode) chatContainer.removeChild(messageWrapper);
                addMessage('ai', `**Đã xảy ra lỗi:** ${error.message}`);
                localHistory.pop();
            } finally {
                sendBtn.disabled = false; recordBtn.disabled = false;
                promptInput.focus();
            }
        }

        async function getFollowUpSuggestions(lastResponse) {
            try {
                const suggestionPrompt = `Dựa vào câu trả lời sau: "${lastResponse.substring(0, 500)}". Hãy đề xuất 3 câu hỏi tiếp theo ngắn gọn và thú vị mà người dùng có thể hỏi. QUAN TRỌNG: Chỉ trả về 3 câu hỏi, mỗi câu trên một dòng. Không đánh số, không dùng gạch đầu dòng, không thêm bất kỳ văn bản nào khác.`;
                const suggestionModel = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });
                const result = await suggestionModel.generateContent(suggestionPrompt);
                const responseText = result.response.text();
                const suggestions = responseText.split('\n').filter(s => s.trim() !== '');
                displaySuggestions(suggestions);
            } catch (error) {
                console.error("Error getting suggestions:", error);
            }
        }

        function displaySuggestions(suggestions) {
            suggestionsContainer.innerHTML = '';
            if(suggestions.length > 0) {
                toggleSuggestionsBtn.classList.remove('hidden');
                suggestions.forEach(suggestionText => {
                    const chip = document.createElement('button');
                    chip.className = 'suggestion-chip border border-blue-200 bg-blue-50 text-blue-700 rounded-full px-3 py-1 text-sm hover:bg-blue-100 transition-colors';
                    chip.textContent = suggestionText;
                    chip.onclick = () => { getSuggestedAnswer(suggestionText); };
                    suggestionsContainer.appendChild(chip);
                });
            } else {
                 toggleSuggestionsBtn.classList.add('hidden');
            }
        }

        async function updateConversationInDb() {
            if (!currentUserId || localHistory.length < 2) return;
            const chatData = { history: localHistory, updatedAt: serverTimestamp() };
            try {
                if (currentChatId) {
                    const docRef = doc(db, 'chats', currentUserId, 'conversations', currentChatId);
                    await updateDoc(docRef, chatData);
                } else {
                    chatData.title = localHistory.find(m => m.role === 'user' && !m.parts[0].text.includes('**Chỉ thị hệ thống:**'))?.parts[0].text.substring(0, 40) || "Cuộc trò chuyện mới";
                    chatData.createdAt = serverTimestamp();
                    const chatsCollection = collection(db, 'chats', currentUserId, 'conversations');
                    const docRef = await addDoc(chatsCollection, chatData);
                    currentChatId = docRef.id;
                }
                renderSavedChats(); // Re-render sidebar to show updated/new chat
            } catch (error) {
                console.error("Lỗi khi cập nhật cuộc trò chuyện:", error);
            }
        }

        async function renderSavedChats() {
            if (!currentUserId) {
                savedChatsList.innerHTML = '<li>Đăng nhập để xem lịch sử trò chuyện.</li>';
                return;
            }
            savedChatsSkeleton.classList.remove('hidden'); // Show skeleton
            savedChatsList.innerHTML = ''; // Clear existing list
            const chatsCollection = collection(db, 'chats', currentUserId, 'conversations');
            const q = query(chatsCollection, orderBy('updatedAt', 'desc'));
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    savedChatsList.innerHTML = '<li class="text-gray-500 text-sm">Chưa có cuộc trò chuyện nào.</li>';
                } else {
                    querySnapshot.forEach(doc => {
                        const chatItem = doc.data();
                        const li = document.createElement('li');
                        li.className = "p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center rounded-md";

                        const titleSpan = document.createElement('span');
                        titleSpan.textContent = chatItem.title;
                        titleSpan.className = "flex-1 truncate pr-2 text-gray-800";
                        li.appendChild(titleSpan);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'p-1 text-gray-400 hover:text-red-600 rounded-full';
                        deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>';
                        deleteBtn.onclick = async (e) => {
                            e.stopPropagation();
                            if (confirm("Bạn có chắc chắn muốn xóa cuộc trò chuyện này?")) {
                                await deleteChat(doc.id);
                            }
                        };

                        li.appendChild(deleteBtn);
                        li.onclick = () => loadChat(doc.id);
                        savedChatsList.appendChild(li);
                    });
                }
            } catch (error) {
                console.error("Lỗi khi lấy lịch sử trò chuyện:", error);
                savedChatsList.innerHTML = '<li class="text-red-500 text-sm">Không thể tải lịch sử.</li>';
            } finally {
                savedChatsSkeleton.classList.add('hidden'); // Hide skeleton
            }
        }

        async function deleteChat(chatId) {
            if (!currentUserId) return;
            try {
                await deleteDoc(doc(db, 'chats', currentUserId, 'conversations', chatId));
                renderSavedChats();
                if(chatId === currentChatId) startNewChat(); // Start a new chat if the current one is deleted
            } catch (error) {
                console.error("Error deleting chat:", error);
            }
        }

        // Giữ lại hàm này cho việc tải lịch sử chat (skeleton loader trong main chat area)
        function showHistorySkeleton() {
            chatContainer.innerHTML = '';
            const skeletonHTML = `
                <div class="w-full space-y-2">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-full skeleton-box"></div>
                        <div class="w-20 h-4 skeleton-box"></div>
                    </div>
                    <div class="ml-9 space-y-2">
                        <div class="w-10/12 h-4 skeleton-box"></div>
                        <div class="w-8/12 h-4 skeleton-box"></div>
                    </div>
                </div>
                <div class="flex justify-end">
                    <div class="w-7/12">
                        <div class="h-16 skeleton-box rounded-2xl"></div>
                    </div>
                </div>
            `;
            for (let i = 0; i < 3; i++) {
                chatContainer.innerHTML += skeletonHTML;
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function adjustInputHeight() {
            promptInput.style.height = 'auto';
            const scrollHeight = promptInput.scrollHeight;
            promptInput.style.height = scrollHeight + 'px';
        }

        function toggleRecording() { if (!recognition) return; isRecording ? recognition.stop() : recognition.start(); }

        // Event Listeners
        menuBtn.addEventListener('click', openSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        newChatBtn.addEventListener('click', startNewChat); // Nút này giờ nằm trong sidebar
        // viewChatsBtn đã bị loại bỏ, chức năng xem chats được tích hợp vào việc mở sidebar

        sendBtn.addEventListener('click', sendMessage);
        recordBtn.addEventListener('click', toggleRecording);
        promptInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        promptInput.addEventListener('input', adjustInputHeight);

        toggleSuggestionsBtn.addEventListener('click', () => { suggestionsContainer.classList.toggle('hidden'); });
        referenceBtn.addEventListener('click', () => showReferenceModal('Trợ lý Phụ', true));
        closeReferenceModalBtn.addEventListener('click', closeReferenceModal);
        referenceModalOverlay.addEventListener('click', closeReferenceModal);
        referenceSendBtn.addEventListener('click', sendReferenceMessage);
        referencePromptInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendReferenceMessage(); } });

    </script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", function () {
      navigator.serviceWorker.register("/service-worker.js")
        .then(reg => console.log("SW registered:", reg.scope))
        .catch(err => console.error("SW registration failed:", err));
    });
  }
</script>

</body>
</html>
