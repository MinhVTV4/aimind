<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase AI Logic - Gemini API Streaming & Markdown</title>
    <!-- Thư viện để chuyển đổi Markdown sang HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Thư viện để "làm sạch" HTML, chống lại các cuộc tấn công XSS khi dùng innerHTML -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 20px;
            background-color: #f4f6f8; 
            color: #333; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 90vh;
        }
        .container {
            width: 100%;
            max-width: 700px;
        }
        h1, h2 { 
            color: #1e3a8a; 
            text-align: center;
            margin-bottom: 20px;
        }
        #controls { 
            margin-bottom: 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        textarea { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            box-sizing: border-box; 
            resize: vertical;
            font-size: 16px;
        }
        button { 
            padding: 12px 25px; 
            background-color: #2563eb; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 17px;
            transition: background-color 0.3s ease;
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
        }
        button:hover { 
            background-color: #1d4ed8; 
        }
        button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        #responseContainer { 
            margin-top: 20px; 
            padding: 20px; 
            border: 1px solid #e5e7eb; 
            background-color: #fff; 
            border-radius: 12px; 
            min-height: 150px; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            text-align: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease;
        }
        /* Styling cho nội dung Markdown */
        #responseContainer h1, #responseContainer h2, #responseContainer h3 {
            color: #1e3a8a;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        #responseContainer code {
            background-color: #f1f1f1;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: "Courier New", Courier, monospace;
        }
        #responseContainer pre {
            background-color: #2d2d2d;
            color: #f1f1f1;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }
        #responseContainer blockquote {
            border-left: 4px solid #ccc;
            padding-left: 15px;
            color: #666;
            margin-left: 0;
        }
        .error { 
            color: #dc2626; 
            font-weight: bold; 
        }
        .status-message {
            margin-top: 15px;
            font-weight: bold;
            font-size: 0.95rem;
            color: #555;
            text-align: center;
        }
        .status-message.error-text { color: #dc2626; }
        .status-message.success-text { color: #16a34a; }
        .status-message.info-text { color: #f59e0b; }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-left-color: #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        .hidden { display: none; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Thử nghiệm Gemini API</h1>
        <h2 style="font-size: 1rem; color: #555;">(Model: gemini-1.5-flash-latest | Streaming & Markdown)</h2>

        <div id="controls">
            <textarea id="promptInput" rows="4" placeholder="Nhập lời nhắc của bạn ở đây... ví dụ: Viết một bài thơ về lập trình."></textarea>
            <button id="sendPromptButton">
                <span id="buttonText">Gửi yêu cầu tới Gemini</span>
                <div id="buttonSpinner" class="spinner hidden"></div>
            </button>
            <p id="statusMessage" class="status-message"></p>
        </div>
        
        <h2>Phản hồi từ Gemini:</h2>
        <div id="responseContainer">Chưa có phản hồi...</div>
    </div>

    <script type="module">
        // Import các hàm từ SDK
        // SDK đã được cập nhật lên phiên bản 11.9.1
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";

        // Cấu hình Firebase mới của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyBDUBufnsk1PQZTLYCJDqASMX8hEVHqkDc",
            authDomain: "aimind-2362a.firebaseapp.com",
            projectId: "aimind-2362a",
            storageBucket: "aimind-2362a.firebasestorage.app",
            messagingSenderId: "377635504319",
            appId: "1:377635504319:web:7c6dd3cf0c52dd302d860a"
        };

        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        console.log("Firebase App initialized!");
        
        // Lấy các phần tử DOM
        const promptInput = document.getElementById('promptInput');
        const sendPromptButton = document.getElementById('sendPromptButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        const responseContainer = document.getElementById('responseContainer');
        const statusMessage = document.getElementById('statusMessage');

        function updateStatus(type, message) {
            statusMessage.className = `status-message ${type}`;
            statusMessage.textContent = message;
        }

        updateStatus('info-text', "Firebase App đã khởi tạo. Đang chờ khởi tạo AI Model...");

        let model;
        try {
            // Lưu ý: Không cần 'new GoogleAIBackend()' nữa với các phiên bản SDK mới
            const ai = getAI(app); 
            model = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });
            console.log("Generative Model instance created with model 'gemini-1.5-flash-latest'!");
            updateStatus('success-text', "Model đã sẵn sàng. Hãy nhập yêu cầu của bạn.");
        } catch (e) {
            console.error("Lỗi khi khởi tạo AI Model:", e);
            updateStatus('error-text', `Lỗi khởi tạo AI Model: ${e.message}.`);
        }
        
        // Hàm gọi API Gemini đã được cập nhật để sử dụng streaming
        async function callGeminiAPI() {
            if (!model) {
                updateStatus('error-text', "Mô hình AI chưa được khởi tạo.");
                return;
            }

            const promptText = promptInput.value.trim();
            if (!promptText) {
                updateStatus('error-text', "Vui lòng nhập lời nhắc!");
                return;
            }

            updateStatus('info-text', "Đang gửi yêu cầu và nhận phản hồi...");
            responseContainer.innerHTML = ''; // Xóa nội dung cũ

            buttonText.textContent = 'Đang nhận...';
            buttonSpinner.classList.remove('hidden');
            sendPromptButton.disabled = true;

            try {
                // SỬA LỖI:
                // 1. Dùng 'await' để đợi promise từ 'generateContentStream' được giải quyết.
                // 2. Vòng lặp sẽ duyệt qua 'result.stream' là một async iterable.
                const result = await model.generateContentStream(promptText);
                const stream = result.stream;
                let fullResponseText = "";

                // Lặp qua từng phần dữ liệu (chunk) nhận được từ stream
                for await (const chunk of stream) {
                    // SỬA LỖI: Lấy văn bản trực tiếp từ chunk.text()
                    const chunkText = chunk.text();
                    fullResponseText += chunkText;
                    
                    // Chuyển đổi toàn bộ văn bản Markdown đã nhận sang HTML
                    // và "làm sạch" nó bằng DOMPurify trước khi chèn vào trang
                    responseContainer.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));
                }

                updateStatus('success-text', "Đã hoàn tất nhận phản hồi.");
                console.log("Final Response:", fullResponseText);

            } catch (error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                // SỬA LỖI: Cung cấp thông báo lỗi rõ ràng hơn cho người dùng
                let errorMessage = `<strong>Lỗi: ${error.message}</strong>`;
                if (error.code === 'AI/api-not-enabled') {
                    errorMessage += `<br><br>Có vẻ như bạn chưa bật 'Firebase AI API' ('firebasevertexai.googleapis.com') trong dự án Firebase của mình. Vui lòng truy cập Firebase Console để bật API và thử lại.`;
                } else {
                    errorMessage += `<br>Vui lòng kiểm tra Console (F12) để biết thêm chi tiết.`;
                }
                responseContainer.innerHTML = `<div class="error" style="padding: 10px;">${errorMessage}</div>`;
                updateStatus('error-text', `Lỗi khi gọi Gemini API: ${error.message}.`);
            } finally {
                // Khôi phục lại trạng thái của nút
                buttonText.textContent = 'Gửi yêu cầu tới Gemini';
                buttonSpinner.classList.add('hidden');
                sendPromptButton.disabled = false;
            }
        }

        if (sendPromptButton) {
            sendPromptButton.addEventListener("click", callGeminiAPI);
        } else {
            console.error("Không tìm thấy nút 'sendPromptButton'.");
            updateStatus('error-text', "Lỗi giao diện: Không tìm thấy nút gửi.");
        }
    </script>
</body>
</html>
