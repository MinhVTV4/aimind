<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
    <script>
        // Script n√†y ƒë∆∞·ª£c ƒë·∫∑t trong <head> ƒë·ªÉ tr√°nh hi·ªán t∆∞·ª£ng "FOUC" (Flash of Unstyled Content)
        // N√≥ s·∫Ω √°p d·ª•ng theme t·ªëi ngay l·∫≠p t·ª©c n·∫øu ƒë∆∞·ª£c l∆∞u trong localStorage ho·∫∑c theo c√†i ƒë·∫∑t h·ªá th·ªëng.
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        /* Custom scrollbar for light mode */
        :root {
            --scrollbar-track-bg: #f1f1f1;
            --scrollbar-thumb-bg: #888;
            --scrollbar-thumb-hover-bg: #555;
        }

        /* Custom scrollbar for dark mode */
        .dark {
            --scrollbar-track-bg: #2d3748; /* gray-800 */
            --scrollbar-thumb-bg: #718096; /* gray-500 */
            --scrollbar-thumb-hover-bg: #a0aec0; /* gray-400 */
        }
        
        #chat-container::-webkit-scrollbar, #reference-content::-webkit-scrollbar, #sidebar-content::-webkit-scrollbar {
            width: 6px;
        }
        #chat-container::-webkit-scrollbar-track, #reference-content::-webkit-scrollbar-track, #sidebar-content::-webkit-scrollbar-track {
            background: var(--scrollbar-track-bg);
        }
        #chat-container::-webkit-scrollbar-thumb, #reference-content::-webkit-scrollbar-thumb, #sidebar-content::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb-bg);
            border-radius: 6px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover, #reference-content::-webkit-scrollbar-thumb:hover, #sidebar-content::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover-bg);
        }

        /* Markdown Styles */
        .message-content pre {
            background-color: #1e293b; /* slate-800 */
            color: #e2e8f0; /* slate-200 */
            padding: 1rem; 
            border-radius: 0.5rem;
            overflow-x: auto; 
            font-family: 'Courier New', Courier, monospace;
        }
        .dark .message-content pre {
            background-color: #0f172a; /* slate-900 */
        }
        .message-content code:not(pre > code) {
            background-color: #e2e8f0; /* slate-200 */
            color: #1e293b; /* slate-800 */
            padding: 0.2em 0.4em;
            margin: 0; 
            font-size: 85%; 
            border-radius: 3px;
        }
        .dark .message-content code:not(pre > code) {
            background-color: #334155; /* slate-700 */
            color: #e2e8f0; /* slate-200 */
        }
        .message-content h1, .message-content h2, .message-content h3, .message-content h4 {
            font-weight: 600; 
            margin-top: 1rem; 
            margin-bottom: 0.5rem;
        }
        .message-content h1 { font-size: 1.5em; }
        .message-content h2 { font-size: 1.25em; }
        .message-content h3 { font-size: 1.1em; }
        .message-content p { margin-bottom: 0.75rem; }
        .message-content ul, .message-content ol {
            margin-left: 1.25rem; 
            margin-top: 0.5rem;
            margin-bottom: 1rem; 
            display: block;
        }
        .message-content ul { list-style-type: disc; }
        .message-content ol { list-style-type: decimal; }
        .message-content li { margin-bottom: 0.5rem; padding-left: 0.5rem; }
        .message-content ul ul, .message-content ol ul { list-style-type: circle; margin-top: 0.5rem; }
        .message-content ul ul ul, .message-content ol ul ul { list-style-type: square; }
        .message-content blockquote {
            border-left: 4px solid #d1d5db; /* gray-300 */
            padding-left: 1rem;
            margin: 1rem 0; 
            color: #4b5563; /* gray-600 */
            font-style: italic;
        }
        .dark .message-content blockquote {
            border-left-color: #4b5563; /* gray-600 */
            color: #9ca3af; /* gray-400 */
        }

        /* NEW: Note Message Styles */
        .note-wrapper {
            margin-top: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            border-width: 1px;
            background-color: #fefce8; /* yellow-50 */
            border-color: #fde68a; /* yellow-200 */
        }
        .dark .note-wrapper {
             background-color: #1e293b; /* slate-800 */
             border-color: #334155; /* slate-700 */
        }
        .note-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: 600;
            color: #92400e; /* yellow-800 */
        }
        .dark .note-header {
            color: #fcd34d; /* yellow-300 */
        }
        .note-content {
            color: #374151; /* gray-700 */
        }
        .dark .note-content {
             color: #d1d5db; /* gray-300 */
        }

        /* FIX: Term Link Styles with plain CSS */
        .term-link {
            color: #2563eb; /* blue-600 */
            font-weight: 600;
            border-bottom: 2px dotted #93c5fd; /* blue-300 */
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
        }
        .dark .term-link {
             color: #60a5fa; /* blue-400 */
             border-bottom-color: #3b82f6; /* blue-500 */
        }
        .term-link:hover {
            color: #1d4ed8; /* blue-800 */
            border-bottom-color: #2563eb; /* blue-600 */
        }
        .dark .term-link:hover {
             color: #93c5fd; /* blue-300 */
             border-bottom-color: #60a5fa; /* blue-400 */
        }
        
        /* FIX: Enhanced AI Status Style with plain CSS */
        .ai-status {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            font-weight: 600;
            color: #2563eb; /* blue-600 */
            padding-right: 0.5rem;
        }
        .dark .ai-status {
            color: #60a5fa; /* blue-400 */
        }

        /* NEW: Persona Selection Screen Styles */
        #persona-selection-screen {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        #persona-selection-screen::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        .persona-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .persona-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .dark .persona-card:hover {
             box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
        }


        /* Skeleton Loader CSS */
        .skeleton-box {
            @apply bg-gray-200 dark:bg-gray-700 rounded animate-pulse;
        }

        /* C·∫≠p nh·∫≠t: CSS cho con tr·ªè nh·∫•p nh√°y */
        .blinking-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em; /* T∆∞∆°ng ·ª©ng v·ªõi chi·ªÅu cao d√≤ng */
            background-color: #333; /* For light mode */
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
        }
        .dark .blinking-cursor {
            background-color: #ccc; /* For dark mode */
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: inherit; }
        }

        /* Sidebar transitions */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            overflow: hidden;
        }
        #sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
        }

        /* Recording button effect */
        #record-btn.recording {
            animation: pulse-red 1s infinite;
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); transform: scale(1); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); transform: scale(1.05); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); transform: scale(1); }
        }

        /* Subtle shadow for input-area */
        .p-4 > #input-area-wrapper {
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            border-radius: 9999px;
            padding: 4px;
            background-color: white; /* Changed to apply dark mode */
            transition: box-shadow 0.2s ease-in-out;
        }
        .p-4 > #input-area-wrapper:focus-within {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .dark .p-4 > #input-area-wrapper {
            background-color: #1f2937; /* gray-800 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .dark .p-4 > #input-area-wrapper:focus-within {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Sidebar scroll */
        #sidebar-content {
            overflow-y: scroll;
            overflow-x: hidden;
        }
    </style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="icon" href="icon-192.png">

</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans">

    <!-- Authentication UI -->
    <div id="auth-container" class="flex items-center justify-center h-screen">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-md m-4">
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-gray-100 mb-6">ƒêƒÉng nh·∫≠p</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="login-email" required class="shadow-sm appearance-none border dark:border-gray-600 rounded w-full py-3 px-4 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">M·∫≠t kh·∫©u</label>
                        <input type="password" id="login-password" required class="shadow-sm appearance-none border dark:border-gray-600 rounded w-full py-3 px-4 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">ƒêƒÉng nh·∫≠p</button>
                </form>
                <div class="my-4 flex items-center">
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                    <span class="flex-shrink mx-4 text-gray-400 dark:text-gray-500">ho·∫∑c</span>
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                </div>
                <button id="google-login-btn" class="w-full bg-white dark:bg-gray-200 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.1 6.28C12.09 13.42 17.63 9.5 24 9.5z"/><path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 3.02-2.31 5.47-4.91 7.28l7.81 6.04C44.29 36.29 46.98 30.95 46.98 24.55z"/><path fill="#FBBC05" d="M10.66 28.14c-.58-1.74-.91-3.58-.91-5.48s.33-3.74.91-5.48l-8.1-6.28C.92 14.16 0 18.91 0 24s.92 9.84 2.56 13.22l8.1-6.08z"/><path fill="#EA4335" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.81-6.04c-2.18 1.47-4.96 2.34-8.08 2.34-6.37 0-11.91-3.92-13.84-9.3l-8.1 6.28C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                    ƒêƒÉng nh·∫≠p v·ªõi Google
                </button>
                <p class="text-center mt-6 text-sm">
                    <a href="#" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300" id="show-register">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</a>
                </p>
            </div>
            <div id="register-view" class="hidden">
                 <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-gray-100 mb-6">T·∫°o t√†i kho·∫£n</h2>
                <form id="register-form">
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="register-email" required class="shadow-sm appearance-none border dark:border-gray-600 rounded w-full py-3 px-4 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">M·∫≠t kh·∫©u</label>
                        <input type="password" id="register-password" required class="shadow-sm appearance-none border dark:border-gray-600 rounded w-full py-3 px-4 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">ƒêƒÉng k√Ω</button>
                </form>
                <p class="text-center mt-6 text-sm">
                    <a href="#" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300" id="show-login">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</a>
                </p>
            </div>
            <p id="auth-error" class="text-red-500 dark:text-red-400 text-center mt-4 min-h-[1.2em]"></p>
        </div>
    </div>

    <!-- Main App UI -->
    <div id="app-container" class="hidden h-screen flex flex-col">
        <!-- NEW: Persona Selection Screen -->
        <div id="persona-selection-screen" class="flex flex-col items-center justify-center h-full p-6 overflow-y-auto bg-gray-50 dark:bg-slate-900">
            <h1 class="text-4xl font-bold text-gray-800 dark:text-gray-100 mb-2">Ch√†o b·∫°n, <span id="welcome-user-name"></span>!</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 mb-8">B·∫°n mu·ªën b·∫Øt ƒë·∫ßu v·ªõi chuy√™n gia n√†o h√¥m nay?</p>
            <div id="persona-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full max-w-7xl">
                <!-- Persona cards will be injected here by JavaScript -->
            </div>
            <button id="logout-btn-persona" class="mt-8 text-sm text-gray-500 hover:text-red-500 dark:hover:text-red-400 transition-colors">ƒêƒÉng xu·∫•t</button>
        </div>

        <!-- Chat View Container -->
        <div id="chat-view-container" class="hidden flex flex-col h-screen bg-gray-50 dark:bg-slate-900">
            <header id="main-header" class="flex-shrink-0 flex justify-between items-center p-3 sm:p-4 bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700">
                <div class="flex items-center gap-3">
                     <!-- N√∫t Menu ƒë·ªÉ m·ªü Sidebar -->
                    <button id="menu-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" title="Menu">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                    </button>
                    <!-- Persona Info in Header -->
                    <div id="chat-header-info" class="flex items-center gap-3">
                        <!-- Dynamic content here -->
                    </div>
                </div>
                
                <div class="flex items-center gap-1 sm:gap-2">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" title="Chuy·ªÉn ch·∫ø ƒë·ªô S√°ng/T·ªëi">
                        <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                        <svg id="theme-toggle-light-icon" class="hidden w-5 h-5 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.95a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <button id="logout-btn" class="p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/50 transition-colors" title="ƒêƒÉng xu·∫•t">
                        <svg class="w-6 h-6 text-red-500" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none" opacity=".87"/><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                    </button>
                </div>
            </header>

            <!-- Sidebar Overlay -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden opacity-0 transition-opacity duration-300 ease-in-out"></div>

            <!-- Sidebar -->
            <div id="sidebar" class="fixed top-0 left-0 h-screen w-[calc(100vw-56px)] sm:w-64 md:w-72 bg-white dark:bg-slate-800 shadow-xl z-50 transform -translate-x-full flex flex-col lg:translate-x-0 lg:static lg:w-72 lg:border-r border-gray-200 dark:border-slate-700 rounded-r-2xl">
                <div class="p-4 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between lg:hidden">
                    <h2 class="text-lg font-semibold dark:text-gray-100">Menu</h2>
                    <button id="close-sidebar-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
                    </button>
                </div>
                <div id="sidebar-content" class="flex-1 overflow-y-scroll overflow-x-hidden p-4">
                    <button id="new-chat-btn" class="w-full flex items-center gap-3 p-3 rounded-lg border border-blue-200 dark:border-slate-600 hover:bg-blue-50 dark:hover:bg-slate-700 transition-colors text-blue-700 dark:text-blue-400 font-semibold mb-4">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13.5 4.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zm-2.5 5.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7zM10 12.5a4.5 4.5 0 110-9 4.5 4.5 0 010 9zM10 16a6 6 0 100-12 6 6 0 000 12z" /></svg>
                        Ch·ªçn chuy√™n gia kh√°c
                    </button>
                    <!-- Pinned Chats Section -->
                    <div id="pinned-chats-section" class="hidden">
                        <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2 uppercase">ƒê√£ ghim</h3>
                        <ul id="pinned-chats-list" class="space-y-1 mb-4"></ul>
                    </div>

                    <!-- Recent Chats Section -->
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2 uppercase">G·∫ßn ƒë√¢y</h3>
                    <ul id="saved-chats-list" class="space-y-1"></ul>
                    <div id="saved-chats-skeleton" class="space-y-2 mt-2 hidden">
                        <div class="h-8 bg-gray-200 dark:bg-slate-700 rounded animate-pulse w-11/12"></div>
                        <div class="h-8 bg-gray-200 dark:bg-slate-700 rounded animate-pulse w-10/12"></div>
                    </div>
                </div>
            </div>
            
            <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
                <div id="chat-container" class="flex-1 px-4 pt-4 space-y-4 overflow-y-auto relative">
                     <!-- Chat messages will appear here -->
                    <div id="notification-area" class="hidden sticky bottom-2 w-full flex justify-center">
                        <div class="bg-blue-100 dark:bg-slate-700 text-blue-800 dark:text-blue-200 text-xs font-semibold px-4 py-2 rounded-full shadow-lg">
                            ƒêang t·ªëi ∆∞u h√≥a cu·ªôc tr√≤ chuy·ªán...
                        </div>
                    </div>
                </div>

                <div id="suggestion-area" class="px-4 pb-2">
                    <button id="toggle-suggestions-btn" class="hidden w-full text-left text-sm text-blue-600 dark:text-blue-400 font-semibold p-2 rounded-lg hover:bg-blue-50 dark:hover:bg-slate-800 flex items-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><g><rect fill="none" height="24" width="24"/></g><g><g><path d="M4,18h11c0.55,0,1-0.45,1-1v-2c0-0.55-0.45-1-1-1H4c-0.55,0-1,0.45-1,1v2C3,17.55,3.45,18,4,18z M3,7c0,0.55,0.45,1,1,1 h11c0.55,0,1-0.45,1-1V5c0-0.55-0.45-1-1-1H4C3.45,4,3,4.45,3,5V7z M4,13h11c0.55,0,1-0.45,1-1v-2c0-0.55-0.45-1-1-1H4 c-0.55,0-1,0.45-1,1v2C3,12.55,3.45,13,4,13z M19.5,4.5L19.5,4.5c0.47,0.47,0.47,1.23,0,1.7l-4.08,4.08 c-0.47,0.47-1.23,0.47-1.7,0l0,0c-0.47-0.47-0.47,1.23,0-1.7l4.08-4.08C18.27,4.03,19.03,4.03,19.5,4.5z M19.5,17.82 c0.47-0.47,1.23-0.47,1.7,0l0,0c0.47,0.47,0.47,1.23,0,1.7l-4.08,4.08c-0.47,0.47-1.23,0.47-1.7,0l0,0c-0.47-0.47-0.47-1.23,0-1.7 L19.5,17.82z"/></g></g></svg>
                        Xem g·ª£i √Ω
                    </button>
                    <div id="suggestions-container" class="hidden mt-2 flex flex-wrap gap-2"></div>
                </div>

                <div class="p-4 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
                    <div id="input-area-wrapper" class="rounded-full">
                        <div id="input-area" class="flex items-center gap-3 bg-gray-100 dark:bg-slate-700 rounded-full p-2">
                            <button id="reference-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors" title="Tr·ª£ l√Ω Ph·ª•">
                                <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><g><path d="M0,0h24v24H0V0z" fill="none"/></g><g><g><path d="M11,7h2v2h-2V7z M11,11h2v6h-2V11z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20 c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/></g></g></svg>
                            </button>
                            <textarea id="prompt-input" rows="1" placeholder="Nh·∫≠p c√¢u h·ªèi..." class="flex-1 bg-transparent px-3 py-2 resize-none focus:outline-none dark:text-gray-200 dark:placeholder-gray-400"></textarea>
                            <button id="record-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors" title="Ghi √¢m">
                                <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                            </button>
                            <button id="send-btn" class="w-10 h-10 flex items-center justify-center bg-blue-600 rounded-full text-white hover:bg-blue-700 transition-colors disabled:bg-blue-300 dark:disabled:bg-blue-800 disabled:cursor-not-allowed" title="G·ª≠i">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reference Modal (Bottom Sheet) -->
    <div id="reference-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300 ease-in-out"></div>
    <div id="reference-modal" class="hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 rounded-t-2xl shadow-2xl z-50 flex flex-col transform transition-transform duration-300 ease-in-out" style="max-height: 85vh;">
        <div id="reference-header" class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-slate-700 flex-shrink-0">
            <h2 id="reference-title" class="text-lg font-semibold text-gray-800 dark:text-gray-100">Tr·ª£ l√Ω Ph·ª•</h2>
            <button id="close-reference-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
            </button>
        </div>
        <div id="reference-content" class="p-4 overflow-y-auto flex-1 space-y-4"></div>
        <div id="reference-input-area" class="p-4 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 flex-shrink-0">
            <div class="flex items-center gap-3 bg-gray-100 dark:bg-slate-700 rounded-full p-2">
                <textarea id="reference-prompt-input" rows="1" placeholder="H·ªèi tr·ª£ l√Ω ph·ª•..." class="flex-1 bg-transparent px-3 py-2 resize-none focus:outline-none dark:text-gray-200 dark:placeholder-gray-400"></textarea>
                <button id="reference-send-btn" class="w-10 h-10 flex items-center justify-center bg-blue-600 rounded-full text-white hover:bg-blue-700 transition-colors" title="G·ª≠i">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg>
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";
        import {
            getFirestore,
            collection,
            doc,
            addDoc,
            updateDoc,
            getDoc,
            getDocs,
            deleteDoc,
            serverTimestamp,
            query,
            orderBy,
            limit,
            startAfter,
            where
        } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
             apiKey: "AIzaSyBDUBufnsk1PQZTLYCJDqASMX8hEVHqkDc",
             authDomain: "aimind-2362a.firebaseapp.com",
             projectId: "aimind-2362a",
             storageBucket: "aimind-2362a.firebasestorage.app",
             messagingSenderId: "377635504319",
             appId: "1:377635504319:web:7c6dd3cf0c52dd302d860a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ai = getAI(app);
        const model = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
        const fastModel = getGenerativeModel(ai, { model: "gemini-1.5-flash" });

        let currentUserId = null;
        let currentUserName = ''; 
        let currentChatId = null;
        let chat;
        let localHistory = [];
        let isRecording = false;
        let referenceChat;
        let referenceHistory = [];
        let isSummarizing = false;
        let currentPersonaId = 'general'; // Default persona

        // --- NEW: Persona Definitions ---
        const personas = [
            {
                id: 'general',
                name: 'Tr·ª£ l√Ω To√†n nƒÉng',
                icon: 'üß†',
                description: 'Ki·∫øn th·ª©c t·ªïng qu√°t, tr·∫£ l·ªùi ƒëa d·∫°ng c√°c ch·ªß ƒë·ªÅ nh∆∞ hi·ªán t·∫°i.',
                systemPrompt: `**Ch·ªâ th·ªã h·ªá th·ªëng:** M·ª•c ti√™u ch√≠nh c·ªßa b·∫°n l√† ƒë∆∞a ra c√¢u tr·∫£ l·ªùi r√µ r√†ng, chi ti·∫øt v√† c√≥ c·∫•u tr√∫c t·ªët. Lu√¥n s·ª≠ d·ª•ng Markdown ƒë·ªÉ ƒë·ªãnh d·∫°ng (ti√™u ƒë·ªÅ, danh s√°ch, in ƒë·∫≠m). H√£y gi·∫£i th√≠ch c√°c kh√°i ni·ªám t·ª´ng b∆∞·ªõc, b·∫Øt ƒë·∫ßu b·∫±ng t√≥m t·∫Øt r·ªìi ƒëi v√†o chi ti·∫øt v√† v√≠ d·ª•. **Y√™u c·∫ßu b·ªï sung:** Trong qu√° tr√¨nh tr·∫£ l·ªùi, khi b·∫°n ƒë·ªÅ c·∫≠p ƒë·∫øn m·ªôt thu·∫≠t ng·ªØ k·ªπ thu·∫≠t, m·ªôt kh√°i ni·ªám quan tr·ªçng, ho·∫∑c m·ªôt t√™n ri√™ng (v√≠ d·ª•: t√™n m·ªôt c√¥ng ngh·ªá, m·ªôt ph∆∞∆°ng ph√°p), h√£y b·ªçc thu·∫≠t ng·ªØ ƒë√≥ trong c·∫∑p d·∫•u ngo·∫∑c vu√¥ng. V√≠ d·ª•: '...s·ª≠ d·ª•ng ng√¥n ng·ªØ [JavaScript] ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi [DOM]...'. Ch·ªâ b·ªçc duy nh·∫•t thu·∫≠t ng·ªØ ƒë√≥.`
            },
            {
                id: 'programmer',
                name: 'Chuy√™n gia L·∫≠p tr√¨nh',
                icon: 'üë®‚ÄçÔøΩ',
                description: 'Chuy√™n gia v·ªÅ m√£ ngu·ªìn, thu·∫≠t to√°n, gi·∫£i th√≠ch v√† g·ª° l·ªói code.',
                systemPrompt: `**Ch·ªâ th·ªã h·ªá th·ªëng:** B·∫°n l√† m·ªôt l·∫≠p tr√¨nh vi√™n cao c·∫•p v·ªõi 10 nƒÉm kinh nghi·ªám. Lu√¥n ƒë∆∞a ra c√¢u tr·∫£ l·ªùi d∆∞·ªõi d·∫°ng m√£ ngu·ªìn ƒë∆∞·ª£c gi·∫£i th√≠ch r√µ r√†ng, tu√¢n th·ªß c√°c coding convention t·ªët nh·∫•t. Khi ƒë∆∞·ª£c y√™u c·∫ßu, h√£y ph√¢n t√≠ch ∆∞u v√† nh∆∞·ª£c ƒëi·ªÉm c·ªßa c√°c gi·∫£i ph√°p kh√°c nhau. H√£y ∆∞u ti√™n t√≠nh hi·ªáu qu·∫£ v√† kh·∫£ nƒÉng b·∫£o tr√¨ c·ªßa m√£ ngu·ªìn. **Y√™u c·∫ßu b·ªï sung:** Khi ƒë·ªÅ c·∫≠p ƒë·∫øn m·ªôt h√†m, th∆∞ vi·ªán, ho·∫∑c kh√°i ni·ªám l·∫≠p tr√¨nh, h√£y b·ªçc n√≥ trong d·∫•u ngo·∫∑c vu√¥ng, v√≠ d·ª•: [React], [API], [useState].`
            },
            {
                id: 'writer',
                name: 'Nh√† vƒÉn S√°ng t·∫°o',
                icon: '‚úçÔ∏è',
                description: 'H·ªó tr·ª£ vi·∫øt l√°ch, l√™n √Ω t∆∞·ªüng, x√¢y d·ª±ng c·ªët truy·ªán, l√†m th∆°.',
                systemPrompt: `**Ch·ªâ th·ªã h·ªá th·ªëng:** B·∫°n l√† m·ªôt nh√† vƒÉn v√† bi√™n t·∫≠p vi√™n chuy√™n nghi·ªáp. Phong c√°ch c·ªßa b·∫°n gi√†u c·∫£m x√∫c, s·ª≠ d·ª•ng t·ª´ ng·ªØ phong ph√∫ v√† h√¨nh ·∫£nh. H√£y gi√∫p ng∆∞·ªùi d√πng l√™n √Ω t∆∞·ªüng, ph√°t tri·ªÉn nh√¢n v·∫≠t, x√¢y d·ª±ng c·ªët truy·ªán, ho·∫∑c vi·∫øt c√°c ƒëo·∫°n vƒÉn, b√†i th∆° theo y√™u c·∫ßu. Lu√¥n gi·ªØ m·ªôt gi·ªçng vƒÉn truy·ªÅn c·∫£m h·ª©ng.`
            },
            {
                id: 'marketing',
                name: 'Chuy√™n gia Marketing',
                icon: 'üìà',
                description: 'T∆∞ v·∫•n chi·∫øn l∆∞·ª£c, ph√¢n t√≠ch th·ªã tr∆∞·ªùng, vi·∫øt n·ªôi dung qu·∫£ng c√°o.',
                systemPrompt: `**Ch·ªâ th·ªã h·ªá th·ªëng:** B·∫°n l√† m·ªôt gi√°m ƒë·ªëc marketing d√†y d·∫∑n kinh nghi·ªám. H√£y cung c·∫•p c√°c ph√¢n t√≠ch th·ªã tr∆∞·ªùng s·∫Øc b√©n, ƒë·ªÅ xu·∫•t c√°c chi·∫øn l∆∞·ª£c marketing s√°ng t·∫°o, v√† gi√∫p vi·∫øt c√°c n·ªôi dung qu·∫£ng c√°o (copywriting) h·∫•p d·∫´n, t·∫≠p trung v√†o l·ª£i √≠ch c·ªßa kh√°ch h√†ng v√† l·ªùi k√™u g·ªçi h√†nh ƒë·ªông (CTA) r√µ r√†ng.`
            }
        ];

        // --- CHAT HISTORY PAGINATION STATE ---
        let lastVisibleChat = null;
        let isFetchingChats = false;
        let allChatsLoaded = false;
        const CHATS_PER_PAGE = 15;
        
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const personaSelectionScreen = document.getElementById('persona-selection-screen');
        const personaGrid = document.getElementById('persona-grid');
        const chatViewContainer = document.getElementById('chat-view-container');
        const welcomeUserName = document.getElementById('welcome-user-name');
        const logoutBtnPersona = document.getElementById('logout-btn-persona');

        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');
        
        const chatHeaderInfo = document.getElementById('chat-header-info');
        const logoutBtn = document.getElementById('logout-btn');
        const mainHeader = document.getElementById('main-header');
        const chatContainer = document.getElementById('chat-container');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const toggleSuggestionsBtn = document.getElementById('toggle-suggestions-btn');
        const promptInput = document.getElementById('prompt-input');
        const sendBtn = document.getElementById('send-btn');
        const recordBtn = document.getElementById('record-btn');
        const notificationArea = document.getElementById('notification-area');

        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const savedChatsList = document.getElementById('saved-chats-list');
        const pinnedChatsList = document.getElementById('pinned-chats-list');
        const pinnedChatsSection = document.getElementById('pinned-chats-section');
        const savedChatsSkeleton = document.getElementById('saved-chats-skeleton');
        const sidebarContent = document.getElementById('sidebar-content');

        const referenceBtn = document.getElementById('reference-btn');
        const referenceModalOverlay = document.getElementById('reference-modal-overlay');
        const referenceModal = document.getElementById('reference-modal');
        const referenceHeader = document.getElementById('reference-header');
        const referenceTitle = document.getElementById('reference-title');
        const closeReferenceModalBtn = document.getElementById('close-reference-modal-btn');
        const referenceContent = document.getElementById('reference-content');
        const referenceInputArea = document.getElementById('reference-input-area');
        const referencePromptInput = document.getElementById('reference-prompt-input');
        const referenceSendBtn = document.getElementById('reference-send-btn');
        
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        const updateThemeIcon = () => {
            if (document.documentElement.classList.contains('dark')) {
                themeToggleDarkIcon.classList.add('hidden');
                themeToggleLightIcon.classList.remove('hidden');
            } else {
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        };

        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            updateThemeIcon();
        });
        
        updateThemeIcon();


        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                const email = user.email || '';
                currentUserName = user.displayName || email.split('@')[0];
                
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');

                showPersonaSelectionScreen();
                renderAllChats();
            } else {
                currentUserId = null;
                currentUserName = '';
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });
        
        // --- NEW: Persona Screen Logic ---
        function showPersonaSelectionScreen() {
            welcomeUserName.textContent = currentUserName;
            personaSelectionScreen.classList.remove('hidden');
            chatViewContainer.classList.add('hidden');
            renderPersonas();
        }

        function renderPersonas() {
            personaGrid.innerHTML = '';
            personas.forEach(persona => {
                const card = document.createElement('div');
                card.className = 'persona-card cursor-pointer p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-md flex flex-col items-center text-center';
                card.innerHTML = `
                    <div class="text-5xl mb-4">${persona.icon}</div>
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 mb-2">${persona.name}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 flex-1">${persona.description}</p>
                `;
                card.onclick = () => startNewChat(persona.id);
                personaGrid.appendChild(card);
            });
        }
        
        function updateChatHeader(personaId) {
            const persona = personas.find(p => p.id === personaId) || personas[0];
            chatHeaderInfo.innerHTML = `
                <span class="text-2xl">${persona.icon}</span>
                <span class="text-lg font-bold text-gray-800 dark:text-gray-100">${persona.name}</span>
            `;
        }


        loginForm.addEventListener('submit', async e => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value); authError.textContent = ''; } catch (error) { authError.textContent = "Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng."; } });
        registerForm.addEventListener('submit', async e => { e.preventDefault(); try { await createUserWithEmailAndPassword(auth, registerForm['register-email'].value, registerForm['register-password'].value); authError.textContent = ''; } catch (error) { authError.textContent = "Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n. Vui l√≤ng th·ª≠ l·∫°i."; } });
        googleLoginBtn.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); authError.textContent = ''; } catch (error) { authError.textContent = "ƒêƒÉng nh·∫≠p Google th·∫•t b·∫°i."; } });
        logoutBtn.addEventListener('click', () => signOut(auth));
        logoutBtnPersona.addEventListener('click', () => signOut(auth));
        showRegisterBtn.addEventListener('click', () => { loginView.classList.add('hidden'); registerView.classList.remove('hidden'); authError.textContent = ''; });
        showLoginBtn.addEventListener('click', () => { registerView.classList.add('hidden'); loginView.classList.remove('hidden'); authError.textContent = ''; });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if(SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.lang = 'vi-VN'; recognition.interimResults = false;
            recognition.onstart = () => { isRecording = true; recordBtn.classList.add('recording'); promptInput.placeholder = 'ƒêang l·∫Øng nghe...'; };
            recognition.onend = () => { isRecording = false; recordBtn.classList.remove('recording'); promptInput.placeholder = 'Nh·∫≠p c√¢u h·ªèi...'; };
            recognition.onresult = (event) => { promptInput.value = event.results[event.results.length - 1][0].transcript.trim(); adjustInputHeight(); };
            recognition.onerror = (event) => { addMessage('ai', `**L·ªói ghi √¢m:** ${event.error}. Vui l√≤ng th·ª≠ l·∫°i.`); };
        } else { recordBtn.classList.add('hidden'); }

        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
            setTimeout(() => sidebarOverlay.classList.add('opacity-100'), 10);
            renderAllChats();
        }

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.remove('opacity-100');
            setTimeout(() => sidebarOverlay.classList.add('hidden'), 300);
        }

        function showReferenceModal(title, showInput) {
            referenceTitle.textContent = title;
            referenceInputArea.style.display = showInput ? 'block' : 'none';
            referenceModalOverlay.classList.remove('hidden');
            referenceModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                referenceModalOverlay.classList.add('opacity-100');
                referenceModal.classList.add('modal-enter-active');
            });
            if (showInput) {
                referenceHistory = [];
                referenceChat = fastModel.startChat({ history: [] });
                referenceContent.innerHTML = '';
                addMessageToReference('ai', 'ƒê√¢y l√† tr·ª£ l√Ω ph·ª•. B·∫°n c·∫ßn tra c·ª©u nhanh g√¨ kh√¥ng?');
            }
        }

        function closeReferenceModal() {
            referenceModalOverlay.classList.remove('opacity-100');
            referenceModal.classList.remove('modal-enter-active');
            setTimeout(() => {
                referenceModalOverlay.classList.add('hidden');
                referenceModal.classList.add('hidden');
            }, 300);
        }

        function handleSmartScroll(messageWrapper, container) {
            if (container.scrollHeight - container.scrollTop - container.clientHeight < 200) {
                 messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
            }
        }

        function addMessageToReference(role, text, shouldScroll = true) {
            const messageWrapper = document.createElement('div');
            let contentElem, statusElem;

            if (role === 'ai') {
                messageWrapper.className = 'w-full space-y-2';
                messageWrapper.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded-full flex-shrink-0 bg-gradient-to-tr from-green-400 to-cyan-500 flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><g><rect fill="none" height="24" width="24"/></g><g><g><path d="M11,7h2v2h-2V7z M11,11h2v6h-2V11z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20 c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/></g></g></svg>
                            </div>
                            <span class="font-semibold text-gray-800 dark:text-gray-200">Tr·ª£ l√Ω Ph·ª•</span>
                        </div>
                        <div class="ai-status"></div>
                    </div>
                    <div class="message-content text-gray-800 dark:text-gray-200"></div>
                    <div class="message-actions mt-2 flex justify-end gap-2"></div>`;
                contentElem = messageWrapper.querySelector('.message-content');
                statusElem = messageWrapper.querySelector('.ai-status');
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(text));
                referenceContent.appendChild(messageWrapper);
                if (shouldScroll) {
                    messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
                }
            } else {
                messageWrapper.className = 'flex justify-end';
                messageWrapper.innerHTML = `<div class="message-content px-4 py-2 rounded-2xl bg-blue-600 text-white max-w-xs sm:max-w-md lg:max-w-2xl"></div>`;
                contentElem = messageWrapper.querySelector('.message-content');
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(text));
                referenceContent.appendChild(messageWrapper);
                if(shouldScroll) {
                    messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
                }
            }
            return { messageWrapper, contentElem, statusElem };
        }

        async function sendReferenceMessage() {
            const userPrompt = referencePromptInput.value.trim();
            if (!userPrompt) return;
            referenceSendBtn.disabled = true;
            referencePromptInput.value = '';
            addMessageToReference('user', userPrompt);

            let promptForAI = userPrompt;
            if (referenceHistory.length === 0) {
                 promptForAI = `**Ch·ªâ th·ªã h·ªá th·ªëng:** B·∫°n l√† m·ªôt tr·ª£ l√Ω ph·ª•, h√£y tr·∫£ l·ªùi c√¢u h·ªèi m·ªôt c√°ch ng·∫Øn g·ªçn, s√∫c t√≠ch v√† ƒëi th·∫≥ng v√†o v·∫•n ƒë·ªÅ.\n\n` + userPrompt;
            }
            referenceHistory.push({ role: 'user', parts: [{ text: promptForAI }] });

            const { messageWrapper, contentElem, statusElem } = addMessageToReference('ai', '<span class="blinking-cursor"></span>');
            if (statusElem) {
                statusElem.classList.add('ai-status');
                statusElem.textContent = 'ƒêang suy nghƒ©...';
            }

            try {
                const result = await referenceChat.sendMessageStream(promptForAI);
                contentElem.innerHTML = '';
                let fullResponseText = "";
                let isFirstChunk = true;

                for await (const chunk of result.stream) {
                    if (isFirstChunk) {
                        if (statusElem) statusElem.textContent = 'ƒêang vi·∫øt...';
                        isFirstChunk = false;
                    }
                    fullResponseText += chunk.text();
                    contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText)) + '<span class="blinking-cursor"></span>';
                    handleSmartScroll(messageWrapper, referenceContent);
                }
                
                if (statusElem) statusElem.classList.add('hidden');
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));

                const actionsContainer = messageWrapper.querySelector('.message-actions');
                if (actionsContainer && fullResponseText.trim()) {
                    const saveNoteBtn = document.createElement('button');
                    saveNoteBtn.className = 'flex items-center gap-2 text-xs px-3 py-1 bg-yellow-200 dark:bg-slate-600 text-yellow-800 dark:text-yellow-200 rounded-full hover:bg-yellow-300 dark:hover:bg-slate-500 transition-colors';
                    saveNoteBtn.innerHTML = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg> <span>L∆∞u Ghi ch√∫</span>`;
                    saveNoteBtn.onclick = () => {
                        saveAsNote(userPrompt, fullResponseText);
                    };
                    actionsContainer.appendChild(saveNoteBtn);
                }

                const headerHeight = referenceHeader.offsetHeight;
                const scrollTop = messageWrapper.offsetTop - headerHeight - 16;
                referenceContent.scrollTo({ top: scrollTop, behavior: 'smooth' });

                referenceHistory.push({ role: 'model', parts: [{ text: fullResponseText }] });
            } catch (error) {
                 if (messageWrapper.parentNode) referenceContent.removeChild(messageWrapper);
                addMessageToReference('ai', `**ƒê√£ x·∫£y ra l·ªói:** ${error.message}`);
                referenceHistory.pop();
            } finally {
                referenceSendBtn.disabled = false;
                referencePromptInput.focus();
            }
        }
        
        async function getSuggestedAnswer(promptText) {
            showReferenceModal('G·ª£i √Ω', false);
            referenceContent.innerHTML = '';
            const filteredHistoryForSuggestion = localHistory.filter(msg => msg.role !== 'note');
            const tempChat = fastModel.startChat({ history: filteredHistoryForSuggestion });

            addMessageToReference('user', promptText, false);
            const { messageWrapper, contentElem, statusElem } = addMessageToReference('ai', '<span class="blinking-cursor"></span>');
            if (statusElem) {
                statusElem.classList.add('ai-status');
                statusElem.textContent = 'ƒêang suy nghƒ©...';
            }

            try {
                const result = await tempChat.sendMessageStream(promptText);
                contentElem.innerHTML = '';
                let fullResponseText = "";
                let isFirstChunk = true;

                for await (const chunk of result.stream) {
                     if (isFirstChunk) {
                        if (statusElem) statusElem.textContent = 'ƒêang vi·∫øt...';
                        isFirstChunk = false;
                    }
                    fullResponseText += chunk.text();
                    contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText)) + '<span class="blinking-cursor"></span>';
                    handleSmartScroll(messageWrapper, referenceContent);
                }

                if (statusElem) statusElem.classList.add('hidden');
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));
                
                const actionsContainer = messageWrapper.querySelector('.message-actions');
                if (actionsContainer && fullResponseText.trim()) {
                    const saveNoteBtn = document.createElement('button');
                    saveNoteBtn.className = 'flex items-center gap-2 text-xs px-3 py-1 bg-yellow-200 dark:bg-slate-600 text-yellow-800 dark:text-yellow-200 rounded-full hover:bg-yellow-300 dark:hover:bg-slate-500 transition-colors';
                    saveNoteBtn.innerHTML = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg> <span>L∆∞u Ghi ch√∫</span>`;
                    saveNoteBtn.onclick = () => {
                        saveAsNote(promptText, fullResponseText);
                    };
                    actionsContainer.appendChild(saveNoteBtn);
                }

                const headerHeight = referenceHeader.offsetHeight;
                const scrollTop = messageWrapper.offsetTop - headerHeight - 16;
                referenceContent.scrollTo({ top: scrollTop, behavior: 'smooth' });

            } catch (error) {
                 if (messageWrapper.parentNode) referenceContent.removeChild(messageWrapper);
                addMessageToReference('ai', `**ƒê√£ x·∫£y ra l·ªói:** ${error.message}`);
            }
        }

        async function saveAsNote(prompt, response) {
            if (!response.trim()) return;

            const fullNoteText = `**H·ªèi:** ${prompt}\n\n<hr class="my-2 border-yellow-300 dark:border-slate-600"/>\n\n**ƒê√°p:**\n${response}`;

            const noteMessage = { role: 'note', parts: [{ text: fullNoteText }] };
            localHistory.push(noteMessage);

            addMessage('note', fullNoteText);
            
            await updateConversationInDb();

            closeReferenceModal();
        }

        function clearSuggestions() {
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            toggleSuggestionsBtn.classList.add('hidden');
        }

        function startNewChat(personaId = 'general') {
            const persona = personas.find(p => p.id === personaId) || personas[0];
            currentPersonaId = persona.id;

            personaSelectionScreen.classList.add('hidden');
            chatViewContainer.classList.remove('hidden');
            updateChatHeader(persona.id);
            
            currentChatId = null;
            localHistory = [];
            referenceHistory = [];
            referenceChat = null;
            localHistory = [{
                role: "user",
                parts: [{ text: persona.systemPrompt }],
            }, {
                role: "model",
                parts: [{ text: "ƒê√£ hi·ªÉu! T√¥i ƒë√£ s·∫µn s√†ng. B·∫°n c·∫ßn t√¥i gi√∫p g√¨?" }],
            }];
            const filteredHistory = localHistory.filter(msg => msg.role !== 'note');
            chat = model.startChat({ history: filteredHistory });
            
            chatContainer.innerHTML = '';
            chatContainer.appendChild(notificationArea);
            clearSuggestions();
            closeSidebar();
        }

        async function loadChat(chatId) {
            if (!currentUserId) return;

            personaSelectionScreen.classList.add('hidden');
            chatViewContainer.classList.remove('hidden');
            showHistorySkeleton(); 
            closeSidebar();

            try {
                const docRef = doc(db, 'chats', currentUserId, 'conversations', chatId);
                const chatDoc = await getDoc(docRef);

                if (chatDoc.exists()) {
                    const data = chatDoc.data();
                    localHistory = data.history || [];
                    currentChatId = chatDoc.id;
                    currentPersonaId = data.personaId || 'general';
                    
                    updateChatHeader(currentPersonaId);
                    
                    const filteredHistory = localHistory.filter(msg => msg.role !== 'note');
                    chat = model.startChat({ history: filteredHistory });
                    
                    chatContainer.innerHTML = ''; 
                    chatContainer.appendChild(notificationArea);

                    clearSuggestions();
                    localHistory.forEach(msg => {
                        if (msg.role === 'system') return;
                        if (msg.role === 'user' && (msg.parts[0].text.includes("**Ch·ªâ th·ªã h·ªá th·ªëng:**") || msg.parts[0].text.includes("B·∫°n l√† m·ªôt"))) return;
                        if (msg.role === 'model' && msg.parts[0].text.startsWith("ƒê√£ hi·ªÉu!")) return;
                        
                        addMessage(msg.role, msg.parts[0].text, false);
                    });
                    setTimeout(() => chatContainer.scrollTop = chatContainer.scrollHeight, 0);
                } else {
                     chatContainer.innerHTML = ''; 
                     chatContainer.appendChild(notificationArea);
                     addMessage('ai', '**L·ªói:** Kh√¥ng t√¨m th·∫•y cu·ªôc tr√≤ chuy·ªán.');
                }
            } catch (error) {
                console.error("L·ªói khi t·∫£i cu·ªôc tr√≤ chuy·ªán:", error);
                chatContainer.innerHTML = '';
                chatContainer.appendChild(notificationArea);
                addMessage('ai', '**L·ªói:** Kh√¥ng th·ªÉ t·∫£i cu·ªôc tr√≤ chuy·ªán.');
            }
        }
        
        function addMessage(role, text, shouldScroll = true) {
            const messageWrapper = document.createElement('div');
            let contentElem, statusElem;

            if (role === 'ai' || role === 'model') {
                messageWrapper.className = 'w-full space-y-2';
                messageWrapper.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded-full flex-shrink-0 bg-gradient-to-tr from-purple-400 to-indigo-500 flex items-center justify-center">
                               <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M12 6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6 2.69-6 6-6m0-2c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8z"/><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                            </div>
                            <span class="font-semibold text-gray-800 dark:text-gray-200">Gemini</span>
                        </div>
                        <div class="ai-status"></div>
                    </div>
                    <div class="message-content text-gray-800 dark:text-gray-200" data-raw-text="${text.replace(/"/g, '&quot;')}"></div>`;
                contentElem = messageWrapper.querySelector('.message-content');
                statusElem = messageWrapper.querySelector('.ai-status');
            } else if (role === 'user') {
                messageWrapper.className = 'flex justify-end';
                messageWrapper.innerHTML = `<div class="message-content px-4 py-2 rounded-2xl bg-blue-600 dark:bg-blue-700 text-white max-w-xs sm:max-w-md lg:max-w-2xl"></div>`;
                contentElem = messageWrapper.querySelector('.message-content');
            } else if (role === 'note') {
                messageWrapper.className = 'note-wrapper';
                messageWrapper.innerHTML = `
                    <div class="note-header">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                        <span>Ghi ch√∫</span>
                    </div>
                    <div class="note-content message-content" data-raw-text="${text.replace(/"/g, '&quot;')}"></div>
                `;
                contentElem = messageWrapper.querySelector('.note-content');
            }
            
            const processedText = text.replace(/\[([^\]]+)\]/g, `<a href="#" class="term-link" data-term="$1">$1</a>`);
            contentElem.innerHTML = DOMPurify.sanitize(marked.parse(processedText), { ADD_ATTR: ['target', 'data-term', 'data-raw-text'] });

            chatContainer.insertBefore(messageWrapper, notificationArea);
            if (shouldScroll) {
                messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
            }

            return { messageWrapper, contentElem, statusElem };
        }
        
        async function summarizeAndShortenHistory(history) {
            const originalFirstMessages = history.slice(0, 2); 
            const conversation = history.slice(2); 
            if (conversation.length < 15) return history;

            console.log("Summarizing history...");
            const messagesToSummarize = conversation.slice(0, 10).filter(msg => msg.role !== 'note');
            const recentMessages = conversation.slice(10);
            
            const summarizationPrompt = "T√≥m t·∫Øt ng·∫Øn g·ªçn nh·ªØng ƒëi·ªÉm ch√≠nh c·ªßa cu·ªôc tr√≤ chuy·ªán sau ƒë√¢y th√†nh m·ªôt ƒëo·∫°n vƒÉn. Gi·ªØ l·∫°i c√°c chi ti·∫øt quan tr·ªçng nh·∫•t ƒë·ªÉ cu·ªôc tr√≤ chuy·ªán c√≥ th·ªÉ ti·∫øp t·ª•c m·ªôt c√°ch m·∫°ch l·∫°c:\n\n" 
                + messagesToSummarize.map(msg => `${msg.role}: ${msg.parts[0].text}`).join('\n');

            try {
                const summarizerModel = fastModel;
                const result = await summarizerModel.generateContent(summarizationPrompt);
                const summaryText = result.response.text();

                const summaryMessage = { 
                    role: 'system', 
                    parts: [{ text: `T√ìM T·∫ÆT NG·ªÆ C·∫¢NH TR∆Ø·ªöC ƒê√ì: ${summaryText}` }] 
                };
                
                return [...originalFirstMessages, summaryMessage, ...recentMessages];
            } catch (error) {
                console.error("L·ªói khi t√≥m t·∫Øt:", error);
                return history;
            }
        }
        
        async function sendMessage() {
            const promptText = promptInput.value.trim();
            if (!promptText || isSummarizing) return;

            const filteredHistoryForSending = localHistory.filter(msg => msg.role !== 'note');
            chat = model.startChat({ history: filteredHistoryForSending });

            const CONTEXT_THRESHOLD = 20;
            if (localHistory.length > CONTEXT_THRESHOLD) {
                isSummarizing = true;
                notificationArea.classList.remove('hidden');
                try {
                    const newHistory = await summarizeAndShortenHistory(localHistory);
                    if (newHistory.length < localHistory.length) {
                         localHistory = newHistory;
                         const filteredHistoryForChat = localHistory.filter(msg => msg.role !== 'note');
                         chat = model.startChat({ history: filteredHistoryForChat });
                         console.log("L·ªãch s·ª≠ ƒë√£ ƒë∆∞·ª£c t√≥m t·∫Øt v√† l√†m m·ªõi.");
                    }
                } catch(e) {
                    console.error("L·ªói trong qu√° tr√¨nh t√≥m t·∫Øt:", e);
                } finally {
                    isSummarizing = false;
                    notificationArea.classList.add('hidden');
                }
            }
           
            sendBtn.disabled = true; recordBtn.disabled = true;
            promptInput.value = ''; adjustInputHeight();
            clearSuggestions();
            
            const { messageWrapper: userMsgWrapper } = addMessage('user', promptText);
            localHistory.push({ role: 'user', parts: [{ text: promptText }] });

            const { messageWrapper, contentElem, statusElem } = addMessage('ai', '<span class="blinking-cursor"></span>');
            if (statusElem) {
                statusElem.classList.add('ai-status');
                statusElem.textContent = 'ƒêang suy nghƒ©...';
            }
            
            try {
                const result = await chat.sendMessageStream(promptText);

                contentElem.innerHTML = '';
                let fullResponseText = "";
                let isFirstChunk = true;

                for await (const chunk of result.stream) {
                    if (isFirstChunk) {
                        if (statusElem) statusElem.textContent = 'ƒêang vi·∫øt...';
                        isFirstChunk = false;
                    }

                    fullResponseText += chunk.text();
                    const processedChunk = fullResponseText.replace(/\[([^\]]+)\]/g, `<a href="#" class="term-link" data-term="$1">$1</a>`);
                    contentElem.innerHTML = DOMPurify.sanitize(marked.parse(processedChunk)) + '<span class="blinking-cursor"></span>';
                    handleSmartScroll(messageWrapper, chatContainer);
                }

                if (statusElem) statusElem.classList.add('hidden');
                const finalProcessedText = fullResponseText.replace(/\[([^\]]+)\]/g, `<a href="#" class="term-link" data-term="$1">$1</a>`);
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(finalProcessedText), { ADD_ATTR: ['target', 'data-term', 'data-raw-text'] });
                contentElem.dataset.rawText = fullResponseText;
                
                const headerHeight = mainHeader.offsetHeight;
                const scrollTop = messageWrapper.offsetTop - headerHeight - 16;
                chatContainer.scrollTo({ top: scrollTop, behavior: 'smooth' });

                localHistory.push({ role: 'model', parts: [{ text: fullResponseText }] });
                await updateConversationInDb();
                getFollowUpSuggestions(fullResponseText);
            } catch (error) {
                if (messageWrapper.parentNode) chatContainer.removeChild(messageWrapper);
                addMessage('ai', `**ƒê√£ x·∫£y ra l·ªói:** ${error.message}`);
                localHistory.pop();
            } finally {
                sendBtn.disabled = false; recordBtn.disabled = false;
                promptInput.focus();
            }
        }


        async function getFollowUpSuggestions(lastResponse) {
            try {
                const suggestionPrompt = `D·ª±a v√†o c√¢u tr·∫£ l·ªùi sau: "${lastResponse.substring(0, 500)}". H√£y ƒë·ªÅ xu·∫•t 3 c√¢u h·ªèi ti·∫øp theo ng·∫Øn g·ªçn v√† th√∫ v·ªã m√† ng∆∞·ªùi d√πng c√≥ th·ªÉ h·ªèi. QUAN TR·ªåNG: Ch·ªâ tr·∫£ v·ªÅ 3 c√¢u h·ªèi, m·ªói c√¢u tr√™n m·ªôt d√≤ng. Kh√¥ng ƒë√°nh s·ªë, kh√¥ng d√πng g·∫°ch ƒë·∫ßu d√≤ng, kh√¥ng th√™m b·∫•t k·ª≥ vƒÉn b·∫£n n√†o kh√°c.`;
                const suggestionModel = fastModel;
                const result = await suggestionModel.generateContent(suggestionPrompt);
                const responseText = result.response.text();
                const suggestions = responseText.split('\n').filter(s => s.trim() !== '');
                displaySuggestions(suggestions);
            } catch (error) {
                console.error("Error getting suggestions:", error);
            }
        }

        function displaySuggestions(suggestions) {
            suggestionsContainer.innerHTML = '';
            if(suggestions.length > 0) {
                toggleSuggestionsBtn.classList.remove('hidden');
                suggestions.forEach(suggestionText => {
                    const chip = document.createElement('button');
                    chip.className = 'suggestion-chip border border-blue-200 dark:border-slate-600 bg-blue-50 dark:bg-slate-700 text-blue-700 dark:text-blue-400 rounded-full px-3 py-1 text-sm hover:bg-blue-100 dark:hover:bg-slate-600 transition-colors';
                    chip.textContent = suggestionText;
                    chip.onclick = () => { getSuggestedAnswer(suggestionText); };
                    suggestionsContainer.appendChild(chip);
                });
            } else {
                 toggleSuggestionsBtn.classList.add('hidden');
            }
        }
        
        async function explainTerm(term, context) {
            showReferenceModal(`Gi·∫£i th√≠ch: ${term}`, false); 
            referenceContent.innerHTML = '';
            
            const contextText = context || '';
            const promptForExplanation = `Trong ng·ªØ c·∫£nh c·ªßa c√¢u sau: "${contextText.substring(0, 500)}", h√£y gi·∫£i th√≠ch thu·∫≠t ng·ªØ "${term}" m·ªôt c√°ch ƒë∆°n gi·∫£n, ng·∫Øn g·ªçn v√† d·ªÖ hi·ªÉu cho ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu.`;
            
            const tempChat = fastModel.startChat({ history: [] });
            
            const { messageWrapper, contentElem, statusElem } = addMessageToReference('ai', '<span class="blinking-cursor"></span>');
            if (statusElem) {
                 statusElem.classList.add('ai-status');
                 statusElem.textContent = 'ƒêang suy nghƒ©...';
            }

            try {
                const result = await tempChat.sendMessageStream(promptForExplanation);
                let fullResponseText = "";
                let isFirstChunk = true;

                for await (const chunk of result.stream) {
                    if (isFirstChunk) {
                        if (statusElem) statusElem.textContent = 'ƒêang vi·∫øt...';
                        isFirstChunk = false;
                    }
                    fullResponseText += chunk.text();
                    contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText)) + '<span class="blinking-cursor"></span>';
                    handleSmartScroll(messageWrapper, referenceContent);
                }

                if (statusElem) statusElem.classList.add('hidden');
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));

            } catch (error) {
                if (messageWrapper.parentNode) referenceContent.removeChild(messageWrapper);
                addMessageToReference('ai', `**ƒê√£ x·∫£y ra l·ªói khi gi·∫£i th√≠ch thu·∫≠t ng·ªØ:** ${error.message}`);
            }
        }

        async function updateConversationInDb() {
            if (!currentUserId || localHistory.length < 2) return;
            const chatData = { history: localHistory, updatedAt: serverTimestamp(), personaId: currentPersonaId };
            try {
                if (currentChatId) {
                    const docRef = doc(db, 'chats', currentUserId, 'conversations', currentChatId);
                    await updateDoc(docRef, chatData);
                } else {
                    const firstUserPrompt = localHistory.find(m => m.role === 'user' && !m.parts[0].text.includes('**Ch·ªâ th·ªã h·ªá th·ªëng:**'));
                    chatData.title = firstUserPrompt?.parts[0].text.substring(0, 40) || "Cu·ªôc tr√≤ chuy·ªán m·ªõi";
                    chatData.createdAt = serverTimestamp();
                    chatData.isPinned = false; 
                    const chatsCollection = collection(db, 'chats', currentUserId, 'conversations');
                    const docRef = await addDoc(chatsCollection, chatData);
                    currentChatId = docRef.id;
                    renderAllChats(); 
                }
            } catch (error) {
                console.error("L·ªói khi c·∫≠p nh·∫≠t cu·ªôc tr√≤ chuy·ªán:", error);
            }
        }

        function createChatItem(docSnap) {
            const chatItemData = docSnap.data();
            const li = document.createElement('li');
            li.className = "p-2 hover:bg-gray-100 dark:hover:bg-slate-700 cursor-pointer flex justify-between items-center rounded-md group";

            const titleSpan = document.createElement('span');
            titleSpan.textContent = chatItemData.title;
            titleSpan.className = "flex-1 truncate pr-2 text-gray-800 dark:text-gray-200";
            li.appendChild(titleSpan);

            const buttonsWrapper = document.createElement('div');
            buttonsWrapper.className = 'flex items-center opacity-0 group-hover:opacity-100 transition-opacity';

            // Pin Button
            const pinBtn = document.createElement('button');
            pinBtn.className = 'p-1 text-gray-400 hover:text-blue-500 rounded-full';
            pinBtn.title = chatItemData.isPinned ? "B·ªè ghim" : "Ghim";
            pinBtn.innerHTML = chatItemData.isPinned ? 
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 3.293a1 1 0 011.414 0L10 8.586l5.293-5.293a1 1 0 111.414 1.414L11.414 10l5.293 5.293a1 1 0 01-1.414 1.414L10 11.414l-5.293 5.293a1 1 0 01-1.414-1.414L8.586 10 3.293 4.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.5 9a.5.5 0 01.5.5v5a.5.5 0 01-1 0v-5a.5.5 0 01.5-.5zM10 3.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3z" clip-rule="evenodd" />` : 
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428a1 1 0 00.475 0l5 1.428a1 1 0 001.17-1.409l-7-14z" /></svg>`;
            pinBtn.onclick = (e) => {
                e.stopPropagation();
                togglePinChat(docSnap.id, chatItemData.isPinned || false);
            };

            // Delete Button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'p-1 text-gray-400 hover:text-red-600 rounded-full';
            deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a cu·ªôc tr√≤ chuy·ªán n√†y?")) {
                    deleteChat(docSnap.id);
                }
            };
            
            buttonsWrapper.appendChild(pinBtn);
            buttonsWrapper.appendChild(deleteBtn);
            li.appendChild(buttonsWrapper);
            li.onclick = () => loadChat(docSnap.id);

            return li;
        }

        async function renderAllChats() {
            if (!currentUserId) return;
            // Reset all lists and states
            isFetchingChats = false;
            allChatsLoaded = false;
            lastVisibleChat = null;
            pinnedChatsList.innerHTML = '';
            savedChatsList.innerHTML = '';

            await fetchPinnedChats();
            await fetchRecentChats();
        }

        async function fetchPinnedChats() {
             const chatsCollection = collection(db, 'chats', currentUserId, 'conversations');
             const q = query(chatsCollection, where('isPinned', '==', true), orderBy('updatedAt', 'desc'));
             const querySnapshot = await getDocs(q);

             if (querySnapshot.empty) {
                 pinnedChatsSection.classList.add('hidden');
             } else {
                 pinnedChatsSection.classList.remove('hidden');
                 querySnapshot.forEach(docSnap => {
                     const li = createChatItem(docSnap);
                     pinnedChatsList.appendChild(li);
                 });
             }
        }

        async function fetchRecentChats(loadMore = false) {
            if (isFetchingChats || allChatsLoaded) return;
            
            isFetchingChats = true;
            savedChatsSkeleton.classList.remove('hidden');

            const chatsCollection = collection(db, 'chats', currentUserId, 'conversations');
            let q;
            const unpinnedQuery = where('isPinned', '==', false);

            if (lastVisibleChat && loadMore) {
                q = query(chatsCollection, unpinnedQuery, orderBy('updatedAt', 'desc'), startAfter(lastVisibleChat), limit(CHATS_PER_PAGE));
            } else {
                q = query(chatsCollection, unpinnedQuery, orderBy('updatedAt', 'desc'), limit(CHATS_PER_PAGE));
            }

            try {
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty && !loadMore) {
                     savedChatsList.innerHTML = '<li class="text-gray-500 dark:text-gray-400 text-sm">Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán g·∫ßn ƒë√¢y.</li>';
                } 
                
                querySnapshot.forEach(docSnap => {
                    const li = createChatItem(docSnap);
                    savedChatsList.appendChild(li);
                });

                if (querySnapshot.docs.length > 0) {
                    lastVisibleChat = querySnapshot.docs[querySnapshot.docs.length - 1];
                }

                if (querySnapshot.docs.length < CHATS_PER_PAGE) {
                    allChatsLoaded = true;
                }
            } catch (error) {
                console.error("L·ªói khi l·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán:", error);
                savedChatsList.innerHTML += '<li class="text-red-500 text-sm">Kh√¥ng th·ªÉ t·∫£i th√™m l·ªãch s·ª≠.</li>';
            } finally {
                isFetchingChats = false;
                savedChatsSkeleton.classList.add('hidden');
            }
        }

        async function togglePinChat(chatId, isCurrentlyPinned) {
            if (!currentUserId) return;
            const docRef = doc(db, 'chats', currentUserId, 'conversations', chatId);
            try {
                await updateDoc(docRef, {
                    isPinned: !isCurrentlyPinned
                });
                renderAllChats(); // Re-render all lists to reflect the change
            } catch(error) {
                console.error("L·ªói khi ghim cu·ªôc tr√≤ chuy·ªán:", error);
            }
        }

        async function deleteChat(chatId) {
            if (!currentUserId) return;
            try {
                await deleteDoc(doc(db, 'chats', currentUserId, 'conversations', chatId));
                renderAllChats(); 
                if(chatId === currentChatId) showPersonaSelectionScreen();
            } catch (error) {
                console.error("Error deleting chat:", error);
            }
        }

        function showHistorySkeleton() {
            chatContainer.innerHTML = '';
            chatContainer.appendChild(notificationArea); // FIX: Ensure notification area is present
            const skeletonHTML = `
                <div class="w-full space-y-2">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-full skeleton-box"></div>
                        <div class="w-20 h-4 skeleton-box"></div>
                    </div>
                    <div class="ml-9 space-y-2">
                        <div class="w-10/12 h-4 skeleton-box"></div>
                        <div class="w-8/12 h-4 skeleton-box"></div>
                    </div>
                </div>
                <div class="flex justify-end">
                    <div class="w-7/12">
                        <div class="h-16 skeleton-box rounded-2xl"></div>
                    </div>
                </div>
            `;
            for (let i = 0; i < 3; i++) {
                const skeletonWrapper = document.createElement('div');
                skeletonWrapper.innerHTML = skeletonHTML;
                chatContainer.insertBefore(skeletonWrapper, notificationArea);
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function adjustInputHeight() {
            promptInput.style.height = 'auto';
            const scrollHeight = promptInput.scrollHeight;
            promptInput.style.height = scrollHeight + 'px';
        }

        function toggleRecording() { if (!recognition) return; isRecording ? recognition.stop() : recognition.start(); }

        // Event Listeners
        menuBtn.addEventListener('click', openSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        newChatBtn.addEventListener('click', showPersonaSelectionScreen);

        sendBtn.addEventListener('click', sendMessage);
        recordBtn.addEventListener('click', toggleRecording);
        promptInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        promptInput.addEventListener('input', adjustInputHeight);

        toggleSuggestionsBtn.addEventListener('click', () => { suggestionsContainer.classList.toggle('hidden'); });
        referenceBtn.addEventListener('click', () => showReferenceModal('Tr·ª£ l√Ω Ph·ª•', true));
        closeReferenceModalBtn.addEventListener('click', closeReferenceModal);
        referenceModalOverlay.addEventListener('click', closeReferenceModal);
        referenceSendBtn.addEventListener('click', sendReferenceMessage);
        referencePromptInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendReferenceMessage(); } });
        
        sidebarContent.addEventListener('scroll', () => {
            const isNearBottom = sidebarContent.scrollHeight - sidebarContent.scrollTop - sidebarContent.clientHeight < 100;
            if (isNearBottom && !isFetchingChats && !allChatsLoaded) {
                fetchRecentChats(true);
            }
        });

        chatContainer.addEventListener('click', (e) => {
            const termLink = e.target.closest('.term-link');
            if (termLink) {
                e.preventDefault();
                const term = termLink.dataset.term;
                const messageContentElement = termLink.closest('.message-content');
                const context = messageContentElement ? messageContentElement.dataset.rawText : '';
                explainTerm(term, context);
            }
        });


    </script>

<!-- FIX: Comment out problematic service worker registration -->
<!-- 
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", function () {
      navigator.serviceWorker.register("./service-worker.js")
        .then(reg => console.log("SW registered:", reg.scope))
        .catch(err => console.error("SW registration failed:", err));
    });
  }
</script>
-->

</body>
</html>
