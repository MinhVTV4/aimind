<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
    <script>
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        :root {
            --scrollbar-track-bg: #f1f1f1;
            --scrollbar-thumb-bg: #888;
            --scrollbar-thumb-hover-bg: #555;
        }
        .dark {
            --scrollbar-track-bg: #2d3748;
            --scrollbar-thumb-bg: #718096;
            --scrollbar-thumb-hover-bg: #a0aec0;
        }
        body {
            overflow-x: hidden;
        }
        #chat-container::-webkit-scrollbar, #reference-content::-webkit-scrollbar, #sidebar-content::-webkit-scrollbar, #summary-content::-webkit-scrollbar {
            width: 6px;
        }
        #chat-container::-webkit-scrollbar-track, #reference-content::-webkit-scrollbar-track, #sidebar-content::-webkit-scrollbar-track, #summary-content::-webkit-scrollbar-track {
            background: var(--scrollbar-track-bg);
        }
        #chat-container::-webkit-scrollbar-thumb, #reference-content::-webkit-scrollbar-thumb, #sidebar-content::-webkit-scrollbar-thumb, #summary-content::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb-bg);
            border-radius: 6px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover, #reference-content::-webkit-scrollbar-thumb:hover, #sidebar-content::-webkit-scrollbar-thumb:hover, #summary-content::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover-bg);
        }
        .message-content pre { background-color: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-family: 'Courier New', Courier, monospace; }
        .dark .message-content pre { background-color: #0f172a; }
        .message-content code:not(pre > code) { background-color: #e2e8f0; color: #1e293b; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
        .dark .message-content code:not(pre > code) { background-color: #334155; color: #e2e8f0; }
        .message-content h1, .message-content h2, .message-content h3, .message-content h4 { font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        .message-content h1 { font-size: 1.5em; }
        .message-content h2 { font-size: 1.25em; }
        .message-content h3 { font-size: 1.1em; }
        .message-content p { margin-bottom: 0.75rem; }
        .message-content ul, .message-content ol { margin-left: 1.25rem; margin-top: 0.5rem; margin-bottom: 1rem; display: block; }
        .message-content ul { list-style-type: disc; }
        .message-content ol { list-style-type: decimal; }
        .message-content li { margin-bottom: 0.5rem; padding-left: 0.5rem; }
        .message-content blockquote { border-left: 4px solid #d1d5db; padding-left: 1rem; margin: 1rem 0; color: #4b5563; font-style: italic; }
        .dark .message-content blockquote { border-left-color: #4b5563; color: #9ca3af; }
        .note-wrapper { margin-top: 1rem; margin-bottom: 1rem; padding: 1rem; border-radius: 0.5rem; border-width: 1px; background-color: #fefce8; border-color: #fde68a; }
        .dark .note-wrapper { background-color: #1e293b; border-color: #334155; }
        .note-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.875rem; line-height: 1.25rem; font-weight: 600; color: #92400e; }
        .dark .note-header { color: #fcd34d; }
        .note-content { color: #374151; }
        .dark .note-content { color: #d1d5db; }
        .summary-wrapper { margin-top: 1rem; margin-bottom: 1rem; padding: 1rem; border-radius: 0.5rem; border-width: 1px; background-color: #faf5ff; border-color: #e9d5ff; }
        .dark .summary-wrapper { background-color: #3b0764; border-color: #5b21b6; }
        .summary-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.875rem; line-height: 1.25rem; font-weight: 600; color: #7e22ce; }
        .dark .summary-header { color: #c084fc; }
        .summary-content { color: #374151; }
        .dark .summary-content { color: #d1d5db; }
        .term-link { color: #2563eb; font-weight: 600; border-bottom: 2px dotted #93c5fd; cursor: pointer; transition: color 0.2s, border-color 0.2s; }
        .dark .term-link { color: #60a5fa; border-bottom-color: #3b82f6; }
        .term-link:hover { color: #1d4ed8; border-bottom-color: #2563eb; }
        .dark .term-link:hover { color: #93c5fd; border-bottom-color: #60a5fa; }
        .ai-status { font-size: 0.875rem; line-height: 1.25rem; font-weight: 600; color: #2563eb; padding-right: 0.5rem; }
        .dark .ai-status { color: #60a5fa; }
        #persona-selection-screen { -ms-overflow-style: none; scrollbar-width: none; }
        #persona-selection-screen::-webkit-scrollbar { display: none; }
        .persona-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; position: relative; }
        .persona-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .dark .persona-card:hover { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3); }
        .skeleton-box { @apply bg-gray-200 dark:bg-gray-700 rounded animate-pulse; }
        .blinking-cursor { display: inline-block; width: 8px; height: 1.2em; background-color: #333; animation: blink 1s step-end infinite; vertical-align: text-bottom; }
        .dark .blinking-cursor { background-color: #ccc; }
        @keyframes blink { from, to { background-color: transparent; } 50% { background-color: inherit; } }
        #sidebar { transition: transform 0.3s ease-in-out; overflow: hidden; }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #record-btn.recording { animation: pulse-red 1s infinite; background-color: #ef4444; color: white; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); transform: scale(1); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); transform: scale(1.05); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); transform: scale(1); } }
        .p-4 > #input-area-wrapper { box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04); border-radius: 9999px; padding: 4px; background-color: white; transition: box-shadow 0.2s ease-in-out; }
        .p-4 > #input-area-wrapper:focus-within { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); }
        .dark .p-4 > #input-area-wrapper { background-color: #1f2937; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); }
        .dark .p-4 > #input-area-wrapper:focus-within { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
        #sidebar-content { overflow-y: scroll; overflow-x: hidden; }
        #persona-modal-overlay { transition: opacity 0.3s ease-in-out; }
        #persona-modal { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; max-height: 90vh; }
        .custom-persona-actions { position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .persona-card:hover .custom-persona-actions { opacity: 1; }
        .welcome-suggestion-card {
            transition: background-color 0.2s ease-in-out;
        }
        .welcome-suggestion-card:hover {
            background-color: #eef2ff; /* indigo-50 */
        }
        .dark .welcome-suggestion-card:hover {
            background-color: #374151; /* gray-700 */
        }
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        .animate-spin {
          animation: spin 1s linear infinite;
        }
        /* Toast styles */
        .toast {
            transition: all 0.4s ease-in-out;
            opacity: 0;
            transform: translateX(100%);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.hide {
            opacity: 0;
            transform: translateX(120%);
        }
    </style>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="icon" href="icon-192.png">
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans overflow-x-hidden">

    <!-- Authentication UI -->
    <div id="auth-container" class="flex items-center justify-center h-screen">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-md m-4">
            <div id="login-view">
                <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-gray-100 mb-6">ƒêƒÉng nh·∫≠p</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="login-email" required class="shadow-sm appearance-none border dark:border-gray-600 rounded w-full py-3 px-4 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">M·∫≠t kh·∫©u</label>
                        <input type="password" id="login-password" required class="shadow-sm appearance-none border dark:border-gray-600 rounded w-full py-3 px-4 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">ƒêƒÉng nh·∫≠p</button>
                </form>
                <div class="my-4 flex items-center">
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                    <span class="flex-shrink mx-4 text-gray-400 dark:text-gray-500">ho·∫∑c</span>
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                </div>
                <button id="google-login-btn" class="w-full bg-white dark:bg-gray-200 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.1 6.28C12.09 13.42 17.63 9.5 24 9.5z"/><path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 3.02-2.31 5.47-4.91 7.28l7.81 6.04C44.29 36.29 46.98 30.95 46.98 24.55z"/><path fill="#FBBC05" d="M10.66 28.14c-.58-1.74-.91-3.58-.91-5.48s.33-3.74.91-5.48l-8.1-6.28C.92 14.16 0 18.91 0 24s.92 9.84 2.56 13.22l8.1-6.08z"/><path fill="#EA4335" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.81-6.04c-2.18 1.47-4.96 2.34-8.08 2.34-6.37 0-11.91-3.92-13.84-9.3l-8.1 6.28C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                    ƒêƒÉng nh·∫≠p v·ªõi Google
                </button>
                <p class="text-center mt-6 text-sm">
                    <a href="#" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300" id="show-register">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</a>
                </p>
            </div>
            <div id="register-view" class="hidden">
                 <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-gray-100 mb-6">T·∫°o t√†i kho·∫£n</h2>
                <form id="register-form">
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="register-email" required class="shadow-sm appearance-none border dark:border-gray-600 rounded w-full py-3 px-4 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">M·∫≠t kh·∫©u</label>
                        <input type="password" id="register-password" required class="shadow-sm appearance-none border dark:border-gray-600 rounded w-full py-3 px-4 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">ƒêƒÉng k√Ω</button>
                </form>
                <p class="text-center mt-6 text-sm">
                    <a href="#" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300" id="show-login">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</a>
                </p>
            </div>
            <p id="auth-error" class="text-red-500 dark:text-red-400 text-center mt-4 min-h-[1.2em]"></p>
        </div>
    </div>

    <!-- Main App UI -->
    <div id="app-container" class="hidden h-screen flex overflow-hidden">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden opacity-0 transition-opacity duration-300 ease-in-out lg:hidden"></div>
        
        <!-- Sidebar -->
        <div id="sidebar" class="fixed top-0 left-0 h-screen w-[calc(100vw-56px)] sm:w-64 md:w-72 bg-white dark:bg-slate-800 shadow-xl z-50 transform -translate-x-full flex flex-col lg:translate-x-0 lg:static lg:w-72 lg:border-r rounded-r-2xl border-gray-200 dark:border-slate-700">
            <div class="p-4 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between lg:hidden">
                <h2 class="text-lg font-semibold dark:text-gray-100">Menu</h2>
                <button id="close-sidebar-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
                </button>
            </div>
            <div id="sidebar-content" class="flex-1 overflow-y-scroll overflow-x-hidden p-4">
                <button id="new-chat-btn" class="w-full flex items-center gap-3 p-3 rounded-lg border border-blue-200 dark:border-slate-600 hover:bg-blue-50 dark:hover:bg-slate-700 transition-colors text-blue-700 dark:text-blue-400 font-semibold mb-4">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13.5 4.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zm-2.5 5.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7zM10 12.5a4.5 4.5 0 110-9 4.5 4.5 0 010 9zM10 16a6 6 0 100-12 6 6 0 000 12z" /></svg>
                    Ch·ªçn chuy√™n gia kh√°c
                </button>
                <div id="pinned-chats-section" class="hidden">
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2 uppercase">ƒê√£ ghim</h3>
                    <ul id="pinned-chats-list" class="space-y-1 mb-4"></ul>
                </div>
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2 uppercase">G·∫ßn ƒë√¢y</h3>
                <ul id="saved-chats-list" class="space-y-1"></ul>
                <div id="saved-chats-skeleton" class="space-y-2 mt-2 hidden">
                    <div class="h-8 bg-gray-200 dark:bg-slate-700 rounded animate-pulse w-11/12"></div>
                    <div class="h-8 bg-gray-200 dark:bg-slate-700 rounded animate-pulse w-10/12"></div>
                </div>
            </div>
        </div>
        
        <div class="flex-1 flex flex-col overflow-x-hidden">
            <!-- Persona Selection Screen -->
            <div id="persona-selection-screen" class="flex flex-col items-center h-full p-4 sm:p-6 overflow-y-auto bg-gray-50 dark:bg-slate-900">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-gray-100 mb-2">Ch√†o b·∫°n, <span id="welcome-user-name"></span>!</h1>
                <p class="text-base sm:text-lg text-gray-600 dark:text-gray-400 mb-6 sm:mb-8">B·∫°n mu·ªën b·∫Øt ƒë·∫ßu v·ªõi chuy√™n gia n√†o h√¥m nay?</p>
                
                <div class="w-full max-w-7xl">
                    <div class="mb-6 sm:mb-8">
                        <button id="create-persona-btn" class="w-full sm:w-auto flex items-center justify-center gap-2 px-4 py-2 sm:px-6 sm:py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                            T·∫°o Persona M·ªõi
                        </button>
                    </div>

                    <div id="custom-personas-section" class="mb-10">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-700 dark:text-gray-300 mb-4 border-b pb-2 dark:border-gray-700">Persona c·ªßa b·∫°n</h2>
                        <div id="custom-persona-grid" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                         <p id="no-custom-persona-msg" class="text-gray-500 dark:text-gray-400 hidden">B·∫°n ch∆∞a t·∫°o persona n√†o. H√£y t·∫°o m·ªôt chuy√™n gia AI cho ri√™ng m√¨nh!</p>
                    </div>

                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-700 dark:text-gray-300 mb-4 border-b pb-2 dark:border-gray-700">Persona m·∫∑c ƒë·ªãnh</h2>
                        <div id="default-persona-grid" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                    </div>
                </div>
                <button id="logout-btn-persona" class="mt-8 text-sm text-gray-500 hover:text-red-500 dark:hover:text-red-400 transition-colors">ƒêƒÉng xu·∫•t</button>
            </div>

            <!-- Chat View Container -->
            <div id="chat-view-container" class="hidden flex-col h-full bg-gray-50 dark:bg-slate-900">
                <header id="main-header" class="flex-shrink-0 flex justify-between items-center p-3 sm:p-4 bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700">
                    <div class="flex items-center gap-3">
                        <button id="menu-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors lg:hidden" title="Menu">
                            <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                        </button>
                        <div id="chat-header-info" class="flex items-center gap-3"></div>
                        <button id="summarize-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" title="T√≥m t·∫Øt cu·ªôc tr√≤ chuy·ªán">
                           <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm0 5.25a.75.75 0 01.75-.75h9.5a.75.75 0 010 1.5h-9.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
                        </button>
                        <button id="new-topic-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" title="Tr√≤ chuy·ªán m·ªõi">
                            <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    
                    <div class="flex items-center gap-1 sm:gap-2">
                        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors" title="Chuy·ªÉn ch·∫ø ƒë·ªô S√°ng/T·ªëi">
                            <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                            <svg id="theme-toggle-light-icon" class="hidden w-5 h-5 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.95a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" clip-rule="evenodd"></path></svg>
                        </button>
                        <button id="logout-btn" class="p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/50 transition-colors" title="ƒêƒÉng xu·∫•t">
                            <svg class="w-6 h-6 text-red-500" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none" opacity=".87"/><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                        </button>
                    </div>
                </header>

                <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
                    <div id="welcome-screen" class="flex-1 flex-col items-center justify-center p-4 text-center hidden">
                        <div id="welcome-persona-icon" class="text-6xl mb-4"></div>
                        <h2 id="welcome-persona-name" class="text-2xl font-bold text-gray-800 dark:text-gray-200"></h2>
                        <p id="welcome-persona-description" class="max-w-md mt-2 text-gray-600 dark:text-gray-400"></p>
                        <div id="welcome-suggestions-container" class="mt-8 w-full max-w-2xl mx-auto space-y-3">
                        </div>
                    </div>
                    
                    <div id="chat-container" class="flex-1 px-4 pt-4 space-y-4 overflow-y-auto relative hidden">
                        <div id="notification-area" class="hidden sticky bottom-2 w-full flex justify-center">
                            <div class="bg-blue-100 dark:bg-slate-700 text-blue-800 dark:text-blue-200 text-xs font-semibold px-4 py-2 rounded-full shadow-lg">
                                ƒêang t·ªëi ∆∞u h√≥a cu·ªôc tr√≤ chuy·ªán...
                            </div>
                        </div>
                    </div>

                    <div id="suggestion-area" class="px-4 pb-2">
                        <button id="toggle-suggestions-btn" class="hidden w-full text-left text-sm text-blue-600 dark:text-blue-400 font-semibold p-2 rounded-lg hover:bg-blue-50 dark:hover:bg-slate-800 flex items-center gap-2">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><g><rect fill="none" height="24" width="24"/></g><g><g><path d="M4,18h11c0.55,0,1-0.45,1-1v-2c0-0.55-0.45-1-1-1H4c-0.55,0-1,0.45-1,1v2C3,17.55,3.45,18,4,18z M3,7c0,0.55,0.45,1,1,1 h11c0.55,0,1-0.45,1-1V5c0-0.55-0.45-1-1-1H4C3.45,4,3,4.45,3,5V7z M4,13h11c0.55,0,1-0.45,1-1v-2c0-0.55-0.45-1-1-1H4 c-0.55,0-1,0.45-1,1v2C3,12.55,3.45,13,4,13z M19.5,4.5L19.5,4.5c0.47,0.47,0.47,1.23,0,1.7l-4.08,4.08 c-0.47,0.47-1.23,0.47-1.7,0l0,0c-0.47-0.47-0.47,1.23,0-1.7l4.08-4.08C18.27,4.03,19.03,4.03,19.5,4.5z M19.5,17.82 c0.47-0.47,1.23-0.47,1.7,0l0,0c0.47,0.47,0.47,1.23,0,1.7l-4.08,4.08c-0.47,0.47-1.23,0.47-1.7,0l0,0c-0.47-0.47-0.47,1.23,0-1.7 L19.5,17.82z"/></g></g></svg>
                            Xem g·ª£i √Ω
                        </button>
                        <div id="suggestions-container" class="hidden mt-2 flex flex-wrap gap-2"></div>
                    </div>

                    <div class="p-4 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
                        <div id="input-area-wrapper" class="rounded-full">
                            <div id="input-area" class="flex items-center gap-3 bg-gray-100 dark:bg-slate-700 rounded-full p-2">
                                <button id="reference-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors" title="Tr·ª£ l√Ω Ph·ª•">
                                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><g><path d="M0,0h24v24H0V0z" fill="none"/></g><g><g><path d="M11,7h2v2h-2V7z M11,11h2v6h-2V11z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20 c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/></g></g></svg>
                                </button>
                                <textarea id="prompt-input" rows="1" placeholder="Nh·∫≠p c√¢u h·ªèi..." class="flex-1 bg-transparent px-3 py-2 resize-none focus:outline-none dark:text-gray-200 dark:placeholder-gray-400"></textarea>
                                <button id="record-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors" title="Ghi √¢m">
                                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                                </button>
                                <button id="send-btn" class="w-10 h-10 flex items-center justify-center bg-blue-600 rounded-full text-white hover:bg-blue-700 transition-colors disabled:bg-blue-300 dark:disabled:bg-blue-800 disabled:cursor-not-allowed" title="G·ª≠i">
                                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Persona Creation/Edit Modal -->
    <div id="persona-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 z-40"></div>
    <div id="persona-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl bg-white dark:bg-slate-800 rounded-2xl shadow-2xl z-50 flex flex-col transform scale-95 opacity-0">
        <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-slate-700 flex-shrink-0">
            <h2 id="persona-modal-title" class="text-lg font-semibold text-gray-800 dark:text-gray-100">T·∫°o Chuy√™n gia AI c·ªßa b·∫°n</h2>
            <button id="close-persona-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
            </button>
        </div>
        <div class="p-6 overflow-y-auto flex-1">
            <form id="persona-form" class="space-y-4">
                <input type="hidden" id="persona-id">
                <div>
                    <label for="persona-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">T√™n Persona</label>
                    <input type="text" id="persona-name" required class="block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="persona-icon" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bi·ªÉu t∆∞·ª£ng (Emoji)</label>
                    <input type="text" id="persona-icon" required maxlength="2" class="block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="persona-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">M√¥ t·∫£ ng·∫Øn</label>
                    <textarea id="persona-description" rows="2" required class="block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm resize-none"></textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between">
                         <label for="persona-prompt" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ch·ªâ th·ªã H·ªá th·ªëng (System Prompt)</label>
                         <button type="button" id="generate-prompt-btn" class="p-1 rounded-full text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-slate-700" title="G·ª£i √Ω t·ª´ AI">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 3zM3.05 4.29a.75.75 0 010 1.06l-1.06 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm12.84 1.06a.75.75 0 011.06 0l1.06 1.06a.75.75 0 11-1.06-1.06l-1.06-1.06a.75.75 0 010-1.06zM10 15a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 15zM4.11 15.89a.75.75 0 011.06 0l1.06-1.06a.75.75 0 111.06 1.06l-1.06 1.06a.75.75 0 01-1.06 0l-1.06-1.06a.75.75 0 010-1.06zM15.89 15.89a.75.75 0 010 1.06l-1.06 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zM3 10a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 013 10zM15 10a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 0115 10zM10 6a4 4 0 100 8 4 4 0 000-8z" clip-rule="evenodd" /></svg>
                         </button>
                    </div>
                    <textarea id="persona-prompt" rows="6" required class="block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm resize-y"></textarea>
                    <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">ƒê√¢y l√† ch·ªâ d·∫´n c·ªët l√µi cho AI, quy·∫øt ƒë·ªãnh vai tr√≤ v√† phong c√°ch c·ªßa n√≥.</p>
                </div>
            </form>
        </div>
        <div class="flex justify-end items-center p-4 bg-gray-50 dark:bg-slate-900/50 border-t border-gray-200 dark:border-slate-700 flex-shrink-0 rounded-b-2xl">
            <button id="cancel-persona-btn" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 mr-3">H·ªßy</button>
            <button id="save-persona-btn" type="submit" form="persona-form" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">L∆∞u Persona</button>
        </div>
    </div>

    <!-- Reference Modal -->
    <div id="reference-modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>
    <div id="reference-modal" class="hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 rounded-t-2xl shadow-2xl z-50 flex flex-col transform transition-transform duration-300 ease-in-out" style="max-height: 85vh;">
        <div id="reference-header" class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-slate-700 flex-shrink-0">
            <h2 id="reference-title" class="text-lg font-semibold text-gray-800 dark:text-gray-100">Tr·ª£ l√Ω Ph·ª•</h2>
            <button id="close-reference-modal-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
            </button>
        </div>
        <div id="reference-content" class="p-4 overflow-y-auto flex-1 space-y-4"></div>
        <div id="reference-input-area" class="p-4 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 flex-shrink-0">
            <div class="flex items-center gap-3 bg-gray-100 dark:bg-slate-700 rounded-full p-2">
                <textarea id="reference-prompt-input" rows="1" placeholder="H·ªèi tr·ª£ l√Ω ph·ª•..." class="flex-1 bg-transparent px-3 py-2 resize-none focus:outline-none dark:text-gray-200 dark:placeholder-gray-400"></textarea>
                <button id="reference-send-btn" class="w-10 h-10 flex items-center justify-center bg-blue-600 rounded-full text-white hover:bg-blue-700 transition-colors" title="G·ª≠i">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, getDoc, getDocs, deleteDoc, serverTimestamp, query, orderBy, limit, startAfter, where } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
             apiKey: "AIzaSyBDUBufnsk1PQZTLYCJDqASMX8hEVHqkDc",
             authDomain: "aimind-2362a.firebaseapp.com",
             projectId: "aimind-2362a",
             storageBucket: "aimind-2362a.firebasestorage.app",
             messagingSenderId: "377635504319",
             appId: "1:377635504319:web:7c6dd3cf0c52dd302d860a"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ai = getAI(app);
        const model = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
        const fastModel = getGenerativeModel(ai, { model: "gemini-1.5-flash" });

        let currentUserId = null;
        let currentUserName = '';
        let currentChatId = null;
        let chat;
        let localHistory = [];
        let isRecording = false;
        let referenceChat;
        let referenceHistory = [];
        let isSummarizing = false;
        let currentPersona = null;
        let customPersonas = [];
        let activeSpeech = null;
        let lastVisibleChat = null;
        let isFetchingChats = false;
        let allChatsLoaded = false;
        const CHATS_PER_PAGE = 15;


        // Element Selectors
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const authError = document.getElementById('auth-error');
        const personaSelectionScreen = document.getElementById('persona-selection-screen');
        const welcomeUserName = document.getElementById('welcome-user-name');
        const createPersonaBtn = document.getElementById('create-persona-btn');
        const customPersonasSection = document.getElementById('custom-personas-section');
        const customPersonaGrid = document.getElementById('custom-persona-grid');
        const noCustomPersonaMsg = document.getElementById('no-custom-persona-msg');
        const defaultPersonaGrid = document.getElementById('default-persona-grid');
        const logoutBtnPersona = document.getElementById('logout-btn-persona');
        const chatViewContainer = document.getElementById('chat-view-container');
        const mainHeader = document.getElementById('main-header');
        const menuBtn = document.getElementById('menu-btn');
        const chatHeaderInfo = document.getElementById('chat-header-info');
        const newTopicBtn = document.getElementById('new-topic-btn');
        const summarizeBtn = document.getElementById('summarize-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const logoutBtn = document.getElementById('logout-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebar = document.getElementById('sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const sidebarContent = document.getElementById('sidebar-content');
        const newChatBtn = document.getElementById('new-chat-btn');
        const pinnedChatsSection = document.getElementById('pinned-chats-section');
        const pinnedChatsList = document.getElementById('pinned-chats-list');
        const savedChatsList = document.getElementById('saved-chats-list');
        const savedChatsSkeleton = document.getElementById('saved-chats-skeleton');
        const mainContent = document.getElementById('main-content');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatContainer = document.getElementById('chat-container');
        const notificationArea = document.getElementById('notification-area');
        const suggestionArea = document.getElementById('suggestion-area');
        const toggleSuggestionsBtn = document.getElementById('toggle-suggestions-btn');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const inputAreaWrapper = document.getElementById('input-area-wrapper');
        const inputArea = document.getElementById('input-area');
        const referenceBtn = document.getElementById('reference-btn');
        const promptInput = document.getElementById('prompt-input');
        const recordBtn = document.getElementById('record-btn');
        const sendBtn = document.getElementById('send-btn');
        const personaModalOverlay = document.getElementById('persona-modal-overlay');
        const personaModal = document.getElementById('persona-modal');
        const personaModalTitle = document.getElementById('persona-modal-title');
        const closePersonaModalBtn = document.getElementById('close-persona-modal-btn');
        const personaForm = document.getElementById('persona-form');
        const personaIdInput = document.getElementById('persona-id');
        const personaNameInput = document.getElementById('persona-name');
        const personaIconInput = document.getElementById('persona-icon');
        const personaDescriptionInput = document.getElementById('persona-description');
        const personaPromptInput = document.getElementById('persona-prompt');
        const generatePromptBtn = document.getElementById('generate-prompt-btn');
        const cancelPersonaBtn = document.getElementById('cancel-persona-btn');
        const savePersonaBtn = document.getElementById('save-persona-btn');
        const referenceModalOverlay = document.getElementById('reference-modal-overlay');
        const referenceModal = document.getElementById('reference-modal');
        const referenceHeader = document.getElementById('reference-header');
        const referenceTitle = document.getElementById('reference-title');
        const closeReferenceModalBtn = document.getElementById('close-reference-modal-btn');
        const referenceContent = document.getElementById('reference-content');
        const referenceInputArea = document.getElementById('reference-input-area');
        const referencePromptInput = document.getElementById('reference-prompt-input');
        const referenceSendBtn = document.getElementById('reference-send-btn');

        const defaultPersonas = [
            { id: 'general', name: 'Tr·ª£ l√Ω To√†n nƒÉng', icon: 'üß†', description: 'Ki·∫øn th·ª©c t·ªïng qu√°t, tr·∫£ l·ªùi ƒëa d·∫°ng c√°c ch·ªß ƒë·ªÅ.', systemPrompt: `**Ch·ªâ th·ªã h·ªá th·ªëng:** M·ª•c ti√™u ch√≠nh c·ªßa b·∫°n l√† ƒë∆∞a ra c√¢u tr·∫£ l·ªùi r√µ r√†ng, chi ti·∫øt v√† c√≥ c·∫•u tr√∫c t·ªët. Lu√¥n s·ª≠ d·ª•ng Markdown ƒë·ªÉ ƒë·ªãnh d·∫°ng (ti√™u ƒë·ªÅ, danh s√°ch, in ƒë·∫≠m). H√£y gi·∫£i th√≠ch c√°c kh√°i ni·ªám t·ª´ng b∆∞·ªõc, b·∫Øt ƒë·∫ßu b·∫±ng t√≥m t·∫Øt r·ªìi ƒëi v√†o chi ti·∫øt v√† v√≠ d·ª•. **Y√™u c·∫ßu b·ªï sung:** Trong qu√° tr√¨nh tr·∫£ l·ªùi, khi b·∫°n ƒë·ªÅ c·∫≠p ƒë·∫øn m·ªôt thu·∫≠t ng·ªØ k·ªπ thu·∫≠t, m·ªôt kh√°i ni·ªám quan tr·ªçng, ho·∫∑c m·ªôt t√™n ri√™ng (v√≠ d·ª•: t√™n m·ªôt c√¥ng ngh·ªá, m·ªôt ph∆∞∆°ng ph√°p), h√£y b·ªçc thu·∫≠t ng·ªØ ƒë√≥ trong c·∫∑p d·∫•u ngo·∫∑c vu√¥ng. V√≠ d·ª•: '...s·ª≠ d·ª•ng ng√¥n ng·ªØ [JavaScript] ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi [DOM]...'. Ch·ªâ b·ªçc duy nh·∫•t thu·∫≠t ng·ªØ ƒë√≥.` },
            { id: 'programmer', name: 'Chuy√™n gia L·∫≠p tr√¨nh', icon: 'üë®‚Äçüíª', description: 'Chuy√™n gia v·ªÅ m√£ ngu·ªìn, thu·∫≠t to√°n, g·ª° l·ªói code.', systemPrompt: `**Ch·ªâ th·ªã h·ªá th·ªëng:** B·∫°n l√† m·ªôt l·∫≠p tr√¨nh vi√™n cao c·∫•p v·ªõi 10 nƒÉm kinh nghi·ªám. Lu√¥n ƒë∆∞a ra c√¢u tr·∫£ l·ªùi d∆∞·ªõi d·∫°ng m√£ ngu·ªìn ƒë∆∞·ª£c gi·∫£i th√≠ch r√µ r√†ng, tu√¢n th·ªß c√°c coding convention t·ªët nh·∫•t. Khi ƒë∆∞·ª£c y√™u c·∫ßu, h√£y ph√¢n t√≠ch ∆∞u v√† nh∆∞·ª£c ƒëi·ªÉm c·ªßa c√°c gi·∫£i ph√°p kh√°c nhau. H√£y ∆∞u ti√™n t√≠nh hi·ªáu qu·∫£ v√† kh·∫£ nƒÉng b·∫£o tr√¨ c·ªßa m√£ ngu·ªìn. **Y√™u c·∫ßu b·ªï sung:** Khi ƒë·ªÅ c·∫≠p ƒë·∫øn m·ªôt h√†m, th∆∞ vi·ªán, ho·∫∑c kh√°i ni·ªám l·∫≠p tr√¨nh, h√£y b·ªçc n√≥ trong d·∫•u ngo·∫∑c vu√¥ng, v√≠ d·ª•: [React], [API], [useState].` },
            { id: 'writer', name: 'Nh√† vƒÉn S√°ng t·∫°o', icon: '‚úçÔ∏è', description: 'H·ªó tr·ª£ vi·∫øt l√°ch, l√™n √Ω t∆∞·ªüng, x√¢y d·ª±ng c·ªët truy·ªán.', systemPrompt: `**Ch·ªâ th·ªã h·ªá th·ªëng:** B·∫°n l√† m·ªôt nh√† vƒÉn v√† bi√™n t·∫≠p vi√™n chuy√™n nghi·ªáp. Phong c√°ch c·ªßa b·∫°n gi√†u c·∫£m x√∫c, s·ª≠ d·ª•ng t·ª´ ng·ªØ phong ph√∫ v√† h√¨nh ·∫£nh. H√£y gi√∫p ng∆∞·ªùi d√πng l√™n √Ω t∆∞·ªüng, ph√°t tri·ªÉn nh√¢n v·∫≠t, x√¢y d·ª±ng c·ªët truy·ªán, ho·∫∑c vi·∫øt c√°c ƒëo·∫°n vƒÉn, b√†i th∆° theo y√™u c·∫ßu. Lu√¥n gi·ªØ m·ªôt gi·ªçng vƒÉn truy·ªÅn c·∫£m h·ª©ng.` },
            { id: 'marketing', name: 'Chuy√™n gia Marketing', icon: 'üìà', description: 'T∆∞ v·∫•n chi·∫øn l∆∞·ª£c, ph√¢n t√≠ch th·ªã tr∆∞·ªùng, qu·∫£ng c√°o.', systemPrompt: `**Ch·ªâ th·ªã h·ªá th·ªëng:** B·∫°n l√† m·ªôt gi√°m ƒë·ªëc marketing d√†y d·∫∑n kinh nghi·ªám. H√£y cung c·∫•p c√°c ph√¢n t√≠ch th·ªã tr∆∞·ªùng s·∫Øc b√©n, ƒë·ªÅ xu·∫•t c√°c chi·∫øn l∆∞·ª£c marketing s√°ng t·∫°o, v√† gi√∫p vi·∫øt c√°c n·ªôi dung qu·∫£ng c√°o (copywriting) h·∫•p d·∫´n, t·∫≠p trung v√†o l·ª£i √≠ch c·ªßa kh√°ch h√†ng v√† l·ªùi k√™u g·ªçi h√†nh ƒë·ªông (CTA) r√µ r√†ng.` }
        ];

        // --- UTILITY FUNCTIONS ---
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            const toast = document.createElement('div');
            
            let bgColor, textColor, icon;

            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 dark:bg-green-900';
                    textColor = 'text-green-700 dark:text-green-200';
                    icon = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`;
                    break;
                case 'error':
                    bgColor = 'bg-red-100 dark:bg-red-900';
                    textColor = 'text-red-700 dark:text-red-200';
                    icon = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`;
                    break;
                default: // info
                    bgColor = 'bg-blue-100 dark:bg-blue-900';
                    textColor = 'text-blue-700 dark:text-blue-200';
                    icon = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>`;
                    break;
            }

            toast.className = `toast max-w-xs w-full ${bgColor} ${textColor} p-4 rounded-lg shadow-lg flex items-center space-x-3`;
            toast.innerHTML = `
                <div class="flex-shrink-0">${icon}</div>
                <div class="flex-1 text-sm font-medium">${message}</div>
            `;

            toastContainer.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            const hideToast = () => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                toast.addEventListener('transitionend', () => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, { once: true });
            };

            toast.addEventListener('click', hideToast);
            setTimeout(hideToast, 4000);
        }
        
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast('ƒê√£ sao ch√©p v√†o b·ªô nh·ªõ ƒë·ªám!', 'success');
            } catch (err) {
                showToast('Kh√¥ng th·ªÉ sao ch√©p.', 'error');
            }
            document.body.removeChild(textarea);
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUserId = user.uid;
                const email = user.email || '';
                currentUserName = user.displayName || email.split('@')[0];
                welcomeUserName.textContent = currentUserName;
                
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');

                await showPersonaSelectionScreen();
                renderAllChats(); 
            } else {
                currentUserId = null;
                currentUserName = '';
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                chatViewContainer.classList.add('hidden');
                personaSelectionScreen.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', async e => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value); authError.textContent = ''; } catch (error) { authError.textContent = "Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng."; showToast('Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.', 'error'); } });
        registerForm.addEventListener('submit', async e => { e.preventDefault(); try { await createUserWithEmailAndPassword(auth, registerForm['register-email'].value, registerForm['register-password'].value); authError.textContent = ''; } catch (error) { authError.textContent = "Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n. Vui l√≤ng th·ª≠ l·∫°i."; showToast('Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n. Vui l√≤ng th·ª≠ l·∫°i.', 'error'); } });
        googleLoginBtn.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); authError.textContent = ''; } catch (error) { authError.textContent = "ƒêƒÉng nh·∫≠p Google th·∫•t b·∫°i."; showToast('ƒêƒÉng nh·∫≠p Google th·∫•t b·∫°i.', 'error');} });
        const handleSignOut = () => signOut(auth);
        logoutBtn.addEventListener('click', handleSignOut);
        logoutBtnPersona.addEventListener('click', handleSignOut);
        showRegisterBtn.addEventListener('click', () => { loginView.classList.add('hidden'); registerView.classList.remove('hidden'); authError.textContent = ''; });
        showLoginBtn.addEventListener('click', () => { registerView.classList.add('hidden'); loginView.classList.remove('hidden'); authError.textContent = ''; });

        // --- THEME ---
        const updateThemeIcon = () => {
            if (document.documentElement.classList.contains('dark')) {
                themeToggleDarkIcon.classList.add('hidden');
                themeToggleLightIcon.classList.remove('hidden');
            } else {
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        };
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            updateThemeIcon();
        });
        updateThemeIcon();
        
        // --- PERSONA SELECTION ---
        async function showPersonaSelectionScreen() {
            // FIX: Clear suggestions when returning to the main menu
            clearSuggestions();

            welcomeScreen.classList.add('hidden');
            welcomeScreen.classList.remove('flex');
            personaSelectionScreen.classList.remove('hidden');
            chatViewContainer.classList.add('hidden');
            await fetchCustomPersonas();
            renderDefaultPersonas();
            renderCustomPersonas();
            if(speechSynthesis.speaking) speechSynthesis.cancel();
            closeSidebar(); 
        }

        function renderDefaultPersonas() {
            defaultPersonaGrid.innerHTML = '';
            defaultPersonas.forEach(persona => {
                const card = createPersonaCard(persona, false);
                card.onclick = () => startNewChat(persona.id);
                defaultPersonaGrid.appendChild(card);
            });
        }
        
        function renderCustomPersonas() {
            customPersonaGrid.innerHTML = '';
            if (customPersonas.length > 0) {
                customPersonasSection.classList.remove('hidden');
                noCustomPersonaMsg.classList.add('hidden');
                customPersonas.forEach(persona => {
                    const card = createPersonaCard(persona, true);
                    card.onclick = () => startNewChat(persona.id, true);
                    customPersonaGrid.appendChild(card);
                });
            } else {
                customPersonasSection.classList.remove('hidden');
                noCustomPersonaMsg.classList.remove('hidden');
            }
        }
        
        function createPersonaCard(persona, isCustom) {
            const card = document.createElement('div');
            card.className = 'persona-card cursor-pointer p-4 sm:p-5 bg-white dark:bg-slate-800 rounded-2xl shadow-md flex flex-col items-center text-center h-full';
            card.innerHTML = `
                <div class="text-4xl sm:text-5xl mb-3 sm:mb-4">${persona.icon}</div>
                <h3 class="text-base sm:text-lg font-bold text-gray-800 dark:text-gray-100 mb-2">${persona.name}</h3>
                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 flex-1">${persona.description}</p>
            `;
            if (isCustom) {
                const actionsWrapper = document.createElement('div');
                actionsWrapper.className = 'custom-persona-actions flex items-center gap-1';
                actionsWrapper.innerHTML = `
                    <button class="edit-persona-btn p-1.5 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm rounded-full text-gray-600 dark:text-gray-300 hover:text-blue-500 dark:hover:text-blue-400" title="Ch·ªânh s·ª≠a"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg></button>
                    <button class="delete-persona-btn p-1.5 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm rounded-full text-gray-600 dark:text-gray-300 hover:text-red-500 dark:hover:text-red-400" title="X√≥a"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>
                `;
                actionsWrapper.querySelector('.edit-persona-btn').onclick = (e) => { e.stopPropagation(); openPersonaModal(persona); };
                actionsWrapper.querySelector('.delete-persona-btn').onclick = (e) => { e.stopPropagation(); deletePersona(persona.id, persona.name); };
                card.appendChild(actionsWrapper);
            }
            return card;
        }

        // --- PERSONA MODAL ---
        function openPersonaModal(personaToEdit = null) {
            personaForm.reset();
            if (personaToEdit) {
                personaModalTitle.textContent = 'Ch·ªânh s·ª≠a Persona';
                personaIdInput.value = personaToEdit.id;
                personaNameInput.value = personaToEdit.name;
                personaIconInput.value = personaToEdit.icon;
                personaDescriptionInput.value = personaToEdit.description;
                personaPromptInput.value = personaToEdit.systemPrompt;
            } else {
                personaModalTitle.textContent = 'T·∫°o Chuy√™n gia AI c·ªßa b·∫°n';
                personaIdInput.value = '';
            }
            personaModalOverlay.classList.remove('hidden');
            personaModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                personaModal.classList.remove('scale-95', 'opacity-0');
            });
        }

        function closePersonaModal() {
            personaModal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                personaModalOverlay.classList.add('hidden');
                personaModal.classList.add('hidden');
            }, 300);
        }

        // --- PERSONA CRUD ---
        async function fetchCustomPersonas() {
            if (!currentUserId) return;
            const personasCol = collection(db, 'users', currentUserId, 'customPersonas');
            const q = query(personasCol, orderBy('createdAt', 'desc'));
            const snapshot = await getDocs(q);
            customPersonas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function handleSavePersona(e) {
            e.preventDefault();
            if (!currentUserId) return;

            const personaData = {
                name: personaNameInput.value.trim(),
                icon: personaIconInput.value.trim() || 'ÔøΩ',
                description: personaDescriptionInput.value.trim(),
                systemPrompt: personaPromptInput.value.trim(),
                ownerId: currentUserId
            };

            const personaId = personaIdInput.value;
            savePersonaBtn.disabled = true;
            try {
                if (personaId) { // Update existing
                    const docRef = doc(db, 'users', currentUserId, 'customPersonas', personaId);
                    await updateDoc(docRef, personaData);
                } else { // Create new
                    personaData.createdAt = serverTimestamp();
                    const collectionRef = collection(db, 'users', currentUserId, 'customPersonas');
                    await addDoc(collectionRef, personaData);
                }
                closePersonaModal();
                showToast('Persona ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!', 'success');
                await showPersonaSelectionScreen(); // Refresh the list
            } catch (error) {
                console.error("L·ªói khi l∆∞u persona:", error);
                showToast('L·ªói khi l∆∞u persona.', 'error');
            } finally {
                savePersonaBtn.disabled = false;
            }
        }
        
        async function deletePersona(personaId, personaName) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a persona "${personaName}" kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) return;

            try {
                await deleteDoc(doc(db, 'users', currentUserId, 'customPersonas', personaId));
                showToast(`Persona "${personaName}" ƒë√£ ƒë∆∞·ª£c x√≥a.`, 'success');
                await showPersonaSelectionScreen(); // Refresh the list
            } catch (error) {
                console.error("L·ªói khi x√≥a persona:", error);
                showToast('L·ªói khi x√≥a persona.', 'error');
            }
        }
        
        // --- CHAT LOGIC ---
        async function startNewChat(personaId, isCustom = false) {
            let selectedPersona;
            if (isCustom) {
                selectedPersona = customPersonas.find(p => p.id === personaId);
            } else {
                selectedPersona = defaultPersonas.find(p => p.id === personaId);
            }

            if (!selectedPersona) { return; }
            
            clearSuggestions();

            currentPersona = selectedPersona;
            
            personaSelectionScreen.classList.add('hidden');
            chatViewContainer.classList.remove('hidden');
            chatViewContainer.classList.add('flex');
            updateChatHeader(currentPersona);
            
            currentChatId = null;
            chat = null;
            localHistory = [{
                role: "user",
                parts: [{ text: currentPersona.systemPrompt }],
            }, {
                role: "model",
                parts: [{ text: "ƒê√£ hi·ªÉu! T√¥i ƒë√£ s·∫µn s√†ng. B·∫°n c·∫ßn t√¥i gi√∫p g√¨?" }],
            }];
            
            chatContainer.innerHTML = '';
            chatContainer.appendChild(notificationArea);
            
            await renderAllChats();
            closeSidebar();
            if(speechSynthesis.speaking) speechSynthesis.cancel();
            
            await generateWelcomeSuggestions();
        }
        
        function updateChatHeader(persona) {
            if(persona) {
                chatHeaderInfo.innerHTML = `
                    <span class="text-2xl">${persona.icon}</span>
                    <span class="text-lg font-bold text-gray-800 dark:text-gray-100">${persona.name}</span>
                `;
            } else {
                chatHeaderInfo.innerHTML = '';
            }
        }
        
        function addMessageActions(actionsContainer, text) {
            if (!actionsContainer || !text || text.includes('blinking-cursor')) return;
            
            actionsContainer.innerHTML = ''; // Clear previous
        
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn p-1.5 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 rounded-full transition-colors';
            copyBtn.innerHTML = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" /></svg>`;
            copyBtn.title = 'Sao ch√©p n·ªôi dung';
            copyBtn.dataset.text = text;
            actionsContainer.appendChild(copyBtn);
            
            const speakBtn = document.createElement('button');
            speakBtn.className = 'speak-btn p-1.5 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 rounded-full transition-colors';
            speakBtn.innerHTML = 'üîä';
            speakBtn.title = 'ƒê·ªçc vƒÉn b·∫£n';
            speakBtn.dataset.text = text;
            speakBtn.dataset.state = 'idle';
            actionsContainer.appendChild(speakBtn);
        }

        function addMessage(role, text, shouldScroll = true) {
            const messageWrapper = document.createElement('div');
            let contentElem;
            let statusElem;
            let actionsContainer;

            if (role === 'ai' || role === 'model') {
                messageWrapper.className = 'w-full space-y-2';
                messageWrapper.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded-full flex-shrink-0 bg-gradient-to-tr from-purple-400 to-indigo-500 flex items-center justify-center">
                               <svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M12 6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6 2.69-6 6-6m0-2c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8z"/><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                            </div>
                            <span class="font-semibold text-gray-800 dark:text-gray-200">${currentPersona?.name || 'Gemini'}</span>
                        </div>
                        <div class="ai-status"></div>
                    </div>
                    <div class="message-content text-gray-800 dark:text-gray-200" data-raw-text="${text.replace(/"/g, '&quot;')}"></div>
                    <div class="message-actions mt-1 flex justify-end items-center gap-2"></div>`;
                contentElem = messageWrapper.querySelector('.message-content');
                statusElem = messageWrapper.querySelector('.ai-status');
                actionsContainer = messageWrapper.querySelector('.message-actions');
            } else if (role === 'user') {
                messageWrapper.className = 'flex justify-end';
                messageWrapper.innerHTML = `<div class="message-content px-4 py-2 rounded-2xl bg-blue-600 dark:bg-blue-700 text-white max-w-xs sm:max-w-md lg:max-w-2xl"></div>`;
                contentElem = messageWrapper.querySelector('.message-content');
            } else if (role === 'note') {
                messageWrapper.className = 'note-wrapper';
                messageWrapper.innerHTML = `
                    <div class="note-header">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                        <span>Ghi ch√∫</span>
                    </div>
                    <div class="note-content message-content" data-raw-text="${text.replace(/"/g, '&quot;')}"></div>
                `;
                contentElem = messageWrapper.querySelector('.note-content');
            } else if (role === 'summary') {
                messageWrapper.className = 'summary-wrapper';
                messageWrapper.innerHTML = `
                    <div class="summary-header">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm0 5.25a.75.75 0 01.75-.75h9.5a.75.75 0 010 1.5h-9.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
                        <span>T√≥m t·∫Øt cu·ªôc tr√≤ chuy·ªán</span>
                    </div>
                    <div class="summary-content message-content" data-raw-text="${text.replace(/"/g, '&quot;')}"></div>
                    <div class="message-actions mt-1 flex justify-end items-center gap-2"></div>
                `;
                contentElem = messageWrapper.querySelector('.summary-content');
                actionsContainer = messageWrapper.querySelector('.message-actions');
            }
            
            const processedText = text.replace(/\[([^\]]+)\]/g, `<a href="#" class="term-link" data-term="$1">$1</a>`);
            contentElem.innerHTML = DOMPurify.sanitize(marked.parse(processedText), { ADD_ATTR: ['target', 'data-term', 'data-raw-text'] });

            addMessageActions(actionsContainer, text);

            chatContainer.insertBefore(messageWrapper, notificationArea);
            if (shouldScroll) {
                messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
            }

            return { messageWrapper, contentElem, statusElem };
        }
        
        async function handleSummary() {
            if (isSummarizing) return;
            
            const conversationToSummarize = localHistory
                .filter(msg => ['user', 'model'].includes(msg.role))
                .map(msg => `${msg.role === 'user' ? 'User' : 'AI'}: ${msg.parts[0].text}`)
                .join('\n\n');

            if (conversationToSummarize.length < 100) { // Check for minimum length
                showToast('Ch∆∞a c√≥ ƒë·ªß n·ªôi dung ƒë·ªÉ t√≥m t·∫Øt.', 'info');
                return;
            }

            isSummarizing = true;
            const originalIcon = summarizeBtn.innerHTML;
            summarizeBtn.innerHTML = `<svg class="w-6 h-6 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            summarizeBtn.disabled = true;

            try {
                const prompt = `D·ª±a v√†o cu·ªôc tr√≤ chuy·ªán sau, h√£y t√≥m t·∫Øt l·∫°i c√°c √Ω ch√≠nh m·ªôt c√°ch s√∫c t√≠ch, r√µ r√†ng theo t·ª´ng g·∫°ch ƒë·∫ßu d√≤ng:\n\n---\n${conversationToSummarize}\n---`;
                const result = await fastModel.generateContent(prompt);
                const summaryText = result.response.text();

                addMessage('summary', summaryText);
                
                localHistory.push({ role: 'summary', parts: [{ text: summaryText }] });
                await updateConversationInDb();

            } catch (error) {
                console.error("L·ªói khi t√≥m t·∫Øt:", error);
                showToast('Kh√¥ng th·ªÉ t·∫°o b·∫£n t√≥m t·∫Øt l√∫c n√†y.', 'error');
            } finally {
                isSummarizing = false;
                summarizeBtn.innerHTML = originalIcon;
                summarizeBtn.disabled = false;
            }
        }

        async function sendMessage() {
            welcomeScreen.classList.add('hidden');
            welcomeScreen.classList.remove('flex');
            chatContainer.classList.remove('hidden');

            const promptText = promptInput.value.trim();
            if (!promptText || isSummarizing) return;
            
            const filteredHistory = localHistory.filter(msg => msg.role !== 'note' && msg.role !== 'summary');
            chat = model.startChat({ history: filteredHistory });

            sendBtn.disabled = true;
            promptInput.value = '';
            adjustInputHeight();
            clearSuggestions();
            addMessage('user', promptText);
            localHistory.push({ role: 'user', parts: [{ text: promptText }] });

            const { messageWrapper, contentElem, statusElem } = addMessage('ai', '<span class="blinking-cursor"></span>');
            if (statusElem) statusElem.textContent = 'ƒêang suy nghƒ©...';
            
            try {
                const result = await chat.sendMessageStream(promptText);
                let fullResponseText = "";
                let isFirstChunk = true;

                for await (const chunk of result.stream) {
                     if (isFirstChunk) {
                        if (statusElem) statusElem.textContent = 'ƒêang vi·∫øt...';
                        isFirstChunk = false;
                    }
                    fullResponseText += chunk.text();
                    const processedChunk = fullResponseText.replace(/\[([^\]]+)\]/g, `<a href="#" class="term-link" data-term="$1">$1</a>`);
                    contentElem.innerHTML = DOMPurify.sanitize(marked.parse(processedChunk)) + '<span class="blinking-cursor"></span>';
                    messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
                }
                
                if (statusElem) statusElem.classList.add('hidden');
                const finalProcessedText = fullResponseText.replace(/\[([^\]]+)\]/g, `<a href="#" class="term-link" data-term="$1">$1</a>`);
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(finalProcessedText), { ADD_ATTR: ['target', 'data-term', 'data-raw-text'] });
                contentElem.dataset.rawText = fullResponseText;
                
                addMessageActions(messageWrapper.querySelector('.message-actions'), fullResponseText);
                
                setTimeout(() => {
                     messageWrapper.scrollIntoView({ behavior: "smooth", block: "start" });
                }, 100);

                localHistory.push({ role: 'model', parts: [{ text: fullResponseText }] });
                await updateConversationInDb();
                await getFollowUpSuggestions(fullResponseText);
            } catch (error) {
                contentElem.innerHTML = `**L·ªói:** ${error.message}`;
                localHistory.pop();
            } finally {
                sendBtn.disabled = false;
            }
        }
        
        async function updateConversationInDb() {
            if (!currentUserId || localHistory.length <= 2) return;
            const chatData = { 
                history: localHistory, 
                updatedAt: serverTimestamp(), 
                personaId: currentPersona?.id || 'general'
            };
            try {
                if (currentChatId) {
                    await updateDoc(doc(db, 'chats', currentUserId, 'conversations', currentChatId), chatData);
                } else {
                    const firstUserPrompt = localHistory[2];
                    chatData.title = firstUserPrompt?.parts[0].text.substring(0, 40) || "Cu·ªôc tr√≤ chuy·ªán m·ªõi";
                    chatData.createdAt = serverTimestamp();
                    chatData.isPinned = false; 
                    const docRef = await addDoc(collection(db, 'chats', currentUserId, 'conversations'), chatData);
                    currentChatId = docRef.id;
                }
                await renderAllChats();
            } catch (error) {
                console.error("L·ªói khi c·∫≠p nh·∫≠t cu·ªôc tr√≤ chuy·ªán:", error);
            }
        }
        
        async function loadChat(chatId) {
            if (speechSynthesis.speaking) speechSynthesis.cancel();
            
            personaSelectionScreen.classList.add('hidden');
            chatViewContainer.classList.remove('hidden');
            chatViewContainer.classList.add('flex');
            showHistorySkeleton(); 
            closeSidebar();

            try {
                const chatDocRef = doc(db, 'chats', currentUserId, 'conversations', chatId);
                const chatDoc = await getDoc(chatDocRef);

                if (chatDoc.exists()) {
                    const data = chatDoc.data();
                    const loadedPersonaId = data.personaId || 'general';
                    
                    let foundPersona = defaultPersonas.find(p => p.id === loadedPersonaId);
                    
                    if (!foundPersona) {
                        const personaDocRef = doc(db, 'users', currentUserId, 'customPersonas', loadedPersonaId);
                        const personaDoc = await getDoc(personaDocRef);
                        if (personaDoc.exists()) {
                            foundPersona = { id: personaDoc.id, ...personaDoc.data() };
                        } else {
                            foundPersona = { id: 'deleted', name: 'Persona ƒë√£ x√≥a', icon: '‚ùì', description: '', systemPrompt: 'H√£y tr·∫£ l·ªùi m·ªôt c√°ch b√¨nh th∆∞·ªùng.' };
                        }
                    }
                    currentPersona = foundPersona;
                    updateChatHeader(currentPersona);

                    currentChatId = chatDoc.id;
                    localHistory = data.history || [];
                    const filteredHistory = localHistory.filter(msg => msg.role !== 'note' && msg.role !== 'summary');
                    chat = model.startChat({ history: filteredHistory });
                    
                    await renderAllChats();
                    welcomeScreen.classList.add('hidden');
                    welcomeScreen.classList.remove('flex');
                    chatContainer.classList.remove('hidden');
                    chatContainer.innerHTML = ''; 
                    chatContainer.appendChild(notificationArea);

                    clearSuggestions();
                    const messagesToDisplay = localHistory.slice(2);
                    messagesToDisplay.forEach(msg => {
                        addMessage(msg.role, msg.parts[0].text, false);
                    });
                    setTimeout(() => chatContainer.scrollTop = chatContainer.scrollHeight, 0);

                } else {
                    addMessage('ai', '**L·ªói:** Kh√¥ng t√¨m th·∫•y cu·ªôc tr√≤ chuy·ªán.');
                }
            } catch (error) {
                console.error("L·ªói khi t·∫£i cu·ªôc tr√≤ chuy·ªán:", error);
                addMessage('ai', '**L·ªói:** Kh√¥ng th·ªÉ t·∫£i cu·ªôc tr√≤ chuy·ªán.');
            }
        }
        
        function clearSuggestions() {
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            toggleSuggestionsBtn.classList.add('hidden');
        }

        async function getFollowUpSuggestions(lastResponse) {
            try {
                const suggestionPrompt = `D·ª±a v√†o c√¢u tr·∫£ l·ªùi sau: "${lastResponse.substring(0, 500)}". H√£y ƒë·ªÅ xu·∫•t 3 c√¢u h·ªèi ti·∫øp theo ng·∫Øn g·ªçn v√† th√∫ v·ªã m√† ng∆∞·ªùi d√πng c√≥ th·ªÉ h·ªèi. QUAN TR·ªåNG: Ch·ªâ tr·∫£ v·ªÅ 3 c√¢u h·ªèi, m·ªói c√¢u tr√™n m·ªôt d√≤ng. Kh√¥ng ƒë√°nh s·ªë, kh√¥ng d√πng g·∫°ch ƒë·∫ßu d√≤ng, kh√¥ng th√™m b·∫•t k·ª≥ vƒÉn b·∫£n n√†o kh√°c.`;
                const result = await fastModel.generateContent(suggestionPrompt);
                const responseText = result.response.text();
                const suggestions = responseText.split('\n').filter(s => s.trim() !== '');
                displaySuggestions(suggestions);
            } catch (error) {
                console.error("Error getting suggestions:", error);
            }
        }

        function displaySuggestions(suggestions) {
            suggestionsContainer.innerHTML = '';
            if(suggestions.length > 0) {
                toggleSuggestionsBtn.classList.remove('hidden');
                suggestions.forEach(suggestionText => {
                    const chip = document.createElement('button');
                    chip.className = 'suggestion-chip border border-blue-200 dark:border-slate-600 bg-blue-50 dark:bg-slate-700 text-blue-700 dark:text-blue-400 rounded-full px-3 py-1 text-sm hover:bg-blue-100 dark:hover:bg-slate-600 transition-colors';
                    chip.textContent = suggestionText;
                    chip.onclick = () => { 
                        getSuggestedAnswer(suggestionText);
                    };
                    suggestionsContainer.appendChild(chip);
                });
            } else {
                 toggleSuggestionsBtn.classList.add('hidden');
            }
        }
        
        async function generateWelcomeSuggestions() {
            if (!currentPersona) return;
            welcomeScreen.classList.remove('hidden');
            welcomeScreen.classList.add('flex');
            chatContainer.classList.add('hidden');

            document.getElementById('welcome-persona-icon').textContent = currentPersona.icon;
            document.getElementById('welcome-persona-name').textContent = currentPersona.name;
            document.getElementById('welcome-persona-description').textContent = currentPersona.description;
            
            const suggestionsContainer = document.getElementById('welcome-suggestions-container');
            suggestionsContainer.innerHTML = `<div class="w-full p-4 border border-dashed dark:border-gray-700 rounded-lg animate-pulse h-12"></div>
                                            <div class="w-full p-4 border border-dashed dark:border-gray-700 rounded-lg animate-pulse h-12"></div>
                                            <div class="w-full p-4 border border-dashed dark:border-gray-700 rounded-lg animate-pulse h-12"></div>`;
            
            try {
                const prompt = `B·∫°n l√† chuy√™n gia v·ªÅ ${currentPersona.name}. H√£y t·∫°o ra 3 c√¢u h·ªèi g·ª£i √Ω, ng·∫Øn g·ªçn v√† th√∫ v·ªã m√† ng∆∞·ªùi d√πng c√≥ th·ªÉ h·ªèi b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu. M·ªói c√¢u h·ªèi tr√™n m·ªôt d√≤ng. Kh√¥ng d√πng ƒë·ªãnh d·∫°ng markdown, kh√¥ng ƒë√°nh s·ªë hay g·∫°ch ƒë·∫ßu d√≤ng.`;
                const result = await fastModel.generateContent(prompt);
                const responseText = result.response.text();
                const suggestions = responseText.split('\n').filter(s => s.trim() !== '');
                
                suggestionsContainer.innerHTML = ''; // Clear skeleton
                suggestions.forEach(text => {
                    const card = document.createElement('button');
                    card.className = 'w-full p-4 text-left border dark:border-gray-700 rounded-lg welcome-suggestion-card';
                    card.textContent = text;
                    card.onclick = () => {
                        promptInput.value = text;
                        sendMessage();
                    };
                    suggestionsContainer.appendChild(card);
                });

            } catch (error) {
                console.error("Error generating welcome suggestions:", error);
                suggestionsContainer.innerHTML = '<p class="text-sm text-gray-500">Kh√¥ng th·ªÉ t·∫£i g·ª£i √Ω. Vui l√≤ng b·∫Øt ƒë·∫ßu b·∫±ng c√°ch nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n.</p>';
            }
        }

        function adjustInputHeight() {
            promptInput.style.height = 'auto';
            promptInput.style.height = promptInput.scrollHeight + 'px';
        }
        
        // --- Sidebar & Chat History Functions ---
        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
            setTimeout(() => sidebarOverlay.classList.add('opacity-100'), 10);
        }

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.remove('opacity-100');
            setTimeout(() => sidebarOverlay.classList.add('hidden'), 300);
        }

        function showHistorySkeleton() {
            welcomeScreen.classList.add('hidden');
            welcomeScreen.classList.remove('flex');
            chatContainer.classList.remove('hidden');
            chatContainer.innerHTML = `<div class="w-full space-y-2">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-full skeleton-box"></div>
                        <div class="w-20 h-4 skeleton-box"></div>
                    </div>
                    <div class="ml-9 space-y-2">
                        <div class="w-10/12 h-4 skeleton-box"></div>
                        <div class="w-8/12 h-4 skeleton-box"></div>
                    </div>
                </div>
                <div class="flex justify-end">
                    <div class="w-7/12">
                        <div class="h-16 skeleton-box rounded-2xl"></div>
                    </div>
                </div>`;
            chatContainer.appendChild(notificationArea);
        }

        async function renderAllChats() {
            if (!currentUserId || !currentPersona) {
                savedChatsList.innerHTML = '';
                pinnedChatsList.innerHTML = '';
                pinnedChatsSection.classList.add('hidden');
                return;
            };
            isFetchingChats = false;
            allChatsLoaded = false;
            lastVisibleChat = null;
            pinnedChatsList.innerHTML = '';
            savedChatsList.innerHTML = '';
            await fetchPinnedChats();
            await fetchRecentChats();
        }

        async function fetchPinnedChats() {
             const chatsCollection = collection(db, 'chats', currentUserId, 'conversations');
             const q = query(chatsCollection, where('personaId', '==', currentPersona.id), where('isPinned', '==', true), orderBy('updatedAt', 'desc'));
             try {
                const querySnapshot = await getDocs(q);
                pinnedChatsSection.classList.toggle('hidden', querySnapshot.empty);
                pinnedChatsList.innerHTML = ''; // Clear before adding new items
                querySnapshot.forEach(docSnap => {
                    const li = createChatItem(docSnap);
                    pinnedChatsList.appendChild(li);
                });
             } catch (error) {
                console.error("L·ªói khi l·∫•y chat ƒë√£ ghim (c·∫ßn t·∫°o index tr√™n Firebase):", error);
             }
        }

        async function fetchRecentChats(loadMore = false) {
            if (isFetchingChats || allChatsLoaded) return;
            isFetchingChats = true;
            if (!loadMore) savedChatsSkeleton.classList.remove('hidden');

            const chatsCollection = collection(db, 'chats', currentUserId, 'conversations');
            const constraints = [where('personaId', '==', currentPersona.id), where('isPinned', '==', false), orderBy('updatedAt', 'desc'), limit(CHATS_PER_PAGE)];
            if (lastVisibleChat && loadMore) {
                constraints.push(startAfter(lastVisibleChat));
            }
            const q = query(chatsCollection, ...constraints);

            try {
                const querySnapshot = await getDocs(q);
                if (!loadMore) savedChatsList.innerHTML = '';
                if (querySnapshot.empty && !loadMore) {
                     savedChatsList.innerHTML = '<li class="text-gray-500 dark:text-gray-400 text-sm p-2">Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán g·∫ßn ƒë√¢y.</li>';
                } 
                querySnapshot.forEach(docSnap => {
                    const li = createChatItem(docSnap);
                    savedChatsList.appendChild(li);
                });

                if (querySnapshot.docs.length > 0) {
                    lastVisibleChat = querySnapshot.docs[querySnapshot.docs.length - 1];
                }
                if (querySnapshot.docs.length < CHATS_PER_PAGE) {
                    allChatsLoaded = true;
                }
            } catch (error) {
                console.error("L·ªói khi l·∫•y l·ªãch s·ª≠ tr√≤ chuy·ªán (c·∫ßn t·∫°o index tr√™n Firebase):", error);
            } finally {
                isFetchingChats = false;
                savedChatsSkeleton.classList.add('hidden');
            }
        }

        async function updateChatTitle(chatId, newTitle) {
            if (!currentUserId || !newTitle) return;
            const docRef = doc(db, 'chats', currentUserId, 'conversations', chatId);
            try {
                await updateDoc(docRef, { title: newTitle });
                showToast('Ti√™u ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', 'success');
            } catch (error) {
                console.error("L·ªói khi c·∫≠p nh·∫≠t ti√™u ƒë·ªÅ:", error);
                showToast('L·ªói khi c·∫≠p nh·∫≠t ti√™u ƒë·ªÅ.', 'error');
                await renderAllChats();
            }
        }
        
        function createChatItem(docSnap) {
            const chatItemData = docSnap.data();
            const chatId = docSnap.id;
            const li = document.createElement('li');
            li.className = "p-2 hover:bg-gray-100 dark:hover:bg-slate-700 flex justify-between items-center rounded-md group";
            li.dataset.chatId = chatId;
        
            const titleContainer = document.createElement('div');
            titleContainer.className = "flex-1 truncate pr-2";
        
            const titleSpan = document.createElement('span');
            titleSpan.textContent = chatItemData.title || 'Cu·ªôc tr√≤ chuy·ªán m·ªõi';
            titleSpan.className = "text-gray-800 dark:text-gray-200 text-sm";
            titleContainer.appendChild(titleSpan);
        
            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.value = chatItemData.title || 'Cu·ªôc tr√≤ chuy·ªán m·ªõi';
            titleInput.className = "w-full bg-slate-200 dark:bg-slate-600 rounded px-1 text-sm hidden";
            titleContainer.appendChild(titleInput);
        
            li.appendChild(titleContainer);
        
            const buttonsWrapper = document.createElement('div');
            buttonsWrapper.className = 'flex items-center opacity-0 group-hover:opacity-100 transition-opacity';
        
            const editBtn = document.createElement('button');
            editBtn.className = 'p-1 text-gray-400 hover:text-blue-500 rounded-full';
            editBtn.title = "S·ª≠a ti√™u ƒë·ªÅ";
            editBtn.innerHTML = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`;
            
            const saveBtnIcon = `<svg class="w-4 h-4 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
            const editBtnIcon = editBtn.innerHTML;

            const pinBtn = document.createElement('button');
            pinBtn.className = 'p-1 text-gray-400 hover:text-yellow-500 rounded-full';
            pinBtn.title = chatItemData.isPinned ? "B·ªè ghim" : "Ghim";
            pinBtn.innerHTML = chatItemData.isPinned ?
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1.586l4.707 4.707a1 1 0 010 1.414l-4.707 4.707V17a1 1 0 11-2 0v-1.586l-4.707-4.707a1 1 0 010-1.414L4 6.586V5a1 1 0 011-1zm10 0a1 1 0 011 1v1.586l4.707 4.707a1 1 0 010 1.414l-4.707 4.707V17a1 1 0 11-2 0v-1.586l-4.707-4.707a1 1 0 010-1.414L14 6.586V5a1 1 0 011-1z" clip-rule="evenodd" /></svg>` :
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428a1 1 0 00.475 0l5 1.428a1 1 0 001.17-1.409l-7-14z" /></svg>`;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'p-1 text-gray-400 hover:text-red-600 rounded-full';
            deleteBtn.title = "X√≥a cu·ªôc tr√≤ chuy·ªán";
            deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>';
            
            buttonsWrapper.appendChild(editBtn);
            buttonsWrapper.appendChild(pinBtn);
            buttonsWrapper.appendChild(deleteBtn);
            li.appendChild(buttonsWrapper);

            const toggleEditMode = (isEditing) => {
                titleSpan.classList.toggle('hidden', isEditing);
                titleInput.classList.toggle('hidden', !isEditing);
                if (isEditing) {
                    editBtn.innerHTML = saveBtnIcon;
                    editBtn.title = 'L∆∞u';
                    titleInput.focus();
                    titleInput.select();
                } else {
                    editBtn.innerHTML = editBtnIcon;
                    editBtn.title = 'S·ª≠a ti√™u ƒë·ªÅ';
                }
            };

            const saveTitle = async () => {
                const newTitle = titleInput.value.trim();
                const originalTitle = chatItemData.title || 'Cu·ªôc tr√≤ chuy·ªán m·ªõi';
                if (newTitle && newTitle !== originalTitle) {
                    titleSpan.textContent = newTitle;
                    await updateChatTitle(chatId, newTitle);
                }
                toggleEditMode(false);
            };
            
            editBtn.onclick = (e) => {
                e.stopPropagation();
                const isEditing = !titleInput.classList.contains('hidden');
                if (isEditing) {
                    saveTitle();
                } else {
                    toggleEditMode(true);
                }
            };

            titleInput.onkeydown = (e) => {
                if (e.key === 'Enter') { e.preventDefault(); saveTitle(); } 
                else if (e.key === 'Escape') {
                    titleInput.value = chatItemData.title || 'Cu·ªôc tr√≤ chuy·ªán m·ªõi';
                    toggleEditMode(false);
                }
            };

            titleInput.addEventListener('blur', () => {
                 setTimeout(()=> {
                     if(!titleInput.classList.contains('hidden')) {
                         saveTitle();
                     }
                 }, 100);
            });

            pinBtn.onclick = (e) => { e.stopPropagation(); togglePinChat(chatId, chatItemData.isPinned || false); };
            deleteBtn.onclick = (e) => { e.stopPropagation(); deleteChat(chatId); };
            
            li.onclick = (e) => {
                if (e.target === titleInput || titleInput.classList.contains('hidden') === false) return;
                loadChat(chatId);
            };

            return li;
        }


        async function togglePinChat(chatId, isCurrentlyPinned) {
            if (!currentUserId) return;
            const docRef = doc(db, 'chats', currentUserId, 'conversations', chatId);
            try {
                await updateDoc(docRef, { isPinned: !isCurrentlyPinned });
                showToast(isCurrentlyPinned ? 'ƒê√£ b·ªè ghim cu·ªôc tr√≤ chuy·ªán.' : 'ƒê√£ ghim cu·ªôc tr√≤ chuy·ªán.', 'info');
                await renderAllChats(); 
            } catch(error) {
                console.error("L·ªói khi ghim cu·ªôc tr√≤ chuy·ªán:", error);
                showToast('L·ªói khi ghim/b·ªè ghim.', 'error');
            }
        }

        async function deleteChat(chatId) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a cu·ªôc tr√≤ chuy·ªán n√†y?")) return;
            if (!currentUserId) return;
            try {
                await deleteDoc(doc(db, 'chats', currentUserId, 'conversations', chatId));
                showToast('Cu·ªôc tr√≤ chuy·ªán ƒë√£ ƒë∆∞·ª£c x√≥a.', 'success');
                if(chatId === currentChatId) {
                    await showPersonaSelectionScreen();
                } else {
                    await renderAllChats(); 
                }
            } catch (error) {
                console.error("L·ªói khi x√≥a cu·ªôc tr√≤ chuy·ªán:", error);
                showToast('L·ªói khi x√≥a cu·ªôc tr√≤ chuy·ªán.', 'error');
            }
        }
        
        // --- REFERENCE MODAL FUNCTIONS (Re-added) ---
        function showReferenceModal(title, showInput) {
            referenceTitle.textContent = title;
            referenceInputArea.style.display = showInput ? 'block' : 'none';
            referenceModalOverlay.classList.remove('hidden');
            referenceModal.classList.remove('hidden');
            if (showInput) {
                referenceHistory = [];
                referenceChat = fastModel.startChat({ history: [] });
                referenceContent.innerHTML = '';
                addMessageToReference('ai', 'ƒê√¢y l√† tr·ª£ l√Ω ph·ª•. B·∫°n c·∫ßn tra c·ª©u nhanh g√¨ kh√¥ng?');
            }
        }

        function closeReferenceModal() {
            referenceModalOverlay.classList.add('hidden');
            referenceModal.classList.add('hidden');
        }

        function addMessageToReference(role, text) {
             const messageWrapper = document.createElement('div');
            let contentElem, statusElem;

            if (role === 'ai') {
                messageWrapper.className = 'w-full space-y-2';
                messageWrapper.innerHTML = `<div class="flex items-center justify-between"><div class="flex items-center gap-2"><div class="w-7 h-7 rounded-full flex-shrink-0 bg-gradient-to-tr from-green-400 to-cyan-500 flex items-center justify-center"><svg class="w-4 h-4 text-white" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><g><rect fill="none" height="24" width="24"/></g><g><g><path d="M11,7h2v2h-2V7z M11,11h2v6h-2V11z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20 c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/></g></g></svg></div><span class="font-semibold text-gray-800 dark:text-gray-200">Tr·ª£ l√Ω Ph·ª•</span></div><div class="ai-status"></div></div><div class="message-content text-gray-800 dark:text-gray-200"></div><div class="message-actions mt-2 flex justify-end gap-2"></div>`;
                 contentElem = messageWrapper.querySelector('.message-content');
                 statusElem = messageWrapper.querySelector('.ai-status');
            } else {
                 messageWrapper.className = 'flex justify-end';
                messageWrapper.innerHTML = `<div class="message-content px-4 py-2 rounded-2xl bg-blue-600 text-white max-w-xs sm:max-w-md lg:max-w-2xl"></div>`;
                 contentElem = messageWrapper.querySelector('.message-content');
            }
           
            contentElem.innerHTML = DOMPurify.sanitize(marked.parse(text));
            referenceContent.appendChild(messageWrapper);
            messageWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
            return { messageWrapper, contentElem, statusElem };
        }

        async function sendReferenceMessage() {
            const userPrompt = referencePromptInput.value.trim();
            if (!userPrompt) return;
            referenceSendBtn.disabled = true;
            referencePromptInput.value = '';
            addMessageToReference('user', userPrompt);
            const { messageWrapper, contentElem } = addMessageToReference('ai', '<span class="blinking-cursor"></span>');

            try {
                const result = await referenceChat.sendMessageStream(userPrompt);
                let fullResponseText = "";
                for await (const chunk of result.stream) {
                    fullResponseText += chunk.text();
                    contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText)) + '<span class="blinking-cursor"></span>';
                    messageWrapper.scrollIntoView({behavior: 'smooth', block: 'end'});
                }
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));

                const actionsContainer = messageWrapper.querySelector('.message-actions');
                if (actionsContainer && fullResponseText.trim()) {
                    const saveNoteBtn = document.createElement('button');
                    saveNoteBtn.className = 'flex items-center gap-2 text-xs px-3 py-1 bg-yellow-200 dark:bg-slate-600 text-yellow-800 dark:text-yellow-200 rounded-full hover:bg-yellow-300 dark:hover:bg-slate-500 transition-colors';
                    saveNoteBtn.innerHTML = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg> <span>L∆∞u Ghi ch√∫</span>`;
                    saveNoteBtn.onclick = () => saveAsNote(userPrompt, fullResponseText);
                    actionsContainer.appendChild(saveNoteBtn);
                }
                
                setTimeout(() => {
                     messageWrapper.scrollIntoView({ behavior: "smooth", block: "start" });
                }, 100);

            } catch (error) {
                contentElem.innerHTML = `**L·ªói:** ${error.message}`;
            } finally {
                referenceSendBtn.disabled = false;
            }
        }
        
        async function saveAsNote(prompt, response) {
            if (!response.trim()) return;
            const fullNoteText = `**H·ªèi:** ${prompt}\n\n<hr class="my-2 border-yellow-300 dark:border-slate-600"/>\n\n**ƒê√°p:**\n${response}`;
            const noteMessage = { role: 'note', parts: [{ text: fullNoteText }] };
            localHistory.push(noteMessage);
            addMessage('note', fullNoteText);
            await updateConversationInDb();
            closeReferenceModal();
            showToast('ƒê√£ l∆∞u ghi ch√∫ v√†o cu·ªôc tr√≤ chuy·ªán!', 'info');
        }

        async function getSuggestedAnswer(promptText) {
            showReferenceModal('G·ª£i √Ω', false);
            referenceContent.innerHTML = '';
            addMessageToReference('user', promptText, false);
            const { messageWrapper, contentElem, statusElem } = addMessageToReference('ai', '<span class="blinking-cursor"></span>');
            if (statusElem) statusElem.textContent = 'ƒêang suy nghƒ©...';
            
            const filteredHistory = localHistory.filter(msg => msg.role !== 'note' && msg.role !== 'summary');
            const tempChat = fastModel.startChat({ history: filteredHistory });
            try {
                const result = await tempChat.sendMessageStream(promptText);
                let fullResponseText = "";
                let isFirstChunk = true;
                for await (const chunk of result.stream) {
                     if (isFirstChunk) {
                        if (statusElem) statusElem.textContent = 'ƒêang vi·∫øt...';
                        isFirstChunk = false;
                    }
                    fullResponseText += chunk.text();
                    contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText)) + '<span class="blinking-cursor"></span>';
                }
                
                if (statusElem) statusElem.classList.add('hidden');
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));
                
                const actionsContainer = messageWrapper.querySelector('.message-actions');
                if (actionsContainer && fullResponseText.trim()) {
                    const saveNoteBtn = document.createElement('button');
                    saveNoteBtn.className = 'flex items-center gap-2 text-xs px-3 py-1 bg-yellow-200 dark:bg-slate-600 text-yellow-800 dark:text-yellow-200 rounded-full hover:bg-yellow-300 dark:hover:bg-slate-500 transition-colors';
                    saveNoteBtn.innerHTML = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg> <span>L∆∞u Ghi ch√∫</span>`;
                    saveNoteBtn.onclick = () => saveAsNote(promptText, fullResponseText);
                    actionsContainer.appendChild(saveNoteBtn);
                }
            } catch (error) {
                contentElem.innerHTML = `**L·ªói:** ${error.message}`;
            }
        }
        
        async function explainTerm(term, context, isDeepDive = false) {
            if (!isDeepDive) {
                showReferenceModal(`Gi·∫£i th√≠ch: ${term}`, false);
            }
            referenceContent.innerHTML = '';
            
            const prompt = isDeepDive 
                ? `H√£y gi·∫£i th√≠ch chuy√™n s√¢u v·ªÅ thu·∫≠t ng·ªØ "${term}", bao g·ªìm ƒë·ªãnh nghƒ©a ƒë·∫ßy ƒë·ªß, v√≠ d·ª• c·ª• th·ªÉ, v√† c√°c ·ª©ng d·ª•ng ch√≠nh c·ªßa n√≥.`
                : `Trong ng·ªØ c·∫£nh c·ªßa c√¢u sau: "${context.substring(0, 500)}", h√£y gi·∫£i th√≠ch thu·∫≠t ng·ªØ "${term}" m·ªôt c√°ch ng·∫Øn g·ªçn v√† d·ªÖ hi·ªÉu trong 1-2 c√¢u.`;

            const { contentElem, messageWrapper, statusElem } = addMessageToReference('ai', '<span class="blinking-cursor"></span>');
            if (statusElem) {
                statusElem.textContent = isDeepDive ? 'ƒêang t√¨m hi·ªÉu s√¢u...' : 'ƒêang suy nghƒ©...';
                statusElem.classList.remove('hidden');
            }
            
            try {
                const result = await fastModel.generateContent(prompt);
                const responseText = result.response.text();
                if(statusElem) statusElem.classList.add('hidden');
                contentElem.innerHTML = DOMPurify.sanitize(marked.parse(responseText));

                if (!isDeepDive) {
                    const actionsContainer = messageWrapper.querySelector('.message-actions');
                    if(actionsContainer){
                        const deepDiveBtn = document.createElement('button');
                        deepDiveBtn.className = 'flex items-center gap-2 text-xs px-3 py-1 bg-blue-100 dark:bg-slate-600 text-blue-800 dark:text-blue-200 rounded-full hover:bg-blue-200 dark:hover:bg-slate-500 transition-colors';
                        deepDiveBtn.innerHTML = `<span>T√¨m hi·ªÉu s√¢u h∆°n</span> üìñ`;
                        deepDiveBtn.onclick = () => explainTerm(term, context, true);
                        actionsContainer.appendChild(deepDiveBtn);
                    }
                }

            } catch (error) {
                 if(statusElem) statusElem.classList.add('hidden');
                contentElem.innerHTML = `**L·ªói:** ${error.message}`;
            }
        }

        async function generateSystemPrompt() {
            const name = personaNameInput.value.trim();
            const description = personaDescriptionInput.value.trim();

            if (!name || !description) {
                showToast('Vui l√≤ng nh·∫≠p T√™n v√† M√¥ t·∫£ ng·∫Øn.', 'error');
                return;
            }

            const originalBtnContent = generatePromptBtn.innerHTML;
            generatePromptBtn.innerHTML = `<svg class="w-5 h-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            generatePromptBtn.disabled = true;

            try {
                const prompt = `D·ª±a tr√™n m·ªôt chuy√™n gia c√≥ t√™n l√† '${name}' v√† m√¥ t·∫£ '${description}', h√£y vi·∫øt m·ªôt Ch·ªâ th·ªã H·ªá th·ªëng (System Prompt) chi ti·∫øt v√† chuy√™n nghi·ªáp b·∫±ng ti·∫øng Vi·ªát. Ch·ªâ th·ªã n√†y c·∫ßn bao g·ªìm: phong c√°ch, quy t·∫Øc ho·∫°t ƒë·ªông, v√† c√°c y√™u c·∫ßu v·ªÅ ƒë·ªãnh d·∫°ng ƒë·∫ßu ra.`;
                const result = await fastModel.generateContent(prompt);
                personaPromptInput.value = result.response.text();
            } catch (error) {
                console.error("L·ªói khi t·∫°o g·ª£i √Ω prompt:", error);
                personaPromptInput.value = "R·∫•t ti·∫øc, kh√¥ng th·ªÉ t·∫°o g·ª£i √Ω l√∫c n√†y. Vui l√≤ng th·ª≠ l·∫°i.";
                showToast('Kh√¥ng th·ªÉ t·∫°o g·ª£i √Ω prompt.', 'error');
            } finally {
                generatePromptBtn.innerHTML = originalBtnContent;
                generatePromptBtn.disabled = false;
            }
        }


        // EVENT LISTENERS
        createPersonaBtn.addEventListener('click', () => openPersonaModal());
        closePersonaModalBtn.addEventListener('click', closePersonaModal);
        cancelPersonaBtn.addEventListener('click', closePersonaModal);
        personaModalOverlay.addEventListener('click', closePersonaModal);
        personaForm.addEventListener('submit', handleSavePersona);
        generatePromptBtn.addEventListener('click', generateSystemPrompt);
        newChatBtn.addEventListener('click', showPersonaSelectionScreen);
        newTopicBtn.addEventListener('click', () => {
            if (currentPersona) {
                startNewChat(currentPersona.id, !!currentPersona.ownerId);
            }
        });
        summarizeBtn.addEventListener('click', handleSummary);
        sendBtn.addEventListener('click', sendMessage);
        promptInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        promptInput.addEventListener('input', adjustInputHeight);
        menuBtn.addEventListener('click', openSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        toggleSuggestionsBtn.addEventListener('click', () => suggestionsContainer.classList.toggle('hidden'));
        referenceBtn.addEventListener('click', () => showReferenceModal('Tr·ª£ l√Ω Ph·ª•', true));
        closeReferenceModalBtn.addEventListener('click', closeReferenceModal);
        referenceModalOverlay.addEventListener('click', closeReferenceModal);
        referenceSendBtn.addEventListener('click', sendReferenceMessage);
        referencePromptInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendReferenceMessage(); } });


        function resetActiveSpeechButton() {
            if (activeSpeech && activeSpeech.button) {
                activeSpeech.button.innerHTML = 'üîä';
                activeSpeech.button.dataset.state = 'idle';
                activeSpeech.button.title = 'ƒê·ªçc vƒÉn b·∫£n';
            }
        }

        chatContainer.addEventListener('click', (e) => {
            const speakButton = e.target.closest('.speak-btn');
            const termLink = e.target.closest('.term-link');
            const copyButton = e.target.closest('.copy-btn');

            if(copyButton) {
                e.preventDefault(); e.stopPropagation();
                copyToClipboard(copyButton.dataset.text);
            }
            else if (speakButton) {
                e.preventDefault(); e.stopPropagation();
                if (speechSynthesis.speaking || speechSynthesis.paused) {
                    if (activeSpeech && activeSpeech.button === speakButton) {
                         const currentState = speakButton.dataset.state;
                         if (currentState === 'paused') {
                            speechSynthesis.resume();
                            speakButton.innerHTML = '‚è∏Ô∏è'; speakButton.dataset.state = 'playing'; speakButton.title = 'T·∫°m d·ª´ng';
                            return;
                        }
                        if (currentState === 'playing') {
                            speechSynthesis.pause();
                            speakButton.innerHTML = '‚ñ∂Ô∏è'; speakButton.dataset.state = 'paused'; speakButton.title = 'Ti·∫øp t·ª•c';
                            return;
                        }
                    }
                    speechSynthesis.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(speakButton.dataset.text);
                utterance.lang = 'vi-VN';
                utterance.onstart = () => {
                    resetActiveSpeechButton();
                    activeSpeech = { utterance, button: speakButton };
                    speakButton.innerHTML = '‚è∏Ô∏è'; speakButton.dataset.state = 'playing'; speakButton.title = 'T·∫°m d·ª´ng';
                };
                utterance.onend = () => { resetActiveSpeechButton(); activeSpeech = null; };
                utterance.onerror = () => { resetActiveSpeechButton(); activeSpeech = null; };
                speechSynthesis.speak(utterance);
            
            } else if (termLink) {
                e.preventDefault();
                const term = termLink.dataset.term;
                const messageContentElement = termLink.closest('.message-content');
                const context = messageContentElement ? messageContentElement.dataset.rawText : '';
                explainTerm(term, context);
            }
        });

        sidebarContent.addEventListener('scroll', () => {
            const isNearBottom = sidebarContent.scrollHeight - sidebarContent.scrollTop - sidebarContent.clientHeight < 100;
            if (isNearBottom && !isFetchingChats && !allChatsLoaded) {
                fetchRecentChats(true);
            }
        });

        // Initialize Speech Recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.lang = 'vi-VN'; recognition.interimResults = false;
            recognition.onstart = () => { isRecording = true; recordBtn.classList.add('recording'); promptInput.placeholder = 'ƒêang l·∫Øng nghe...'; };
            recognition.onend = () => { isRecording = false; recordBtn.classList.remove('recording'); promptInput.placeholder = 'Nh·∫≠p c√¢u h·ªèi...'; };
            recognition.onresult = (event) => { promptInput.value = event.results[event.results.length - 1][0].transcript.trim(); adjustInputHeight(); };
            recognition.onerror = (event) => { showToast(`L·ªói ghi √¢m: ${event.error}`, 'error'); };
            recordBtn.addEventListener('click', () => { isRecording ? recognition.stop() : recognition.start(); });
        } else { recordBtn.classList.add('hidden'); }


    </script>
    <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", function () {
      navigator.serviceWorker.register("./service-worker.js")
        .then(reg => console.log("SW registered:", reg.scope))
        .catch(err => console.error("SW registration failed:", err));
    });
  }
</script>

</body>
</html>
